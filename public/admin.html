<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoFi</title>
    <!-- Try Local Chart.js only - Removed CDN fallback to prevent offline blocking -->
    <script src="/js/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Optional: Add simple placeholder if Chart is missing
        if (typeof Chart === 'undefined') {
             console.warn('Chart.js not found locally. Charts will be disabled.');
        }



        // --- Rates Management ---
        async function loadRatesData() {
            try {
                const res = await fetch('/api/admin/rates');
                const rates = await res.json();
                const tbody = document.querySelector('#rates-table tbody');
                tbody.innerHTML = '';
                
                rates.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>â‚±${r.amount}</td>
                        <td>${r.minutes} m</td>
                        <td>
                            <div style="font-size:0.8rem;">UL: ${(r.upload_speed/1024).toFixed(1)} Mbps</div>
                            <div style="font-size:0.8rem;">DL: ${(r.download_speed/1024).toFixed(1)} Mbps</div>
                        </td>
                        <td>${r.is_pausable ? '<span class="badge badge-success">Pausable</span>' : '<span class="badge">One-time</span>'}</td>
                        <td>
                            <button class="btn btn-sm" onclick='openRateModal(${JSON.stringify(r)})' style="background:#f39c12; color:white;">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRate(${r.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Rates load error", e);
            }
        }

        function openRateModal(rate = null) {
            const modal = document.getElementById('rate-modal');
            const idInput = document.getElementById('rate-id');
            const amountInput = document.getElementById('rate-amount');
            const minutesInput = document.getElementById('rate-minutes');
            const ulInput = document.getElementById('rate-ul');
            const dlInput = document.getElementById('rate-dl');
            const pausableInput = document.getElementById('rate-pausable');
            
            if (rate) {
                idInput.value = rate.id;
                amountInput.value = rate.amount;
                minutesInput.value = rate.minutes;
                ulInput.value = rate.upload_speed;
                dlInput.value = rate.download_speed;
                pausableInput.checked = !!rate.is_pausable;
            } else {
                idInput.value = '';
                amountInput.value = '';
                minutesInput.value = '';
                ulInput.value = 5120;
                dlInput.value = 5120;
                pausableInput.checked = true;
            }
            modal.style.display = 'flex';
        }

        async function saveRate() {
            const rate = {
                id: document.getElementById('rate-id').value || null,
                amount: parseInt(document.getElementById('rate-amount').value),
                minutes: parseInt(document.getElementById('rate-minutes').value),
                upload_speed: parseInt(document.getElementById('rate-ul').value),
                download_speed: parseInt(document.getElementById('rate-dl').value),
                is_pausable: document.getElementById('rate-pausable').checked ? 1 : 0
            };
            
            if (!rate.amount || !rate.minutes) return alert('Amount and Minutes are required');
            
            await fetch('/api/admin/rates', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(rate)
            });
            
            document.getElementById('rate-modal').style.display = 'none';
            loadRatesData();
        }

        async function deleteRate(id) {
            if(!await showConfirm('Are you sure you want to delete this rate?', true)) return;
            await fetch('/api/admin/rates/' + id, { method: 'DELETE' });
            loadRatesData();
        }
        // Helper for display
        function formatDuration(totalMinutes) {
            const d = Math.floor(totalMinutes / 1440);
            const h = Math.floor((totalMinutes % 1440) / 60);
            const m = totalMinutes % 60;
            const parts = [];
            if (d > 0) parts.push(d + 'd');
            if (h > 0) parts.push(h + 'h');
            if (m > 0 || parts.length === 0) parts.push(m + 'm');
            return parts.join(' ');
        }

        // --- Rates Management ---
        async function loadRatesData() {
            try {
                const res = await fetch('/api/admin/rates');
                const rates = await res.json();
                const tbody = document.querySelector('#rates-table tbody');
                tbody.innerHTML = '';

                if (rates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No rates configured</td></tr>';
                    return;
                }

                rates.forEach(rate => {
                    const tr = document.createElement('tr');
                    // Check if speed is stored in kbps and display in Mbps if suitable
                    const uploadMbps = (rate.upload_speed >= 1024) ? (rate.upload_speed / 1024).toFixed(1) + ' Mbps' : rate.upload_speed + ' Kbps';
                    const downloadMbps = (rate.download_speed >= 1024) ? (rate.download_speed / 1024).toFixed(1) + ' Mbps' : rate.download_speed + ' Kbps';
                    
                    tr.innerHTML = `
                        <td>â‚±${rate.amount}</td>
                        <td>${formatDuration(rate.minutes)}</td>
                        <td>${uploadMbps} / ${downloadMbps}</td>
                        <td>${rate.is_pausable ? '<span class="badge bg-success">Pausable</span>' : '<span class="badge bg-secondary">Continuous</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteRate(${rate.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Error loading rates:', e);
            }
        }

        function openRateModal(rate) {
            const modal = document.getElementById('rate-modal');
            const idInput = document.getElementById('rate-id');
            const amountInput = document.getElementById('rate-amount');
            const daysInput = document.getElementById('rate-days');
            const hoursInput = document.getElementById('rate-hours');
            const minutesInput = document.getElementById('rate-minutes');
            const ulInput = document.getElementById('rate-ul');
            const dlInput = document.getElementById('rate-dl');
            const pausableInput = document.getElementById('rate-pausable');

            if (rate && typeof rate === 'object') {
                idInput.value = rate.id || '';
                amountInput.value = rate.amount != null ? rate.amount : '';

                const totalMinutes = parseInt(rate.minutes, 10) || 0;
                const d = Math.floor(totalMinutes / 1440);
                const h = Math.floor((totalMinutes % 1440) / 60);
                const m = totalMinutes % 60;
                daysInput.value = d;
                hoursInput.value = h;
                minutesInput.value = m;

                const upKbps = Number(rate.upload_speed) || 5120;
                const downKbps = Number(rate.download_speed) || 5120;
                ulInput.value = (upKbps / 1024).toFixed(1);
                dlInput.value = (downKbps / 1024).toFixed(1);

                pausableInput.checked = !!rate.is_pausable;
            } else {
                idInput.value = '';
                amountInput.value = '';
                daysInput.value = 0;
                hoursInput.value = 0;
                minutesInput.value = 15;
                ulInput.value = 5;
                dlInput.value = 5;
                pausableInput.checked = true;
            }

            modal.style.display = 'flex';
        }

        function closeRateModal() {
            document.getElementById('rate-modal').style.display = 'none';
        }

        async function saveRate() {
            const amount = document.getElementById('rate-amount').value;
            
            const days = parseInt(document.getElementById('rate-days').value) || 0;
            const hours = parseInt(document.getElementById('rate-hours').value) || 0;
            const minutes = parseInt(document.getElementById('rate-minutes').value) || 0;
            const totalMinutes = (days * 1440) + (hours * 60) + minutes;

            const uploadMbps = parseFloat(document.getElementById('rate-ul').value);
            const downloadMbps = parseFloat(document.getElementById('rate-dl').value);
            const isPausable = document.getElementById('rate-pausable').checked;

            if (!amount || totalMinutes <= 0 || !uploadMbps || !downloadMbps) {
                alert('Please fill in all fields. Duration must be greater than 0.');
                return;
            }

            const data = {
                amount: parseInt(amount),
                minutes: totalMinutes,
                upload_speed: Math.round(uploadMbps * 1024),
                download_speed: Math.round(downloadMbps * 1024),
                is_pausable: isPausable ? 1 : 0
            };

            try {
                const res = await fetch('/api/admin/rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeRateModal();
                    loadRatesData();
                    try {
                        if (currentSubVendoDeviceId) {
                            populateSubVendoDeviceRates(currentSubVendoDeviceId);
                        }
                    } catch (e) {}
                    alert('Rate saved successfully');
                } else {
                    const err = await res.json();
                    alert('Error: ' + err.error);
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save rate');
            }
        }

        // --- Devices Management ---
        async function loadDevicesData() {
            try {
                const res = await fetch('/api/admin/devices');
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                
                const devices = await res.json();
                if (!Array.isArray(devices)) return;

                const tbody = document.querySelector('#devices-table tbody');
                tbody.innerHTML = '';

                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No devices found</td></tr>';
                    return;
                }

                devices.forEach(dev => {
                    const tr = document.createElement('tr');
                    
                    // Format time remaining
                    let timeDisplay = 'Expired';
                    if (dev.time_remaining > 0) {
                        // Reuse existing helper, expects minutes
                        timeDisplay = formatDuration(Math.ceil(dev.time_remaining / 60)); 
                    }

                    // Status Badge
                    let statusBadge = '<span class="badge bg-secondary">Offline</span>';
                    if (dev.is_connected) {
                        statusBadge = dev.is_paused 
                            ? '<span class="badge bg-warning">Paused</span>' 
                            : '<span class="badge bg-success">Connected</span>';
                    }

                    // Traffic Stats
                    const dl = formatBytes(dev.total_data_down || 0);
                    const ul = formatBytes(dev.total_data_up || 0);
                    
                    const toMbps = (bytes) => ((bytes || 0) * 8 / 1000000).toFixed(2);
                    const dlSpeed = dev.current_speed ? toMbps(dev.current_speed.dl_speed) : '0.00';
                    const ulSpeed = dev.current_speed ? toMbps(dev.current_speed.ul_speed) : '0.00';

                    tr.innerHTML = `
                        <td>${dev.mac_address}</td>
                        <td>${(dev.ip_address || 'N/A').replace('::ffff:', '')}</td>
                        <td>${timeDisplay}</td>
                        <td>
                            <div style="font-size:0.85rem;"><span style="color:#2ecc71;">â†“</span> ${dl} <span style="font-weight:bold; color:#27ae60;">(${dlSpeed} Mbps)</span></div>
                            <div style="font-size:0.85rem;"><span style="color:#3498db;">â†‘</span> ${ul} <span style="font-weight:bold; color:#2980b9;">(${ulSpeed} Mbps)</span></div>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="disconnectDevice(${dev.id})">Disconnect</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Error loading devices:', e);
            }
        }

        async function disconnectDevice(id) {
            if (!await showConfirm('Are you sure you want to disconnect and remove this device?', true)) return;
            try {
                const res = await fetch(`/api/admin/devices/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadDevicesData();
                } else {
                    alert('Failed to disconnect device');
                }
            } catch (e) {
                console.error(e);
                alert('Error disconnecting device');
            }
        }

        async function deleteRate(id) {
            if (!await showConfirm('Are you sure you want to delete this rate?', true)) return;

            try {
                const res = await fetch(`/api/admin/rates/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadRatesData();
                } else {
                    alert('Failed to delete rate');
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting rate');
            }
        }
        // --- QoS Logic ---
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function loadQoSUsers() {
            fetch('/api/admin/dashboard')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#qos-users-table tbody');
                    tbody.innerHTML = '';
                    if (!data.active_sessions || data.active_sessions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No active users</td></tr>';
                        return;
                    }
                    
                    data.active_sessions.forEach(user => {
                        const tr = document.createElement('tr');
                        // Rate is in Mbps, convert to readable
                        // Traffic is in bytes
                        const dlRate = (user.rate_down || 0).toFixed(2) + ' Mbps';
                        const ulRate = (user.rate_up || 0).toFixed(2) + ' Mbps';
                        const dlTotal = formatBytes(user.traffic_down || 0);
                        const ulTotal = formatBytes(user.traffic_up || 0);

                        tr.innerHTML = `
                            <td>${user.ip}</td>
                            <td>${user.mac}</td>
                            <td>
                                <div style="font-weight:600; color:#00b894;">${dlRate}</div>
                                <div style="font-size:0.8rem; color:#636e72;">Total: ${dlTotal}</div>
                            </td>
                            <td>
                                <div style="font-weight:600; color:#0984e3;">${ulRate}</div>
                                <div style="font-size:0.8rem; color:#636e72;">Total: ${ulTotal}</div>
                            </td>
                            <td>
                                <div><small>DL:</small> ${(user.speed_limit_down / 1024).toFixed(2)} Mbps</div>
                                <div><small>UL:</small> ${(user.speed_limit_up / 1024).toFixed(2)} Mbps</div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editQosLimit('${user.ip}', ${(user.speed_limit_down / 1024).toFixed(2)}, ${(user.speed_limit_up / 1024).toFixed(2)})">Edit Limit</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        let currentQosIp = null;
        function editQosLimit(ip, dl, ul) {
            currentQosIp = ip;
            document.getElementById('qos-modal-ip').textContent = `User IP: ${ip}`;
            document.getElementById('qos-edit-dl').value = dl;
            document.getElementById('qos-edit-ul').value = ul;
            document.getElementById('qos-limit-modal').style.display = 'flex';
        }

        function saveQosLimit() {
            const dl = document.getElementById('qos-edit-dl').value;
            const ul = document.getElementById('qos-edit-ul').value;
            if (!currentQosIp) return;

            const dlKbps = Math.floor(parseFloat(dl) * 1024);
            const ulKbps = Math.floor(parseFloat(ul) * 1024);

            fetch('/api/admin/qos/limit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip: currentQosIp, download_speed: dlKbps, upload_speed: ulKbps })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('qos-limit-modal').style.display = 'none';
                    loadQoSUsers(); // Refresh list
                    alert('Limit updated successfully');
                } else {
                    alert(data.error || 'Failed to set limit');
                }
            });
        }

        const qosDescriptions = {
            'gaming': '<strong>Gaming / Low-Latency Focused</strong><br>AI-driven prioritization for competitive gaming. Minimizes jitter (<5ms) and protects against lag spikes using micro-burst protection. Ideal for gamers and streamers.',
            'family': '<strong>Family / Household Management</strong><br>Balances bandwidth across all users. Ensures fair sharing for video calls, streaming, and browsing. Includes priority ladders for parents vs kids.',
            'enterprise': '<strong>Enterprise / Business Critical</strong><br>Guaranteed performance for VoIP, Teams, and mission-critical apps. Uses strict slicing to ensure reliability even during heavy load.',
            'green': '<strong>Green / Sustainable Angle</strong><br>Optimizes network for energy efficiency. Delays non-critical background tasks during high-load/high-carbon periods while keeping real-time apps smooth.'
        };

        function updateQoSDescription() {
            const mode = document.getElementById('qos-mode-select').value;
            let html = qosDescriptions[mode];
            
            if (mode === 'gaming') {
                html += '<div style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">' +
                        '<button class="btn btn-danger" style="background:#f72585; border:none;" onclick="triggerRageMode()">ðŸ”¥ Activate Rage Mode (5m)</button>' +
                        '<p style="font-size:0.85rem; color:#666; margin-top:5px;">Temporarily boosts all gaming traffic to absolute priority. Use when you experience lag spikes.</p>' +
                        '</div>';
            } else if (mode === 'green') {
                 html += '<div style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd; display:flex; gap:15px;">' +
                        '<div style="text-align:center;"><div style="font-size:1.2rem; font-weight:bold; color:#2ecc71;">12.4g</div><div style="font-size:0.8rem; color:#666;">COâ‚‚ Saved Today</div></div>' +
                        '<div style="text-align:center;"><div style="font-size:1.2rem; font-weight:bold; color:#2ecc71;">142Wh</div><div style="font-size:0.8rem; color:#666;">Energy Saved</div></div>' +
                        '</div>';
            }
            
            document.getElementById('qos-mode-desc').innerHTML = html;
        }

        async function triggerRageMode() {
            if(!await showConfirm("Activate Rage Mode? This will prioritize gaming traffic over everything else for 5 minutes.")) return;
            try {
                const res = await fetch('/api/admin/qos/rage', { method: 'POST' });
                const data = await res.json();
                if(data.success) alert("ðŸ”¥ Rage Mode Activated! You have 5 minutes of god-mode priority.");
                else alert("Failed to activate Rage Mode");
            } catch(e) { console.error(e); }
        }

        async function loadQoSMode() {
             try {
                const res = await fetch('/api/admin/qos/config');
                const config = await res.json();
                if(config.qos_mode) {
                    document.getElementById('qos-mode-select').value = config.qos_mode;
                }
                updateQoSDescription();
            } catch(e) { console.error(e); }
        }

        async function saveQoSMode() {
            const mode = document.getElementById('qos-mode-select').value;
             try {
                const res = await fetch('/api/admin/qos/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ qos_mode: mode })
                });
                if(res.ok) alert('QoS Mode Updated');
                else alert('Failed to update QoS Mode');
            } catch(e) { console.error(e); alert('Error saving mode'); }
        }
        // --- Security & Maintenance ---
        async function updateCredentials(e) {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const confirm = document.getElementById('admin-confirm-password').value;
            const security_question = document.getElementById('admin-security-question').value;
            const security_answer = document.getElementById('admin-security-answer').value;

            if (password !== confirm) {
                alert("Passwords do not match!");
                return;
            }

            try {
                const res = await fetch('/api/admin/security/credentials', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password, security_question, security_answer })
                });
                
                if (res.ok) {
                    await showConfirm("Credentials updated successfully. Please login again.", false, "Success");
                    logout(true);
                } else {
                    const data = await res.json();
                    alert("Error: " + data.error);
                }
            } catch (e) {
                console.error(e);
                alert("Failed to update credentials");
            }
        }

        async function rebootSystem() {
            if (!await showConfirm("Are you sure you want to REBOOT the system?", true)) return;
            try {
                const res = await fetch('/api/admin/system/reboot', { method: 'POST' });
                if (res.ok) {
                    alert("System is rebooting. Please wait about 60 seconds before refreshing.");
                } else {
                    alert("Failed to initiate reboot");
                }
            } catch (e) {
                alert("Error sending reboot command");
            }
        }

        async function factoryReset() {
            const code = await showPrompt("Type 'RESET' to confirm factory reset. This will delete all data!", "Type RESET here", "Factory Reset");
            if (code !== 'RESET') return;
            
            try {
                const res = await fetch('/api/admin/system/reset', { method: 'POST' });
                if (res.ok) {
                    await showConfirm("Factory reset complete. System will now restart.", false, "Success");
                    // Reload or logout
                    location.reload();
                } else {
                    alert("Failed to factory reset");
                }
            } catch (e) {
                alert("Error performing factory reset");
            }
        }

        async function upgradeSystem(type) {
            if (!await showConfirm(`Start ${type} system upgrade? System may be offline for a few minutes.`, true)) return;
            try {
                const res = await fetch('/api/admin/system/upgrade', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type })
                });
                if (res.ok) {
                    alert("Upgrade initiated. Check logs or wait for system restart.");
                } else {
                    alert("Failed to start upgrade");
                }
            } catch (e) {
                alert("Error starting upgrade");
            }
        }

        async function verifyConfiguration() {
            const modal = document.getElementById('verify-modal');
            const content = document.getElementById('verify-results');
            modal.style.display = 'flex';
            content.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spin" style="width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #3498db; border-radius:50%; margin:0 auto 10px;"></div>Running system checks...</div>';

            try {
                const res = await fetch('/api/admin/system/verify');
                const data = await res.json();
                
                let html = '<table style="width:100%; border-collapse:collapse;">';
                html += '<thead><tr style="background:#f8f9fa; text-align:left;"><th style="padding:10px;">Category</th><th style="padding:10px;">Status</th><th style="padding:10px;">Message</th></tr></thead><tbody>';
                
                data.checks.forEach(check => {
                    let color = '#666';
                    let icon = 'â€¢';
                    if (check.status === 'success') { color = '#2ecc71'; icon = 'âœ”'; }
                    else if (check.status === 'warning') { color = '#f1c40f'; icon = 'âš '; }
                    else if (check.status === 'error') { color = '#e74c3c'; icon = 'âœ–'; }
                    else if (check.status === 'info') { color = '#3498db'; icon = 'â„¹'; }
                    
                    html += `<tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px; font-weight:600;">${check.category}</td>
                        <td style="padding:10px; color:${color}; font-weight:bold;">${icon} ${check.status.toUpperCase()}</td>
                        <td style="padding:10px;">${check.message}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += `<div style="margin-top:15px; font-size:0.8rem; color:#999; text-align:right;">Checked at: ${new Date(data.timestamp).toLocaleString()}</div>`;
                
                content.innerHTML = html;
            } catch (e) {
                content.innerHTML = `<div style="color:red; text-align:center; padding:20px;">Error running checks: ${e.message}</div>`;
            }
        }

        // --- Chat System ---
        let chatSocket = null;
        let currentChatMac = null;

        function updateChatStatus(connected) {
            const indicator = document.getElementById('chat-status-indicator');
            const dot = indicator.querySelector('.status-dot');
            const text = indicator.querySelector('.status-text');
            
            indicator.style.display = 'flex';
            if (connected) {
                dot.style.background = '#2ecc71';
                text.textContent = 'Connected';
            } else {
                dot.style.background = '#e74c3c';
                text.textContent = 'Disconnected';
            }
        }

        function initChatSocket() {
            if (chatSocket) return;
            
            // Connect to root namespace
            // Note: Socket.io client script must be loaded
            if (typeof io === 'undefined') {
                console.error("Socket.io not loaded");
                return;
            }

            chatSocket = io({
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: Infinity
            });

            chatSocket.on('connect', () => {
                console.log('Admin Chat Connected');
                updateChatStatus(true);
                if (currentChatMac) {
                    chatSocket.emit('admin_join_chat', { mac: currentChatMac });
                }
            });

            chatSocket.on('disconnect', () => {
                console.log('Admin Chat Disconnected');
                updateChatStatus(false);
            });
            
            chatSocket.on('connect_error', (err) => {
                console.log('Chat connection error:', err);
                updateChatStatus(false);
            });

            // Listen for new messages from users (Global broadcast)
            chatSocket.on('admin_new_message', (data) => {
                // data: { mac, sender: 'user', message, timestamp, unread_count }
                
                // If viewing this conversation, append message
                if (currentChatMac === data.mac) {
                    appendChatMessage({
                        message: data.message,
                        timestamp: data.timestamp,
                        is_from_admin: 0 
                    });
                    // Mark as read
                    fetch(`/api/admin/chat/history/${data.mac}`);
                }
                
                // Refresh list
                loadConversations();
            });

            // Listen for messages in the room (including my own echo if I joined)
            chatSocket.on('new_message', (data) => {
                // Ignore own messages or handle duplicates
            });
        }


        async function loadConversations() {
            try {
                const res = await fetch('/api/admin/chat/conversations');
                const conversations = await res.json();
                
                const list = document.getElementById('chat-list');
                list.innerHTML = '';

                if (conversations.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color:#b2bec3;">No conversations yet.</div>';
                    return;
                }

                conversations.forEach(c => {
                    // Map API keys to UI keys if needed, or just use API keys
                    // API returns: sender_mac, message, timestamp, unread_count, user_code, client_id
                    const mac = c.sender_mac;
                    const displayName = c.user_code ? `ID: ${c.user_code}` : (c.client_id ? `Dev: ${c.client_id.substring(0,8)}...` : mac);
                    
                    const div = document.createElement('div');
                    div.className = `chat-item ${currentChatMac === mac ? 'active' : ''} ${c.unread_count > 0 ? 'unread' : ''}`;
                    div.onclick = () => selectConversation(mac);
                    
                    const time = c.timestamp ? new Date(c.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    const unreadHtml = c.unread_count > 0 ? `<span class="chat-badge">${c.unread_count}</span>` : '';
                    const preview = c.message || '<i>No messages</i>';
                    
                    div.innerHTML = `
                        <div class="chat-item-header">
                            <span class="chat-mac" style="${c.unread_count > 0 ? 'font-weight:800; color:#000;' : ''}">${displayName}</span>
                            <span class="chat-time">${time}</span>
                        </div>
                        <div class="chat-preview">
                            ${preview}
                        </div>
                        ${unreadHtml}
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error("Load conversations error", e);
            }
        }

        function toggleChatSidebar() {
            const sidebar = document.getElementById('chat-sidebar');
            sidebar.classList.toggle('hidden');
        }

        async function selectConversation(mac) {
            currentChatMac = mac;
            localStorage.setItem('admin_chat_active_mac', mac);
            
            // Auto-hide sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('chat-sidebar').classList.add('hidden');
            }
            
            // UI Updates
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            document.getElementById('chat-current-user').textContent = `Chat with ${mac}`;
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;
            document.getElementById('chat-input').focus();
            
            // Join the room
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('admin_join_chat', { mac: mac });
            }

            // Load History
            await loadChatHistory(mac);
            
            // Refresh list to clear unread
            loadConversations();
        }

        async function loadChatHistory(mac) {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">Loading history...</div>';
            
            try {
                const res = await fetch(`/api/admin/chat/history/${mac}`);
                const messages = await res.json();
                
                container.innerHTML = '';
                if (messages.length === 0) {
                     container.innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">No messages yet. Start chatting!</div>';
                } else {
                    messages.forEach(msg => appendChatMessage(msg));
                }
                scrollToBottom();
            } catch (e) {
                container.innerHTML = '<div style="text-align:center; color:red;">Failed to load history</div>';
            }
        }

        function appendChatMessage(msg) {
            const container = document.getElementById('chat-messages');
            // Remove "No messages" placeholder if exists
            if (container.textContent.includes('No messages yet') || container.textContent.includes('Loading history')) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            // Check if msg is from admin or user
            const isMe = msg.is_from_admin == 1; 
            
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `
                ${msg.message}
                <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            `;
            container.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            }
        }

        async function sendAdminMessage() {
            if (!currentChatMac) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Check socket connection
            if (!chatSocket || !chatSocket.connected) {
                // Try to reconnect if socket exists but disconnected
                if (chatSocket) {
                     console.log("Socket disconnected. Attempting to reconnect...");
                     chatSocket.connect();
                     // Give it a moment? No, better to show status.
                } else {
                     initChatSocket();
                }
                
                // If still not connected immediately, we can't send.
                // But let's check again in 500ms? 
                // For now, show alert.
                alert('Chat is currently disconnected. Please wait for reconnection (check status indicator).');
                return;
            }
            
            // Emit via socket
            chatSocket.emit('admin_send_message', {
                mac: currentChatMac,
                message: message
            });
            
            // Optimistically append
            appendChatMessage({
                message: message,
                is_from_admin: 1,
                timestamp: new Date().toISOString()
            });
            
            input.value = '';
            input.focus();
        }

        // Initialize socket and event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
             // Chat Input Listener
             const chatInput = document.getElementById('chat-input');
             if (chatInput) {
                 chatInput.addEventListener('keypress', function (e) {
                     if (e.key === 'Enter') {
                         sendAdminMessage();
                     }
                 });
             }
             
             const sendBtn = document.getElementById('chat-send-btn');
            if (sendBtn) {
                const handleSendClick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    sendAdminMessage();
                };
                sendBtn.addEventListener('mousedown', handleSendClick);
                sendBtn.addEventListener('touchstart', handleSendClick, {passive: false});
            }
             
             // Initialize Socket
             initChatSocket();

             // Restore active chat session or load list
             const storedMac = localStorage.getItem('admin_chat_active_mac');
             if (storedMac) {
                 selectConversation(storedMac);
             } else {
                 loadConversations();
             }
         });

        // --- Sub Vendo Functions ---

        async function loadSubVendoConfig() {
            try {
                const res = await fetch('/api/admin/subvendo/key');
                if (res.status === 401) return location.reload();
                const data = await res.json();
                document.getElementById('subvendo-key').value = data.key || '';
            } catch (e) {
                console.error("Failed to load sub vendo config", e);
            }
        }

        async function openSubVendoFreeTimeModal() {
            document.getElementById('subvendo-free-time-modal').style.display='flex';
            await loadVlans();
            await loadSubVendoFreeTime();
        }

        function parseHMS(hms) {
            if (!hms || typeof hms !== 'string') return null;
            const m = hms.trim().match(/^(\d{1,3}):([0-5]?\d):([0-5]?\d)$/);
            if (!m) return null;
            const h = parseInt(m[1], 10);
            const mi = parseInt(m[2], 10);
            const s = parseInt(m[3], 10);
            const totalSeconds = (h * 3600) + (mi * 60) + s;
            return totalSeconds / 60; // store as minutes (float)
        }

        function formatHMSFromMinutes(minutes) {
            const m = Number(minutes) || 0;
            const totalSeconds = m * 60;
            const h = Math.floor(totalSeconds / 3600);
            const rem = totalSeconds % 3600;
            const mm = Math.floor(rem / 60);
            const ss = rem % 60;
            const pad = (x) => String(x).padStart(2, '0');
            return `${h}:${pad(mm)}:${pad(ss)}`;
        }

        async function loadSubVendoFreeTime() {
            try {
                const res = await fetch('/api/admin/subvendo/free-time');
                if (res.status === 401) return location.reload();
                const data = await res.json();
                const cfg = data && typeof data === 'object' && !Array.isArray(data) ? data : {};
                const select = document.getElementById('free-time-vlan');
                const enabledCheckbox = document.getElementById('free-time-enabled');
                const widgetCheckbox = document.getElementById('free-time-widget');
                const minutesInput = document.getElementById('free-time-minutes');
                const reclaimInput = document.getElementById('free-time-reclaim');
                if (!select || !enabledCheckbox || !widgetCheckbox || !minutesInput) return;

                const iface = select.value;
                const v = cfg[iface] || {};
                enabledCheckbox.checked = !!v.enabled;
                widgetCheckbox.checked = !!v.widget_enabled;
                minutesInput.value = v.minutes != null ? formatHMSFromMinutes(v.minutes) : '';
                if (reclaimInput) reclaimInput.value = v.reclaim_period || '24:00:00';
            } catch (e) {
                console.error('Failed to load sub vendo free time', e);
            }
        }

        async function saveSubVendoFreeTime() {
            const select = document.getElementById('free-time-vlan');
            const enabledCheckbox = document.getElementById('free-time-enabled');
            const widgetCheckbox = document.getElementById('free-time-widget');
            const minutesInput = document.getElementById('free-time-minutes');
            const reclaimInput = document.getElementById('free-time-reclaim');
            if (!select || !enabledCheckbox || !widgetCheckbox || !minutesInput) return;

            const iface = select.value;
            const payload = {};
            payload[iface] = {
                enabled: enabledCheckbox.checked,
                widget_enabled: widgetCheckbox.checked,
                minutes: (() => {
                    // accept hh:mm:ss; if plain number, treat as minutes
                    const val = (minutesInput.value || '').trim();
                    const fromHms = parseHMS(val);
                    if (fromHms != null) return fromHms;
                    const asInt = parseInt(val || '0', 10);
                    return Number.isFinite(asInt) && asInt > 0 ? asInt : 0;
                })(),
                reclaim_period: (() => {
                    const v = (reclaimInput && reclaimInput.value || '').trim();
                    return v && /^(\d{1,3}):([0-5]?\d):([0-5]?\d)$/.test(v) ? v : '24:00:00';
                })()
            };

            try {
                const res = await fetch('/api/admin/subvendo/free-time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    alert('Failed to save free time settings');
                } else {
                    alert('Free time settings saved');
                    document.getElementById('subvendo-free-time-modal').style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to save free time settings', e);
                alert('Error saving free time settings');
            }
        }

        async function saveSubVendoKey() {
            const key = document.getElementById('subvendo-key').value;
            try {
                const res = await fetch('/api/admin/subvendo/key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Sub Vendo Key Saved');
                } else {
                    alert('Error saving key');
                }
            } catch (e) {
                console.error("Failed to save sub vendo key", e);
                alert('Error saving key');
            }
        }

        async function loadSubVendoDevices() {
            try {
                const res = await fetch('/api/admin/subvendo/devices');
                if (res.status === 401) return location.reload();
                const devices = await res.json();
                window.subVendoDevicesCache = Array.isArray(devices) ? devices : [];
                const tbody = document.querySelector('#subvendo-devices-table tbody');
                const list = document.getElementById('subvendo-devices-list');
                tbody.innerHTML = '';
                if (list) list.innerHTML = '';
                
                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No devices registered</td></tr>';
                    if (list) list.innerHTML = '<div style="text-align:center; padding:12px; color:#636e72;">No devices registered</div>';
                    return;
                }

                devices.forEach(device => {
                    const tr = document.createElement('tr');
                    const isOnline = device.online;
                    const statusDot = isOnline 
                        ? '<span style="display:inline-block; width:8px; height:8px; background:#2ecc71; border-radius:50%; margin-right:6px;" title="Online"></span>' 
                        : '<span style="display:inline-block; width:8px; height:8px; background:#e74c3c; border-radius:50%; margin-right:6px;" title="Offline"></span>';
                    
                    tr.innerHTML = `
                        <td style="display:flex; align-items:center;">${statusDot}${device.name || '-'}</td>
                        <td style="font-family:monospace;">${device.device_id}</td>
                        <td><span class="status-badge ${device.status === 'active' ? 'status-active' : 'status-inactive'}">${device.status}</span></td>
                        <td>${isOnline ? '<span style="color:#2ecc71; font-weight:bold;">Online Now</span>' : (device.last_active_at ? new Date(device.last_active_at).toLocaleString() : 'Never')}</td>
                        <td>
                            <button class="btn-icon" onclick="openSubVendoDeviceSettings(${device.id})" title="Settings">
                                <svg style="width:16px;height:16px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 8a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"/></svg>
                            </button>
                            <button class="btn-icon delete" onclick="deleteSubVendoDevice(${device.id})">
                                <svg style="width:16px;height:16px;fill:currentColor;" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    
                    if (list) {
                        const card = document.createElement('div');
                        card.className = 'device-card';
                        const lastActive = isOnline ? '<span style="color:#2ecc71; font-weight:bold;">Online Now</span>' : (device.last_active_at ? new Date(device.last_active_at).toLocaleString() : 'Never');
                        const statusBadgeClass = device.status === 'active' ? 'status-active' : 'status-inactive';
                        card.innerHTML = `
                            <div class="device-card-header">
                                <div class="device-name">${statusDot}${device.name || '-'}</div>
                                <div class="device-id">${device.device_id}</div>
                            </div>
                            <div class="device-meta">
                                <span class="status-badge ${statusBadgeClass}">${device.status}</span>
                                <span>${lastActive}</span>
                            </div>
                            <div class="device-actions">
                                <button class="btn btn-sm" onclick="openSubVendoDeviceSettings(${device.id})" style="background:#f39c12; color:white;">Settings</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSubVendoDevice(${device.id})">Delete</button>
                            </div>
                        `;
                        list.appendChild(card);
                    }
                });
            } catch (e) {
                console.error("Failed to load sub vendo devices", e);
            }
        }

        async function coinsOut(id, name, amount) {
            if (amount <= 0) {
                if (!confirm(`Device ${name} has no recorded un-out sales. Do you want to reset the counter anyway?`)) return;
            } else {
                if (!confirm(`Confirm Coins Out for ${name}?\nAmount: â‚±${amount}`)) return;
            }

            try {
                const res = await fetch(`/api/admin/subvendo/devices/${id}/coins-out`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('Coins Out Successful!');
                    loadSubVendoDevices();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error performing coins out');
                console.error(e);
            }
        }

        let currentSubVendoDeviceId = null;

        function openSubVendoDeviceSettings(id) {
            currentSubVendoDeviceId = id;
            const devices = window.subVendoDevicesCache || [];
            const device = devices.find(d => Number(d.id) === Number(id));
            if (!device) return;

            document.getElementById('subvendo-device-name').value = device.name || '';
            document.getElementById('subvendo-device-description').value = device.description || '';
            document.getElementById('subvendo-device-rate').value = device.peso_per_pulse != null ? device.peso_per_pulse : 1;
            document.getElementById('subvendo-device-coin-pin').value = device.coin_pin != null ? device.coin_pin : 6;
            document.getElementById('subvendo-device-relay-pin').value = device.relay_pin != null ? device.relay_pin : 5;
            document.getElementById('subvendo-device-download').value = device.download_speed ? (device.download_speed / 1024) : '';
            document.getElementById('subvendo-device-upload').value = device.upload_speed ? (device.upload_speed / 1024) : '';

            populateSubVendoDeviceRates(id);
            document.getElementById('subvendo-device-modal').style.display = 'flex';
        }

        function closeSubVendoDeviceSettings() {
            document.getElementById('subvendo-device-modal').style.display = 'none';
            currentSubVendoDeviceId = null;
        }

        async function saveSubVendoDeviceSettings() {
            if (!currentSubVendoDeviceId) return;
            const payload = {
                name: document.getElementById('subvendo-device-name').value,
                description: document.getElementById('subvendo-device-description').value,
                peso_per_pulse: Number(document.getElementById('subvendo-device-rate').value),
                coin_pin: Number(document.getElementById('subvendo-device-coin-pin').value),
                relay_pin: Number(document.getElementById('subvendo-device-relay-pin').value),
                download_speed: document.getElementById('subvendo-device-download').value ? Math.round(Number(document.getElementById('subvendo-device-download').value) * 1024) : null,
                upload_speed: document.getElementById('subvendo-device-upload').value ? Math.round(Number(document.getElementById('subvendo-device-upload').value) * 1024) : null
            };

            try {
                const res = await fetch(`/api/admin/subvendo/devices/${currentSubVendoDeviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data && data.success) {
                    const rateContainer = document.getElementById('subvendo-device-rates');
                    const checked = Array.from(rateContainer.querySelectorAll('input[type="checkbox"][data-rate-id]:checked'))
                        .map(x => Number(x.getAttribute('data-rate-id')))
                        .filter(x => Number.isFinite(x));
                    try {
                        await fetch(`/api/admin/subvendo/devices/${currentSubVendoDeviceId}/rates`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ visible_rate_ids: checked })
                        });
                    } catch (e) {}
                    closeSubVendoDeviceSettings();
                    loadSubVendoDevices();
                } else {
                    alert('Failed to save settings: ' + (data && data.error ? data.error : 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to save device settings', e);
                alert('Error saving device settings');
            }
        }

        async function populateSubVendoDeviceRates(id) {
            const container = document.getElementById('subvendo-device-rates');
            if (!container) return;
            container.innerHTML = 'Loading rates...';
            try {
                const res = await fetch(`/api/admin/subvendo/devices/${id}/rates`);
                const rates = await res.json();
                if (!Array.isArray(rates) || rates.length === 0) {
                    container.innerHTML = '<div>No rates configured</div>';
                    return;
                }
                const html = rates.map(r => {
                    const minutes = Number(r.minutes) || 0;
                    let dur = minutes + 'm';
                    if (minutes >= 60) {
                        const h = Math.floor(minutes / 60);
                        const m = minutes % 60;
                        dur = h + 'h' + (m > 0 ? ' ' + m + 'm' : '');
                    }
                    const ul = r.upload_speed >= 1024 ? (r.upload_speed / 1024).toFixed(1) + ' Mbps' : r.upload_speed + ' Kbps';
                    const dl = r.download_speed >= 1024 ? (r.download_speed / 1024).toFixed(1) + ' Mbps' : r.download_speed + ' Kbps';
                    const type = r.is_pausable ? 'Pausable' : 'Continuous';
                    const checked = r.visible ? 'checked' : '';
                    return `
                        <label style="display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #eee; border-radius:6px; font-size:0.8rem;">
                            <input type="checkbox" data-rate-id="${r.id}" ${checked}>
                            <div style="display:flex; flex-wrap:wrap; gap:12px; flex:1;">
                                <span><strong>Coin:</strong> â‚±${r.amount}</span>
                                <span><strong>Duration:</strong> ${dur}</span>
                                <span><strong>Type:</strong> ${type}</span>
                                <span><strong>Upload:</strong> ${ul}</span>
                                <span><strong>Download:</strong> ${dl}</span>
                            </div>
                            <button class="btn btn-sm btn-warning subvendo-rate-edit-btn" data-rate-id="${r.id}" type="button">
                                Edit
                            </button>
                        </label>
                    `;
                }).join('');
                const addBtn = `
                    <div style="display:flex; justify-content:flex-end; margin-top:8px;">
                        <button class="btn btn-sm btn-primary" onclick="if (typeof openRateModal === 'function') { openRateModal(); }">+ Add Rate</button>
                    </div>
                `;
                container.innerHTML = html + addBtn;

                try {
                    const buttons = container.querySelectorAll('.subvendo-rate-edit-btn');
                    buttons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const rateId = Number(btn.getAttribute('data-rate-id'));
                            const rate = Array.isArray(rates) ? rates.find(x => Number(x.id) === rateId) : null;
                            if (!rate) return;
                            if (typeof openRateModal === 'function') {
                                openRateModal(rate);
                            }
                        });
                    });
                } catch (e) {
                    console.error('Failed to wire rate edit buttons', e);
                }
            } catch (e) {
                console.error('Failed to load device rates', e);
                container.innerHTML = '<div>Failed to load rates</div>';
            }
        }

        async function deleteSubVendoDevice(id) {
            if(!confirm('Are you sure you want to remove this device?')) return;
            try {
                const res = await fetch(`/api/admin/subvendo/devices/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if(data.success) {
                    loadSubVendoDevices();
                } else {
                    alert('Failed to delete device: ' + data.error);
                }
            } catch(e) {
                console.error("Failed to delete device", e);
                alert('Error deleting device');
            }
        }
    </script>
    <style>
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }
        .status-online .status-dot {
            background-color: #28a745;
            box-shadow: 0 0 5px #28a745;
        }
        .status-online {
            color: #28a745;
        }
        .status-offline .status-dot {
            background-color: #dc3545;
        }
        .status-offline {
            color: #dc3545;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #1b2631;
            --light: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border: #dfe6e9;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: #f0f2f5; color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 180px; background: var(--dark); color: white; display: flex; flex-direction: column; transition: 0.3s; flex-shrink: 0; }
        .sidebar-header { padding: 10px; font-size: 1.4rem; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .sidebar-header svg { width: 24px; height: 24px; fill: var(--success); }
        .menu { flex: 1; padding-top: 20px; overflow-y: auto; }
        .menu-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #b2bec3; transition: 0.2s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.05); color: white; border-right: 3px solid var(--success); }
        .menu-item svg { width: 18px; height: 18px; fill: currentColor; }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .logout-btn { width: 100%; padding: 12px; background: #c0392b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .logout-btn:hover { background: #e74c3c; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #00b894; }
        input:focus + .slider { box-shadow: 0 0 1px #00b894; }
        input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 20px; }
        .slider.round:before { border-radius: 50%; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .topbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); z-index: 10; flex-shrink: 0; }
        .page-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
        .status-badge { background: #e0fbf0; color: #2ecc71; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; }

        .content-scroll { padding: 10px 24px; overflow-y: auto; flex: 1; height: auto; min-height: 0; }
        
        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        
        /* Cards */
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .card-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 0.95rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Info Rows */
        .info-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f1f2f6; font-size: 0.95rem; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-muted); font-weight: 500; }
        .info-value { font-weight: 600; color: var(--dark); }

        /* Revenue Cards */
        .rev-card { position: relative; overflow: hidden; }
        .rev-value { font-size: 1.8rem; font-weight: 800; color: var(--dark); margin: 10px 0 5px 0; }
        .rev-label { font-size: 0.85rem; color: var(--text-muted); }
        .rev-icon { position: absolute; right: 20px; top: 20px; width: 40px; height: 40px; opacity: 0.1; fill: var(--primary); }

        /* Tables */
        .table-container { background: white; border-radius: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .table-container table { min-width: 600px; }
        .table-container th, .table-container td { white-space: nowrap; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px 20px; text-align: left; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        td { padding: 15px 20px; border-bottom: 1px solid #f1f2f6; font-size: 0.95rem; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        .status-active { color: #2ecc71; font-weight: 600; }
        .status-expired { color: #e74c3c; font-weight: 600; }
        
        /* Mobile Device List */
        .device-list { display: none; }
        .device-card { background: #fff; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); padding: 12px; display: grid; grid-template-columns: 1fr; gap: 8px; }
        .device-card-header { display: flex; justify-content: space-between; align-items: center; }
        .device-name { display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--dark); }
        .device-id { font-family: monospace; color: #636e72; font-size: 0.85rem; }
        .device-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-muted); }
        .device-actions { display: flex; gap: 8px; justify-content: flex-end; }


        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .btn-danger { background: #ffecec; color: #e74c3c; }
        .btn-danger:hover { background: #e74c3c; color: white; }
        .btn-primary { background: var(--primary); color: white; }

        /* Login Screen */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--dark); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }

        /* Pull to Refresh */
        #pull-to-refresh {
            height: 50px;
            margin-top: -50px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            transition: margin-top 0.2s;
            width: 100%;
            overflow: hidden;
            opacity: 0; /* Hidden on desktop */
        }
        .ptr-icon { transition: transform 0.3s; }
        .ptr-icon.rotate { transform: rotate(180deg); }
        
        .mobile-toggle { display: none; cursor: pointer; padding: 8px; border-radius: 8px; }
        .mobile-toggle:hover { background: rgba(0,0,0,0.06); }

        #sidebar-overlay { display: none; }

        /* Mobile */
        @media (max-width: 768px) {
            #pull-to-refresh { opacity: 1; } /* Visible on mobile */
            .sidebar { position: fixed; top: 0; bottom: 0; left: -260px; width: 240px; height: auto; z-index: 100; }
            .sidebar.open { left: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
            .grid-2 { grid-template-columns: 1fr; }
            .form-grid { gap: 10px; }
            .grid-4 { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .mobile-toggle { display: block; }
            
            .content-scroll { padding: 10px 0 120px 0; }
            .topbar { flex-wrap: wrap; gap: 40px; padding: 0 15px; }
            .page-title { font-size: 1.2rem; }
            .status-badge { font-size: 0.75rem; padding: 4px 8px; }
            
            /* Center and reduce width of grids */
            .grid-2, .grid-4 {
                width: 94%;
                margin-left: auto;
                margin-right: auto;
            }
            .settings-wrapper {
                width: 100%;
                margin-left: auto;
                margin-right: auto;
            }
            .settings-wrapper .card {
                padding: 0 !important;
            }
            .settings-wrapper .card-title {
                padding-left: 10px;
                padding-top: 5px;
            }

            /* Ensure cards don't overflow */
            .card { padding: 15px; }
            
            /* Bandwidth Table Adjustment for Mobile */
            .bw-table th, .bw-table td { padding: 6px 4px; font-size: 0.75rem; }
            .bw-row-name { font-size: 0.75rem; }

            /* Mobile Scrollable Table */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                display: block;
            }
            .table-responsive table {
                min-width: 600px;
            }
            .table-responsive th, .table-responsive td {
                white-space: nowrap;
            }
            #subvendo-device-modal > div {
                width: 98%;
                max-width: 98%;
            }
            #subvendo-device-form {
                padding: 12px !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            #view-subvendo .card-header { flex-wrap: wrap; gap: 10px; }
            #view-subvendo .form-group > div { flex-wrap: wrap; }
            #view-subvendo .form-group > div input { flex: 1 1 100%; }
            #view-subvendo .form-group > div .btn { width: 100%; }
            .table-container table { min-width: 100%; }
            #subvendo-devices-table th, #subvendo-devices-table td { padding: 10px 12px; font-size: 0.85rem; }
            #view-subvendo .table-container { display: none; }
            #view-subvendo .device-list { display: grid; gap: 10px; }

            #sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.35);
                z-index: 90;
            }
            #sidebar-overlay.open { display: block; }
            
            /* Stack Settings Grid on Mobile */
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            /* Chat Mobile Styles */
            .chat-container {
                position: relative;
                overflow: hidden;
            }
            .chat-sidebar {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
                transition: transform 0.3s ease;
                background: white;
            }
            .chat-sidebar.hidden {
                transform: translateX(-100%);
            }
            .chat-main {
                width: 100%;
                height: 100%;
            }
            #chat-toggle-list-btn {
                display: block !important;
            }
            .mobile-only-block {
                display: block !important;
            }
            
            /* Adjust Drawer Content Padding */
            .drawer-open .drawer-content {
                padding: 15px 5px;
            }
        }

        /* Spin Animation */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }

        /* Bandwidth Stats Table */
        .bw-stats-container { margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .bw-table { width: 100%; min-width: 500px; border-collapse: collapse; font-size: 0.85rem; color: #2d3436; table-layout: fixed; }
        .bw-table th { text-align: right; color: #b2bec3; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; padding: 5px 0; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
        .bw-table td { text-align: right; padding: 8px 0; border-bottom: 1px solid #f9f9f9; white-space: nowrap; }
        .bw-table td:first-child, .bw-table th:first-child { text-align: left; }
        
        .bw-row-name { display: flex; align-items: center; gap: 8px; font-weight: 600; white-space: nowrap; }
        .legend-box { width: 12px; height: 12px; border-radius: 2px; display: inline-block; flex-shrink: 0; }
        #bandwidthChart { background: linear-gradient(180deg, #ffffff 0%, #f7fbff 100%); border-radius: 10px; }
        
        /* Active Sessions Light Table */
        .dark-card { background: #ffffff !important; color: #2d3436; border: 1px solid #dfe6e9; }
        .dark-card .card-header { border-bottom: 1px solid #f1f2f6; }
        .dark-card .card-title { color: #2d3436; text-transform: uppercase; font-size: 0.95rem; font-weight: 700; }
        .dark-table-container { background: #ffffff; border: none; box-shadow: none; }
        .dark-table th { background: #f8f9fa; color: #636e72; border-bottom: 1px solid #dfe6e9; border-right: 1px solid #dfe6e9; text-transform: uppercase; font-size: 0.75rem; padding: 12px 10px; font-weight: 600; text-align: center; }
        .dark-table td { background: #ffffff; color: #2d3436; border-bottom: 1px solid #f1f2f6; border-right: 1px solid #f1f2f6; padding: 12px 10px; font-size: 0.85rem; vertical-align: middle; text-align: center; }
        .dark-table th:last-child, .dark-table td:last-child { border-right: none; }
        .code-text { color: #0984e3; font-weight: 600; }
        .limit-text { color: #00b894; font-size: 0.8rem; }
        .type-badge { background: #e0f2f1; color: #009688; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-size: 0.75rem; font-weight: 600; }
        .search-input { background: #f1f2f6; border: 1px solid #dfe6e9; padding: 8px 15px; border-radius: 4px; color: #2d3436; width: 200px; outline: none; }
        .filter-select { background: #f1f2f6; border: 1px solid #dfe6e9; padding: 8px; border-radius: 4px; color: #2d3436; margin-right: 15px; outline: none; }
        .checkbox-custom { accent-color: #0984e3; cursor: pointer; }
        .dots-menu { color: #636e72; cursor: pointer; font-size: 1.2rem; line-height: 0.5; }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 20px;
            row-gap: 8px;
        }

        /* Drawer / Accordion */
        .drawer-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .drawer-header:hover {
            background-color: #f8f9fa;
        }
        .drawer-arrow {
            transition: transform 0.3s ease;
            width: 24px;
            height: 24px;
            fill: #636e72;
        }
        .drawer-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 20px; /* Keep horizontal padding */
        }
        .drawer-open .drawer-arrow {
            transform: rotate(180deg);
        }
        .drawer-open .drawer-content {
            border-top: 1px solid #f1f2f6;
            padding: 15px;
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            height: 600px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .chat-sidebar {
            width: 300px;
            border-right: 1px solid #dfe6e9;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }
        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #dfe6e9;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-item:hover, .chat-item.active {
            background: #eef2f7;
        }
        .chat-item.unread {
            background: #f0f8ff;
            border-left: 4px solid #0984e3;
        }
        .chat-item.unread .chat-mac {
            font-weight: 800;
            color: #000;
        }
        .chat-item.unread .chat-preview {
            font-weight: 600;
            color: #2c3e50;
        }
        .chat-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .chat-mac {
            font-weight: 600;
            color: #2d3436;
        }
        .chat-time {
            font-size: 0.8rem;
            color: #b2bec3;
        }
        .chat-preview {
            font-size: 0.9rem;
            color: #636e72;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-badge {
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #dfe6e9;
            font-weight: 600;
            color: #2d3436;
            background: #fff;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f1f2f6;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        @keyframes msgSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            animation: msgSlideUp 0.3s ease-out forwards;
        }
        .message.received {
            align-self: flex-start;
            background: white;
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message.sent {
            align-self: flex-end;
            background: #0984e3;
            color: white;
            border-bottom-right-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message-time {
            font-size: 0.7rem;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #dfe6e9;
            display: flex;
            gap: 10px;
            background: white;
        }
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #dfe6e9;
            border-radius: 20px;
            outline: none;
            font-family: inherit;
        }
        .chat-input:focus {
            border-color: #0984e3;
        }
        .chat-send-btn {
            background: #0984e3;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .chat-send-btn:hover {
            background: #00cec9;
        }
    </style>

    <style>
        @media (max-width: 768px) {
            .topbar {
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px 15px;
                z-index: 50;
                position: relative;
                background: white !important;
                width: 100%;
                box-sizing: border-box;
                min-height: auto;
            }
            .page-title {
                font-size: 1.1rem;
                display: block !important;
            }
            #header-icon {
                display: block !important;
            }
            #topbar-time {
                position: relative !important;
                left: auto !important;
                transform: none !important;
                order: 3;
                width: 100%;
                text-align: center;
                margin-top: 5px;
                display: block !important;
                color: #2d3436 !important;
            }
            .status-badge {
                margin-left: auto;
                display: flex !important;
            }
        }
    </style>
    <style>
        /* Sub Vendo Device Modal Responsive Styles */
        .subvendo-form-grid {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-col-span-2 {
            grid-column: span 2;
        }
        @media (max-width: 768px) {
            .subvendo-form-grid {
                /* Keep 2 columns like desktop, but compact gaps */
                grid-template-columns: 1fr 1fr; 
                padding: 10px;
                gap: 8px;
            }
            .form-col-span-2 {
                /* Keep spanning 2 columns like desktop */
                grid-column: span 2;
            }
            /* Make labels and inputs more compact */
            .subvendo-form-grid label {
                font-size: 0.75rem !important;
                margin-bottom: 2px !important;
            }
            .subvendo-form-grid input,
            .subvendo-form-grid select {
                padding: 6px 8px !important;
                font-size: 14px; /* Slightly smaller but readable */
                height: auto;
            }
            .subvendo-form-grid textarea {
                padding: 6px 8px !important;
                min-height: 60px !important;
            }
        }
    </style>
</head>
<body>


    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spin" style="width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%;"></div>
    </div>

    <!-- Login -->
    <div id="login-screen">
        <img src="/neofi_nb.png" alt="NeoFi Logo" style="max-width: 200px; margin-bottom: 20px;">
        <div class="login-box">
            <h2 style="margin-bottom: 20px; color: var(--dark);">Admin Access</h2>
            <label for="username" style="display:none;">Username</label>
            <input type="text" id="username" class="login-input" placeholder="Username" autocomplete="username">
            <label for="password" style="display:none;">Password</label>
            <input type="password" id="password" class="login-input" placeholder="Password" autocomplete="current-password">
            <div style="text-align:right; margin-bottom:15px;">
                <a href="/forgot.html" style="font-size:0.85rem; color:#0984e3; text-decoration:none;">Forgot Password?</a>
            </div>
            <button onclick="login()" class="login-btn">Secure Login</button>
            <p id="login-error" style="color:#e74c3c; font-size:0.85rem; margin-top:15px;"></p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-ui" style="display:none; width: 100%; height: 100%;">
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="/neofi_logo.png" alt="NeoFi" style="height: 40px; max-width: 100%; object-fit: contain;">
                <div style="font-size: 0.7rem; color: #b2bec3; align-self: center;">V1.0</div>
            </div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('dashboard')">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    Dashboard
                </div>
                <div class="menu-item" onclick="nav('interfaces')">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                    Interfaces
                </div>
                <div class="menu-item" onclick="nav('pppoe')">
                    <svg viewBox="0 0 24 24"><path d="M18 13h-.68l-2 2h1.91L19 17H5l1.78-2h2.05l-2-2H6l-3 3v4c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2v-4l-3-3zm-1-5.05l-4.95 4.95-3.54-3.54 4.95-4.95L17 7.95zm-4.24-5.66L6.39 8.66c-.39.39-.39 1.02 0 1.41l4.95 4.95c.39.39 1.02.39 1.41 0l6.36-6.36c.39-.39.39-1.02 0-1.41L14.16 2.29c-.39-.39-1.02-.39-1.41 0z"/></svg>
                    PPPOE
                </div>
                <div class="menu-item" onclick="nav('voucher')">
                    <svg viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
                    Vouchers
                </div>
                <div class="menu-item" onclick="nav('rates')">
                    <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                    Rates
                </div>
                <div class="menu-item" onclick="nav('network')">
                    <svg viewBox="0 0 24 24"><path d="M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    Network
                </div>
                <div class="menu-item" onclick="nav('qos')">
                    <svg viewBox="0 0 24 24"><path d="M3 17h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V5H3z"/></svg>
                    QoS
                </div>
                <div class="menu-item" onclick="nav('firewall')">
                    <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zM12 22C7.31 20.78 4 16.03 4 11V6.3l8-3.56 8 3.56V11c0 5.03-3.31 9.78-8 11zM11 7h2v2h-2zm0 4h2v6h-2z"/></svg>
                    AdBlocker
                </div>
                <div class="menu-item" onclick="nav('subvendo')">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H9v-2h6v2zm-3-7l-2.5-3.48L12 6l2.5 1.52L12 11zm3 2h-6v-2h6v2z"/></svg>
                    Sub Vendo
                </div>
                <div class="menu-item" onclick="nav('portal')">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    Portal
                </div>
                <div class="menu-item" onclick="nav('syslogs')">
                    <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    Logs
                </div>
                <div class="menu-item" onclick="nav('devices')">
                    <svg viewBox="0 0 24 24"><path d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z"/></svg>
                    Devices
                </div>
                <div class="menu-item" onclick="nav('chat')">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
                    Chat
                </div>
                <div class="menu-item" onclick="nav('sales')">
                    <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                    Sales
                </div>
                <div class="menu-item" onclick="nav('settings')">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84a.484.484 0 0 0-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22L2.74 8.87a.49.49 0 0 0 .12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.27.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    Settings
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <svg viewBox="0 0 24 24" style="width:18px; fill:white;"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                    Logout
                </button>
                <div style="font-size: 0.7rem; color: #b2bec3; margin-top: 10px; text-align: center;">Developed By: CJTECH</div>
            </div>
        </div>

        <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="topbar">
                <div style="display:flex; align-items:center;">
                    <div class="mobile-toggle" onclick="toggleSidebar()">
                        <svg viewBox="0 0 24 24" style="width:24px;"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                    </div>
                    <!-- Dashboard Icon -->
                    <svg viewBox="0 0 24 24" style="width:24px; height:24px; margin-right:8px; fill:var(--dark); display:block;" id="header-icon">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                    <div class="page-title" id="page-title">Dashboard</div>
                </div>
                
                <!-- System Time Display -->
                <div id="topbar-time" style="font-size: 0.9rem; font-weight: 600; color: #2d3436; position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; display: none;">
                    --:--:--
                </div>

                <div id="chart-warning" style="display:none; color: white; background: #f72585; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-right: 10px;">
                    Offline Mode: Charts Disabled
                </div>
                <div class="status-badge" style="white-space: nowrap; z-index: 10;">
                    <div class="status-dot"></div> System Online
                </div>
            </div>

            <div class="content-scroll">
                
                <div id="pull-to-refresh">
                    <svg class="ptr-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    <span class="ptr-text" style="margin-left:8px;">Pull to refresh</span>
                </div>

                <!-- VIEW: Dashboard -->
                <div id="view-dashboard" class="view-section">
                    
                    <div class="grid-2">
                        <!-- System Info -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">System Info</div>
                            </div>
                            <div class="info-row"><span class="info-label">Device Model</span><span class="info-value" id="board-model">Loading...</span></div>
                            <div class="info-row"><span class="info-label">System</span><span class="info-value">Ubuntu / Armbian</span></div>
                            <div class="info-row"><span class="info-label">CPU Temp</span><span class="info-value" id="cpu-temp">--Â°C</span></div>
                            <div class="info-row"><span class="info-label">RAM Usage</span><span class="info-value" id="ram-usage">-- / -- MB</span></div>
                            <div class="info-row"><span class="info-label">Storage</span><span class="info-value" id="storage-usage">-- / -- GB</span></div>
                            <div class="info-row"><span class="info-label">Uptime</span><span class="info-value" id="uptime">--</span></div>
                        </div>

                        <!-- CPU Chart -->
                        <div class="card" style="display:flex; flex-direction:column;">
                            <div class="card-header" style="margin-bottom:5px;">
                                <div class="card-title">CPU Usage</div>
                            </div>
                            
                            <div style="display:flex; align-items:center; justify-content:center; gap:25px; width:100%;">
                                <!-- Left: Details -->
                                <div id="cpu-details" style="font-size:0.85rem; color:#2d3436; font-weight:600; line-height:1.4;">
                                    <!-- Dynamic Content -->
                                    <div>Loading...</div>
                                </div>

                                <!-- Right: Chart -->
                                <div style="width:140px; height:140px; position:relative;">
                                    <canvas id="cpuChart"></canvas>
                                    <div style="position:absolute; top:60%; left:50%; transform:translate(-50%, -50%); text-align:center; pointer-events:none;">
                                        <div style="font-size:0.7rem; color:#636e72; font-weight:600;">CPU</div>
                                        <div id="cpu-total-val" style="font-size:1.1rem; font-weight:800; color:#2d3436;">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Cards -->
                    <div class="grid-4">
                        <div class="card rev-card">
                            <div class="card-title">Daily Revenue</div>
                            <div class="rev-value" id="sales-daily">â‚±0.00</div>
                            <div class="rev-label">Today</div>
                            <svg class="rev-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.47.33 2.65 1.1 2.88 3.11h-1.95c-.19-1.12-.94-1.65-2.26-1.65-1.5 0-2.35.71-2.35 1.5 0 .84.61 1.43 2.76 1.95 2.19.53 4.1 1.46 4.1 3.97 0 1.92-1.46 3.19-3.27 3.56z"/></svg>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">Weekly Revenue</div>
                            <div class="rev-value" id="sales-weekly">â‚±0.00</div>
                            <div class="rev-label">Last 7 Days</div>
                            <svg class="rev-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.47.33 2.65 1.1 2.88 3.11h-1.95c-.19-1.12-.94-1.65-2.26-1.65-1.5 0-2.35.71-2.35 1.5 0 .84.61 1.43 2.76 1.95 2.19.53 4.1 1.46 4.1 3.97 0 1.92-1.46 3.19-3.27 3.56z"/></svg>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">Monthly Revenue</div>
                            <div class="rev-value" id="sales-monthly">â‚±0.00</div>
                            <div class="rev-label">This Month</div>
                            <svg class="rev-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.47.33 2.65 1.1 2.88 3.11h-1.95c-.19-1.12-.94-1.65-2.26-1.65-1.5 0-2.35.71-2.35 1.5 0 .84.61 1.43 2.76 1.95 2.19.53 4.1 1.46 4.1 3.97 0 1.92-1.46 3.19-3.27 3.56z"/></svg>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">Yearly Revenue</div>
                            <div class="rev-value" id="sales-yearly">â‚±0.00</div>
                            <div class="rev-label">This Year</div>
                            <svg class="rev-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.47.33 2.65 1.1 2.88 3.11h-1.95c-.19-1.12-.94-1.65-2.26-1.65-1.5 0-2.35.71-2.35 1.5 0 .84.61 1.43 2.76 1.95 2.19.53 4.1 1.46 4.1 3.97 0 1.92-1.46 3.19-3.27 3.56z"/></svg>
                        </div>
                    </div>

                    <!-- Bandwidth Chart -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">Traffic Overview</div>
                        </div>
                        <div style="height: 300px; width: 100%; position: relative;">
                            <canvas id="bandwidthChart"></canvas>
                            <div id="bw-text-fallback" style="display:none; text-align:center; padding-top:100px; font-weight:bold; font-size:1.2rem;">
                                Waiting for data...
                            </div>
                        </div>
                        
                        <div class="bw-stats-container">
                            <table class="bw-table">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;"></th>
                                        <th>MINIMUM</th>
                                        <th>MAXIMUM</th>
                                        <th>AVERAGE</th>
                                        <th>LAST</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="bw-row-name">
                                                <span class="legend-box" style="background:#0984e3;"></span> Output (Upload)
                                            </div>
                                        </td>
                                        <td id="tx-min">0 Mbps</td>
                                        <td id="tx-max">0 Mbps</td>
                                        <td id="tx-avg">0 Mbps</td>
                                        <td id="tx-last">0 Mbps</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="bw-row-name">
                                                <span class="legend-box" style="background:#00b894;"></span> Input (Download)
                                            </div>
                                        </td>
                                        <td id="rx-min">0 Mbps</td>
                                        <td id="rx-max">0 Mbps</td>
                                        <td id="rx-avg">0 Mbps</td>
                                        <td id="rx-last">0 Mbps</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>





                </div>

                <!-- VIEW: Rates -->
                <div id="view-rates" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Coin Rates Configuration</div>
                            <button class="btn btn-sm btn-primary" onclick="openRateModal()">+ Add Rate</button>
                        </div>
                        <div class="table-container">
                            <table id="rates-table">
                                <thead>
                                    <tr>
                                        <th>Amount (â‚±)</th>
                                        <th>Duration</th>
                                        <th>Speed (UL/DL)</th>
                                        <th>Type</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Rate Modal -->
                <div id="rate-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
                    <div style="background:#fff; width:95%; max-width:400px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
                        <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff;">
                            Manage Rate
                        </div>
                        <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                            <input type="hidden" id="rate-id">
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px;">Coin Amount (â‚±)</label>
                                <input type="number" id="rate-amount" class="login-input" placeholder="1, 5, 10" style="margin:0;">
                            </div>
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px;">Duration</label>
                                <div style="display:flex; gap:5px;">
                                    <div style="flex:1;">
                                        <input type="number" id="rate-days" placeholder="0" min="0" value="0" class="login-input" style="margin:0; text-align:center;">
                                        <div style="font-size:0.7rem; color:#666; text-align:center;">Days</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="rate-hours" placeholder="0" min="0" value="0" class="login-input" style="margin:0; text-align:center;">
                                        <div style="font-size:0.7rem; color:#666; text-align:center;">Hrs</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="rate-minutes" placeholder="0" min="0" value="15" class="login-input" style="margin:0; text-align:center;">
                                        <div style="font-size:0.7rem; color:#666; text-align:center;">Mins</div>
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1;">
                                    <label style="display:block; font-weight:600; margin-bottom:4px;">Upload (Mbps)</label>
                                    <input type="number" id="rate-ul" class="login-input" value="5" step="0.1" style="margin:0;">
                                </div>
                                <div style="flex:1;">
                                    <label style="display:block; font-weight:600; margin-bottom:4px;">Download (Mbps)</label>
                                    <input type="number" id="rate-dl" class="login-input" value="5" step="0.1" style="margin:0;">
                                </div>
                            </div>
                            <div>
                                 <div style="display:flex; align-items:center; height:40px;">
                                    <input type="checkbox" id="rate-pausable" checked style="margin-right:10px; transform:scale(1.2);">
                                    <label for="rate-pausable">Allow Pause?</label>
                                </div>
                            </div>
                        </div>
                        <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
                            <button class="btn btn-sm btn-danger" onclick="document.getElementById('rate-modal').style.display = 'none'">Cancel</button>
                            <button class="btn btn-sm btn-success" onclick="saveRate()">Save Rate</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Sales -->
                <div id="view-sales" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Sales History</div>
                            <div style="display:flex; flex-wrap:wrap; gap:5px;">
                                <button class="btn btn-sm btn-primary" onclick="loadSalesData('daily')">Daily</button>
                                <button class="btn btn-sm" style="background:#eee;" onclick="loadSalesData('weekly')">Weekly</button>
                                <button class="btn btn-sm" style="background:#eee;" onclick="loadSalesData('monthly')">Monthly</button>
                                <button class="btn btn-sm" style="background:#eee;" onclick="loadSalesData('yearly')">Yearly</button>
                                <button class="btn btn-sm" style="background:#eee;" onclick="loadSalesData('history')">All Transactions</button>
                            </div>
                        </div>
                        <div style="overflow-x:auto;">
                            <table id="sales-table">
                                <thead><tr><th>Date</th><th>Amount</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">SALES BY VENDO</div>
                        </div>
                        <div style="overflow-x:auto;">
                            <table id="sales-by-device-table">
                                <thead><tr><th>Device</th><th>Total</th><th>Daily</th><th>Un Coins-Out</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Interfaces -->
                <div id="view-interfaces" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Network Interfaces</div>
                            <button class="btn btn-sm btn-primary" onclick="loadInterfaces()">Refresh</button>
                        </div>
                        <div class="table-container">
                            <table id="interfaces-table">
                                <thead>
                                    <tr>
                                        <th>Interface</th>
                                        <th>IP Address</th>
                                        <th>MAC Address</th>
                                        <th>Netmask</th>
                                        <th>Family</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PPPOE -->
                <div id="view-pppoe" class="view-section" style="display:none;">
                                    <div class="card">
                    <div class="card-header">
                        <div class="card-title">PPPoE Server Configuration</div>
                    </div>
                    <div style="padding:20px;">
                        <!-- Global Config -->
                        <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h4 style="margin:0;">Server Settings</h4>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="pppoe-server-enabled">
                                    <label class="form-check-label" for="pppoe-server-enabled">Enable Server</label>
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:5px;">Interface</label>
                                    <select id="pppoe-server-iface" class="login-input" style="width:100%; background:white;">
                                        <option value="br0">br0</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:5px;">Local IP (Server)</label>
                                    <input type="text" id="pppoe-server-local-ip" class="login-input" placeholder="10.10.10.1">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:5px;">Remote IP Start</label>
                                    <input type="text" id="pppoe-server-remote-start" class="login-input" placeholder="10.10.10.2">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:5px;">IP Pool Count</label>
                                    <input type="number" id="pppoe-server-count" class="login-input" placeholder="50">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:5px;">DNS 1</label>
                                    <input type="text" id="pppoe-server-dns1" class="login-input" placeholder="8.8.8.8">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:5px;">DNS 2</label>
                                    <input type="text" id="pppoe-server-dns2" class="login-input" placeholder="8.8.4.4">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="savePppoeServerConfig()" style="margin-top:15px;">Save & Restart Server</button>
                        </div>

                        <!-- Profile Management (Drawer) -->
                        <div class="card" id="pppoe-profiles-card" style="margin-bottom:20px;">
                            <div class="card-header drawer-header" onclick="toggleDrawer('pppoe-profiles-card')">
                                <div class="card-title">Server Profiles</div>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); openPppoeProfileModal()">+ Add Profile</button>
                                    <svg class="drawer-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                                </div>
                            </div>
                            <div class="drawer-content">
                                <div id="pppoe-profiles-list" style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                                    <!-- JS populated -->
                                </div>
                            </div>
                        </div>

                        <!-- User Management (Drawer) -->
                        <div class="card" id="pppoe-users-card" style="margin-bottom:20px;">
                            <div class="card-header drawer-header" onclick="toggleDrawer('pppoe-users-card')">
                                <div class="card-title">PPPoE Users List</div>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); openPppoeUserModal()">+ Add User</button>
                                    <svg class="drawer-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                                </div>
                            </div>
                            <div class="drawer-content">
                                <div id="pppoe-users-all-list" style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                                    <!-- JS populated -->
                                </div>
                            </div>
                        </div>

                        <!-- Connection Status (Drawer) -->
                        <div class="card" id="pppoe-status-card" style="margin-bottom:20px;">
                            <div class="card-header drawer-header" onclick="toggleDrawer('pppoe-status-card')">
                                <div class="card-title">Connection Status</div>
                                <svg class="drawer-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                            </div>
                            <div class="drawer-content">
                                <div style="padding:15px;">
                                    <h5 style="color:#00b894; margin-bottom:10px; border-bottom: 2px solid #00b894; padding-bottom: 5px;">Active Connections</h5>
                                    <div id="pppoe-users-online-list" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                                        <!-- JS populated -->
                                    </div>

                                    <h5 style="color:#636e72; margin-bottom:10px; border-bottom: 2px solid #636e72; padding-bottom: 5px;">Offline Connections</h5>
                                    <div id="pppoe-users-offline-list" style="display:flex; flex-direction:column; gap:10px;">
                                        <!-- JS populated -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PPPoE User Modal -->
                <div id="pppoe-user-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                    <div style="background:white; padding:20px; border-radius:8px; width:400px; max-width:90%;">
                        <h3 id="pppoe-modal-title" style="margin-top:0;">Add PPPoE User</h3>
                        <input type="hidden" id="pppoe-user-id">
                        
                        <div style="margin-bottom:10px;">
                            <label>Username</label>
                            <input type="text" id="pppoe-modal-user" class="login-input" style="width:100%;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Password</label>
                            <input type="text" id="pppoe-modal-pass" class="login-input" style="width:100%;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Profile</label>
                            <select id="pppoe-modal-profile" class="login-input" style="width:100%;">
                                <option value="">No Profile (Unlimited)</option>
                            </select>
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Expiration (YYYY-MM-DD)</label>
                            <input type="date" id="pppoe-modal-expiry" class="login-input" style="width:100%;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Status</label>
                            <select id="pppoe-modal-active" class="login-input" style="width:100%;">
                                <option value="1">Active</option>
                                <option value="0">Disabled</option>
                            </select>
                        </div>

                        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                            <button class="btn btn-danger" onclick="closePppoeUserModal()">Cancel</button>
                            <button class="btn btn-success" onclick="savePppoeUser()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- PPPoE Profile Modal -->
                <div id="pppoe-profile-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                    <div style="background:white; padding:20px; border-radius:8px; width:400px; max-width:90%;">
                        <h3 id="pppoe-profile-modal-title" style="margin-top:0;">Add PPPoE Profile</h3>
                        <input type="hidden" id="pppoe-profile-id">
                        
                        <div style="margin-bottom:10px;">
                            <label>Profile Name</label>
                            <input type="text" id="pppoe-profile-name" class="login-input" style="width:100%;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Upload Limit (Mbps)</label>
                            <input type="number" id="pppoe-profile-rate-up" class="login-input" style="width:100%;" placeholder="0 for unlimited" step="0.1">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Download Limit (Mbps)</label>
                            <input type="number" id="pppoe-profile-rate-down" class="login-input" style="width:100%;" placeholder="0 for unlimited" step="0.1">
                        </div>

                        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                            <button class="btn btn-danger" onclick="closePppoeProfileModal()">Cancel</button>
                            <button class="btn btn-success" onclick="savePppoeProfile()">Save</button>
                        </div>
                    </div>
                </div>
                </div>

                <!-- VIEW: Voucher -->
                <div id="view-voucher" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Voucher Management</div>
                            <div style="display:flex; gap:10px;">
                                <button id="btn-delete-selected" class="btn btn-sm btn-danger" style="display:none;" onclick="deleteSelectedVouchers()">Delete Selected</button>
                                <button class="btn btn-sm btn-primary" onclick="openVoucherModal()">Generate Voucher</button>
                            </div>
                        </div>
                        <div style="padding: 10px; display:flex; justify-content:space-between; align-items:center;">
                            <div style="color:var(--text-color);">Show <select id="voucher-entries" style="padding:5px; border-radius:4px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color);"><option>10</option><option>100</option></select> entries</div>
                            <div style="color:var(--text-color);"><label for="voucher-search">Search: </label><input type="text" id="voucher-search" autocomplete="off" style="padding:5px; border:1px solid var(--border-color); border-radius:4px; background:var(--card-bg); color:var(--text-color);"></div>
                        </div>
                        <div style="overflow-x:auto;">
                            <table id="voucher-table" style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background:var(--bg-color); text-align:left;">
                                        <th style="padding:10px;"><input type="checkbox" id="select-all-vouchers" onclick="toggleSelectAll(this)"></th>
                                        <th style="padding:10px;">Code</th>
                                        <th style="padding:10px;">Duration</th>
                                        <th style="padding:10px;">Plan</th>
                                        <th style="padding:10px;">Price</th>
                                        <th style="padding:10px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody style="color:var(--text-color);"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ACTIVE CODES Card -->
                    <div class="card" style="margin-top: 25px;">
                        <div class="card-header">
                            <div class="card-title">ACTIVE CODES (Sessions)</div>
                            <button class="btn btn-sm btn-primary" onclick="loadActiveCodes()">Refresh</button>
                        </div>
                        <div style="overflow-x:auto;">
                            <table id="active-codes-table" style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background:#f8f9fa; text-align:left;">
                                        <th style="padding:10px;">Code</th>
                                        <th style="padding:10px;">MAC Address</th>
                                        <th style="padding:10px;">IP Address</th>
                                        <th style="padding:10px;">Interface</th>
                                        <th style="padding:10px;">Client Name</th>
                                        <th style="padding:10px;">Time Remaining</th>
                                        <th style="padding:10px;">Traffic (DL/UP)</th>
                                        <th style="padding:10px;">Idle Countdown</th>
                                        <th style="padding:10px;">Status</th>
                                        <th style="padding:10px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody style="color:var(--text-main);"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Voucher Modal (Symmetrical Card) -->
                <div id="voucher-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                    <div style="background:#fff; width:95%; max-width:420px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
                        <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10;">
                            Generate Voucher
                        </div>
                        <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            
                            <!-- Full Width: Plan -->
                            <div style="grid-column: span 2;">
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Plan</label>
                                <select id="v-plan" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333;">
                                    <option value="Standard">Standard</option>
                                </select>
                            </div>

                            <!-- Row: Qty | Type -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Quantity</label>
                                <input type="number" id="v-qty" value="1" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Type</label>
                                <select id="v-type" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333;">
                                    <option value="Pausable">Pausable</option>
                                    <option value="One-Time">One-Time</option>
                                </select>
                            </div>

                            <!-- Row: Duration | Price -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Duration</label>
                                <div style="display:flex; gap:5px;">
                                    <div style="flex:1;">
                                        <input type="number" id="v-days" placeholder="0" min="0" value="0" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box; text-align:center;">
                                        <div style="font-size:0.7rem; color:#666; text-align:center;">Days</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="v-hours" placeholder="0" min="0" value="1" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box; text-align:center;">
                                        <div style="font-size:0.7rem; color:#666; text-align:center;">Hrs</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="v-minutes" placeholder="0" min="0" value="0" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box; text-align:center;">
                                        <div style="font-size:0.7rem; color:#666; text-align:center;">Mins</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Price (â‚±)</label>
                                <input type="number" id="v-price" placeholder="0.00" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box;">
                            </div>

                            <!-- Row: Upload | Download -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Upload (Mbps)</label>
                                <input type="number" id="v-ul" value="2" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Download (Mbps)</label>
                                <input type="number" id="v-dl" value="2" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box;">
                            </div>

                            <!-- Section Header -->
                            <div style="grid-column: span 2; margin-top:5px; border-bottom:1px solid #eee; padding-bottom:5px; font-weight:bold; color:#666; font-size:0.9rem;">
                                Code Options
                            </div>

                            <!-- Row: Prefix | Length -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Prefix</label>
                                <input type="text" id="v-prefix" placeholder="Optional" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Length</label>
                                <input type="number" id="v-length" value="6" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box;">
                            </div>

                            <!-- Random Toggle -->
                            <div style="grid-column: span 2; display:flex; align-items:center; justify-content:space-between; background:#f9f9f9; padding:8px; border-radius:4px;">
                                <label for="v-random" style="font-weight:600; font-size:0.85rem; cursor:pointer;">Randomize Code?</label>
                                <input type="checkbox" id="v-random" checked onchange="toggleCustomVoucher()" style="transform:scale(1.2);">
                            </div>

                            <!-- Custom Code (Full Width) -->
                            <div style="grid-column: span 2;">
                                <input type="text" id="v-custom" placeholder="Enter Custom Code (Uncheck Random first)" disabled style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9; color:#333; opacity:0.7; box-sizing:border-box;">
                            </div>

                            <!-- Plan Name (Full Width) -->
                            <div style="grid-column: span 2;">
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Plan Name</label>
                                <input type="text" id="v-name" placeholder="e.g. 1 Hour Standard" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff; color:#333; box-sizing:border-box;">
                            </div>

                        </div>
                        <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fff; position:sticky; bottom:0; z-index:10;">
                            <button class="btn" style="background:#ff4757; color:white; padding:8px 15px; border:none; border-radius:4px; font-size:0.9rem;" onclick="closeVoucherModal()">Close</button>
                            <button class="btn" style="background:#2ed573; color:white; padding:8px 15px; border:none; border-radius:4px; font-size:0.9rem;" onclick="generateVouchers()">Generate</button>
                        </div>
                    </div>
                </div>



                <!-- QoS Limit Modal -->
                <div id="qos-limit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                    <div style="background:#fff; width:90%; max-width:400px; padding:20px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                        <h3 style="margin-top:0;">Edit Bandwidth Limit</h3>
                        <p id="qos-modal-ip" style="color:#666; font-size:0.9rem; margin-bottom:15px;"></p>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block; font-weight:600; margin-bottom:5px;">Download Limit (Mbps)</label>
                            <input type="number" id="qos-edit-dl" class="login-input" style="width:100%; margin:0;">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="display:block; font-weight:600; margin-bottom:5px;">Upload Limit (Mbps)</label>
                            <input type="number" id="qos-edit-ul" class="login-input" style="width:100%; margin:0;">
                        </div>
                        
                        <div style="display:flex; justify-content:flex-end; gap:10px;">
                            <button class="btn btn-sm btn-danger" onclick="document.getElementById('qos-limit-modal').style.display='none'">Cancel</button>
                            <button class="btn btn-sm btn-success" onclick="saveQosLimit()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Network -->
                <div id="view-network" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header" style="margin-bottom: 10px;">
                            <div class="card-title">WAN Configuration</div>
                        </div>
                        <div>
                            <div class="grid-2" style="gap: 15px; margin-bottom: 15px;">
                                <div id="wan-interface-group">
                                    <label for="wan-interface" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">WAN Interface</label>
                                    <select id="wan-interface" class="login-input" style="margin:0; width:100%; max-width:400px;" autocomplete="off">
                                        <option value="" disabled selected>Loading interfaces...</option>
                                    </select>
                                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">
                                        Select the physical interface connected to your internet source.
                                    </div>
                                </div>
                                <div>
                                    <label for="wan-mode" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Connection Mode</label>
                                    <select id="wan-mode" class="login-input" style="margin:0; width:100%; max-width:400px;" onchange="toggleWanMode()" autocomplete="off">
                                        <option value="dynamic">Dynamic (DHCP)</option>
                                        <option value="static">Static IP</option>
                                        <option value="pppoe">PPPoE</option>
                                        <option value="dual_wan">Dual WAN Smart Loadbalancing</option>
                                        <option value="multi_wan">Multiple WAN Smart Loadbalancing</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Dynamic Info -->
                            <div id="mode-dynamic" class="wan-mode-section" style="padding:10px; background:var(--light); border-radius:8px; margin-top:10px;">
                                <div style="display:flex; gap:10px; align-items:center; color:var(--success);">
                                    <svg viewBox="0 0 24 24" style="width:20px; fill:currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                    <span style="font-weight:600;">Automatic Configuration</span>
                                </div>
                                <p style="font-size:0.9rem; color:var(--text-muted); margin:5px 0 0 30px;">
                                    The system will automatically obtain an IP address from your ISP or upstream router.
                                </p>
                            </div>

                            <!-- Static Config -->
                            <div id="mode-static" class="wan-mode-section" style="display:none; margin-top:10px;">
                                <div class="form-grid" style="align-items: start;">
                                    <!-- Left Column -->
                                    <div style="display:flex; flex-direction:column; gap:10px;">
                                        <div>
                                            <label for="wan-ip" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">IP Address</label>
                                            <input type="text" id="wan-ip" class="login-input" placeholder="192.168.1.2" style="margin:0;" autocomplete="off">
                                        </div>
                                        <div>
                                            <label for="wan-gateway" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Gateway</label>
                                            <input type="text" id="wan-gateway" class="login-input" placeholder="192.168.1.1" style="margin:0;" autocomplete="off">
                                        </div>
                                        <div>
                                            <label for="wan-dns1" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">DNS 1</label>
                                            <input type="text" id="wan-dns1" class="login-input" placeholder="8.8.8.8" style="margin:0;" autocomplete="off">
                                        </div>
                                    </div>
                                    
                                    <!-- Right Column -->
                                    <div style="display:flex; flex-direction:column; gap:10px;">
                                        <div>
                                            <label for="wan-netmask" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Netmask</label>
                                            <input type="text" id="wan-netmask" class="login-input" placeholder="255.255.255.0" style="margin:0;" autocomplete="off">
                                        </div>
                                        <div>
                                            <label for="wan-dns2" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">DNS 2 (Optional)</label>
                                            <input type="text" id="wan-dns2" class="login-input" placeholder="8.8.4.4" style="margin:0;" autocomplete="off">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PPPoE Config -->
                            <div id="mode-pppoe" class="wan-mode-section" style="display:none; margin-top:10px;">
                                <div class="form-grid" style="align-items: start;">
                                    <!-- Left Column -->
                                    <div style="display:flex; flex-direction:column; gap:10px;">
                                        <div>
                                            <label for="pppoe-user" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Username</label>
                                            <input type="text" id="pppoe-user" class="login-input" placeholder="ISP Username" style="margin:0;" autocomplete="username">
                                        </div>
                                        <div>
                                            <label for="pppoe-dns1" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">DNS 1 (Optional)</label>
                                            <input type="text" id="pppoe-dns1" class="login-input" placeholder="8.8.8.8" style="margin:0;">
                                        </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div style="display:flex; flex-direction:column; gap:10px;">
                                        <div>
                                            <label for="pppoe-pass" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Password</label>
                                            <input type="password" id="pppoe-pass" class="login-input" placeholder="ISP Password" style="margin:0;" autocomplete="current-password">
                                        </div>
                                        <div>
                                            <label for="pppoe-dns2" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">DNS 2 (Optional)</label>
                                            <input type="text" id="pppoe-dns2" class="login-input" placeholder="8.8.4.4" style="margin:0;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dual WAN Config -->
                            <div id="mode-dual_wan" class="wan-mode-section" style="display:none; margin-top:10px;">
                                <div style="margin-bottom:15px; padding:15px; background:var(--light); border-radius:8px;">
                                    <label style="display:block; font-weight:600; margin-bottom:5px;">Load Balancing Strategy</label>
                                    <select id="dual-strategy" class="login-input" style="max-width:300px;">
                                        <option value="balance-rr">Weighted Round Robin (Balance Traffic)</option>
                                        <option value="failover">Failover (Primary/Backup)</option>
                                    </select>
                                    <div style="font-size:0.85rem; color:var(--text-muted); margin-top:5px;">
                                        <b>Round Robin:</b> Distributes traffic across both connections. <b>Failover:</b> Uses Secondary only if Primary fails.
                                    </div>
                                </div>

                                <div class="form-grid" style="align-items:start;">
                                    <!-- WAN 1 -->
                                    <div class="card" style="padding:20px; border:1px solid var(--border); box-shadow:none;">
                                        <div style="font-weight:700; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">WAN 1 (Primary)</div>
                                        
                                        <label style="font-weight:600; font-size:0.9rem;">Interface</label>
                                        <select id="dual-wan1-iface" class="login-input wan-iface-select"></select>
                                        
                                        <label style="font-weight:600; font-size:0.9rem; margin-top:10px;">Connection Type</label>
                                        <select id="dual-wan1-type" class="login-input" onchange="toggleDualWanFields('wan1')">
                                            <option value="dynamic">Dynamic (DHCP)</option>
                                            <option value="static">Static IP</option>
                                            <option value="pppoe">PPPoE</option>
                                        </select>

                                        <!-- Static Fields -->
                                        <div id="dual-wan1-static-fields" style="display:none; margin-top:10px;">
                                            <input id="dual-wan1-ip" placeholder="IP Address" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan1-gateway" placeholder="Gateway" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan1-netmask" placeholder="Netmask" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan1-dns" placeholder="DNS" class="login-input">
                                        </div>
                                        
                                        <!-- PPPoE Fields -->
                                        <div id="dual-wan1-pppoe-fields" style="display:none; margin-top:10px;">
                                            <input id="dual-wan1-user" placeholder="Username" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan1-pass" placeholder="Password" type="password" class="login-input">
                                        </div>
                                    </div>

                                    <!-- WAN 2 -->
                                    <div class="card" style="padding:20px; border:1px solid var(--border); box-shadow:none;">
                                        <div style="font-weight:700; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">WAN 2 (Secondary)</div>
                                        
                                        <label style="font-weight:600; font-size:0.9rem;">Interface</label>
                                        <select id="dual-wan2-iface" class="login-input wan-iface-select"></select>
                                        
                                        <label style="font-weight:600; font-size:0.9rem; margin-top:10px;">Connection Type</label>
                                        <select id="dual-wan2-type" class="login-input" onchange="toggleDualWanFields('wan2')">
                                            <option value="dynamic">Dynamic (DHCP)</option>
                                            <option value="static">Static IP</option>
                                            <option value="pppoe">PPPoE</option>
                                        </select>

                                        <!-- Static Fields -->
                                        <div id="dual-wan2-static-fields" style="display:none; margin-top:10px;">
                                            <input id="dual-wan2-ip" placeholder="IP Address" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan2-gateway" placeholder="Gateway" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan2-netmask" placeholder="Netmask" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan2-dns" placeholder="DNS" class="login-input">
                                        </div>
                                        
                                        <!-- PPPoE Fields -->
                                        <div id="dual-wan2-pppoe-fields" style="display:none; margin-top:10px;">
                                            <input id="dual-wan2-user" placeholder="Username" class="login-input" style="margin-bottom:5px;">
                                            <input id="dual-wan2-pass" placeholder="Password" type="password" class="login-input">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Multi WAN Config -->
                            <div id="mode-multi_wan" class="wan-mode-section" style="display:none; margin-top:10px;">
                                <div class="card" style="padding:20px; border:1px solid var(--border); box-shadow:none;">
                                    <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-weight:700; color:var(--primary);">Multiple WAN Interfaces</div>
                                            <div style="font-size:0.85rem; color:var(--text-muted);">Add multiple internet sources for advanced load balancing.</div>
                                        </div>
                                        <button class="btn btn-sm btn-success" onclick="addMultiWanRow()">+ Add WAN Interface</button>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table" id="multi-wan-table">
                                            <thead>
                                                <tr>
                                                    <th>Interface</th>
                                                    <th>Type</th>
                                                    <th>Weight</th>
                                                    <th>Details</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Populated via JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top:10px; font-size:0.8rem; color:var(--text-muted); font-style:italic;">
                                        * Use "Weight" to distribute traffic (e.g., 2:1 ratio). Higher weight = more traffic.
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                                <div id="wan-status" class="status-indicator">
                                    <div class="status-dot"></div>
                                    <span id="wan-status-text">Checking...</span>
                                </div>
                                <button class="btn btn-primary" onclick="saveNetworkConfig()">Save Changes</button>
                            </div>
                        </div>
                    </div>

                    <!-- ZeroTier Configuration -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">ZeroTier Configuration</div>
                            <div id="zt-status-badge" class="status-badge" style="background:#b2bec3; font-size:0.7rem;">Checking...</div>
                        </div>
                        <div class="form-grid" style="align-items: end; gap:10px;">
                            <div style="flex-grow:1;">
                                <label style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Join Network</label>
                                <input type="text" id="zt-network-id" class="login-input" placeholder="Network ID (16 chars)" style="margin:0;">
                            </div>
                            <button class="btn btn-primary" onclick="joinZeroTier()" style="height:38px; margin-bottom:2px;">Join</button>
                        </div>
                        
                        <div id="zt-info-area" style="margin-top:15px; display:none;">
                            <div class="info-row"><span class="info-label">Version</span><span class="info-value" id="zt-version">--</span></div>
                            <div class="info-row"><span class="info-label">Device ID</span><span class="info-value" id="zt-device-id">--</span></div>
                            <div class="info-row"><span class="info-label">Status</span><span class="info-value" id="zt-status-text">--</span></div>
                        </div>

                        <!-- Networks List -->
                        <div id="zt-networks-list" style="margin-top:15px;">
                            <!-- Populated via JS -->
                        </div>
                    </div>

                    <!-- DHCP Server -->
                    <div class="card" style="margin-top: 20px; background:#f8fafc;">
                        <div class="card-header">
                            <div class="card-title">DHCP Server</div>
                            <button class="btn btn-sm btn-primary" onclick="openDhcpModal()">+ Add DHCP Scope</button>
                        </div>
                        <div style="padding: 15px; border-bottom:1px solid #e1e5ef; display:flex; flex-wrap:wrap; gap:15px; align-items:center;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-weight:600; color:#27ae60;">Bitmask:</span>
                                <input type="number" id="dhcp-bitmask" class="login-input" style="width:80px; margin:0;" min="8" max="30">
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-weight:600;">Max DHCP Server:</span>
                                <input type="number" id="dhcp-max-servers" class="login-input" style="width:100px; margin:0;" min="1" max="512">
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="saveDhcpGlobals()">Save</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="dhcp-table">
                                <thead>
                                    <tr>
                                        <th>Interface</th>
                                        <th>Address</th>
                                        <th>Pool</th>
                                        <th>Mask</th>
                                        <th>Size</th>
                                        <th>DNS</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VLAN Configuration -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">VLAN Configuration</div>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('vlan-modal').style.display = 'flex'">+ Add VLAN</button>
                        </div>

                        <!-- VLAN List -->
                        <div class="table-responsive">
                            <table class="table" id="vlan-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Interface</th>
                                        <th>MAC</th>
                                        <th>VLAN ID</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Bridge Configuration -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">Bridge Configuration</div>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('bridge-modal').style.display = 'flex'">+ Add Bridge</button>
                        </div>

                        <!-- Bridge List -->
                        <div class="table-responsive">
                            <table class="table" id="bridge-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Members</th>
                                        <th>IP Address</th>
                                        <th>Netmask</th>
                                        <th>STP</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Built-in WiFi Configuration -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">Built-in WiFi (Access Point)</div>
                        </div>
                        <div style="padding: 20px;">
                            <form id="wifi-config-form" onsubmit="saveWifiConfig(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="grid-column: span 2; display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="wifi-enabled" style="margin-right: 10px; transform: scale(1.2);">
                                        <label for="wifi-enabled" style="font-weight: 600;">Enable WiFi Access Point</label>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:5px;">SSID (Network Name)</label>
                                        <input type="text" id="wifi-ssid" class="login-input" style="margin:0;" required>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:5px;">Password (Min 8 chars)</label>
                                        <input type="text" id="wifi-password" class="login-input" style="margin:0;" placeholder="Leave empty for Open Network">
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:5px;">Channel</label>
                                        <select id="wifi-channel" class="login-input" style="margin:0;">
                                            <option value="1">Channel 1</option>
                                            <option value="6">Channel 6</option>
                                            <option value="11">Channel 11</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:5px;">Hardware Mode</label>
                                        <select id="wifi-hw-mode" class="login-input" style="margin:0;">
                                            <option value="g">802.11g (2.4GHz)</option>
                                            <option value="n">802.11n (2.4GHz)</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                                    <button type="submit" class="btn btn-primary">Save WiFi Settings</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Walled Garden Configuration -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">Walled Garden / Domain Filter</div>
                            <button class="btn btn-sm btn-primary" onclick="openWalledGardenModal()">+ Add Domain</button>
                        </div>
                        <div style="padding: 20px;">
                            <!-- List Table -->
                            <div class="table-responsive">
                                <table class="table" id="wg-table">
                                    <thead>
                                        <tr>
                                            <th>Domain</th>
                                            <th>Type</th>
                                            <th>Address (Auto-Resolved)</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Populated via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: QoS -->
                <div id="view-qos" class="view-section" style="display:none;">
                    <!-- QoS Performance Mode -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">QoS Performance Mode</div>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Select Application Profile</label>
                                <select id="qos-mode-select" class="login-input" style="margin:0; width:100%; max-width:400px;" onchange="updateQoSDescription()">
                                    <option value="gaming">Gaming / Low-Latency Focused</option>
                                    <option value="family">Family / Household Management</option>
                                    <option value="enterprise">Enterprise / Business Critical</option>
                                    <option value="green">Green / Sustainable Angle</option>
                                </select>
                            </div>
                            
                            <div id="qos-mode-desc" style="background:#f8f9fa; padding:15px; border-radius:8px; border-left:4px solid var(--primary); margin-bottom:20px;">
                                <!-- Populated via JS -->
                            </div>

                            <!-- Green Stats (Visible only in Green Mode) -->
                            <div id="green-stats" style="display:none; margin-bottom: 20px;">
                                <div class="grid-4">
                                    <div class="card" style="text-align: center; padding: 15px;">
                                        <div style="font-size: 0.8rem; color: #777;">Power Saved</div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">12%</div>
                                    </div>
                                    <div class="card" style="text-align: center; padding: 15px;">
                                        <div style="font-size: 0.8rem; color: #777;">Carbon Offset</div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">0.4 kg</div>
                                    </div>
                                </div>
                            </div>

                            <div style="display:flex; justify-content:flex-end; gap: 10px;">
                                <button class="btn btn-primary" onclick="saveQoSMode()">Apply Mode</button>
                                <!-- Rage Mode Button (Visible only in Gaming Mode) -->
                                <button id="rage-btn" class="btn btn-danger" style="display:none;" onclick="triggerRageMode()">
                                    <i class="fas fa-fire"></i> RAGE MODE (Boost 30s)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Active Traffic Control -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Active Traffic Control</div>
                            <button class="btn btn-sm btn-primary" onclick="loadQoSUsers()">Refresh</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="qos-users-table">
                                <thead>
                                    <tr>
                                        <th>IP Address</th>
                                        <th>MAC Address</th>
                                        <th>Download Traffic</th>
                                        <th>Upload Traffic</th>
                                        <th>Limits (DL/UL)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">Bandwidth Management</div>
                            <button class="btn btn-sm btn-primary" onclick="showAddLimitModal()">+ Add Limit</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="qos-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Download</th>
                                        <th>Upload</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: AdBlocker / Firewall -->
                <div id="view-firewall" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">AdBlocker & Firewall Rules</div>
                            <button class="btn btn-sm btn-primary" onclick="showAddRuleModal()">+ Add Rule</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="firewall-table">
                                <thead>
                                    <tr>
                                        <th>Port</th>
                                        <th>Protocol</th>
                                        <th>Comment</th>
                                        <th>Created At</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- VIEW: Portal Logs -->
                <div id="view-portal" class="view-section" style="display:none;">
                    <!-- Portal Configuration Card -->
                    <div class="card" style="max-width: 600px;">
                        <div class="card-header">
                            <div class="card-title">Portal Configuration</div>
                        </div>
                        <form id="portal-config-form" onsubmit="savePortalConfig(event)">
                            <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label for="portal-container-width" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Container Max Width (px)</label>
                                    <input type="number" id="portal-container-width" class="login-input" min="300" max="800" style="margin:0;" autocomplete="off">
                                </div>
                                <div>
                                    <label for="portal-icon-size" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Icon Size (px)</label>
                                    <input type="number" id="portal-icon-size" class="login-input" min="20" max="100" style="margin:0;" autocomplete="off">
                                </div>
                                <div>
                                    <label for="portal-status-container-size" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Status Icon Container Size (px)</label>
                                    <input type="number" id="portal-status-container-size" class="login-input" min="30" max="100" style="margin:0;" autocomplete="off">
                                </div>
                                <div>
                                    <label for="portal-banner-height" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Banner Height (px)</label>
                                    <input type="number" id="portal-banner-height" class="login-input" min="50" max="500" style="margin:0;" autocomplete="off">
                                </div>
                                <div style="grid-column: span 2; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dfe6e9;">
                                        <div style="display:flex; align-items:center;">
                                            <span style="font-weight: 600; color: #2d3436;">Hide Voucher Code Display</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="portal-hide-voucher-code">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #636e72; margin-top: 4px; padding-left: 10px;">
                                        If enabled, the "CODE: XXXXXX" text will be hidden on the client portal.
                                    </div>
                                </div>
                                <div style="grid-column: span 2; margin-bottom: 10px;">
                                    <div style="display:flex; align-items:center; height:40px;">
                                        <input type="checkbox" id="portal-use-default-banner" style="margin-right:10px; transform:scale(1.2);" onchange="toggleBannerUpload()">
                                        <label for="portal-use-default-banner" style="font-weight:600; font-size:0.9rem; cursor:pointer;">Use Default Banner</label>
                                    </div>
                                    <div id="default-banner-selector" style="display:none; margin-top:10px;">
                                         <label for="portal-default-banner-file" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Select Default Banner</label>
                                         <select id="portal-default-banner-file" class="login-input" style="margin:0;">
                                             <option value="op-banner.png">Default Banner 1 (op-banner.png)</option>
                                             <option value="op-banner1.png">Default Banner 2 (op-banner1.png)</option>
                                         </select>
                                    </div>
                                </div>
                                <div style="grid-column: span 2;" id="banner-upload-section">
                            <label for="portal-banner-upload" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Banner Image (PNG/JPG)</label>
                            <input type="file" id="portal-banner-upload" accept="image/png, image/jpeg" style="margin:0 0 10px 0;">
                            <button type="button" class="btn btn-sm btn-primary" onclick="uploadPortalBanner()">Upload Banner</button>
                        </div>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin: 0 20px 20px 20px; width: calc(100% - 40px);">Save Portal Config</button>
                        </form>
                    </div>
                </div>

                <!-- VIEW: System Logs -->
                <div id="view-syslogs" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Logs</div>
                            <div class="log-controls" style="display: flex; gap: 10px;">
                                <select id="log-category-filter" class="login-input" style="margin:0; width: auto;" onchange="loadLogs(this.value)">
                                    <option value="system">System</option>
                                    <option value="pppoe">PPPoE</option>
                                    <option value="vouchers">Vouchers</option>
                                    <option value="errors">Critical Errors</option>
                                </select>
                                <button class="btn btn-sm btn-primary" onclick="loadLogs()">Refresh</button>
                            </div>
                        </div>
                        <div class="log-container" style="padding: 0;">
                            <div style="background: #1e272e; color: #dcdde1; font-family: 'Courier New', monospace; padding: 15px; height: 500px; overflow-y: auto; font-size: 0.9rem;" id="log-display-area">
                                Loading logs...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Devices -->
                <div id="view-devices" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Connected Devices</div>
                            <button class="btn btn-sm btn-primary" onclick="loadDevicesData()">Refresh</button>
                        </div>
                        <div class="table-container">
                            <table id="devices-table">
                                <thead>
                                    <tr>
                                        <th>MAC Address</th>
                                        <th>IP Address</th>
                                        <th>Time Remaining</th>
                                        <th>Traffic (DL/UP)</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Chat -->
                <div id="view-chat" class="view-section" style="display:none;">
                    <div class="chat-container">
                        <!-- Sidebar: Conversations -->
                        <div class="chat-sidebar" id="chat-sidebar">
                            <!-- Chat Settings Block -->
                            <div style="padding: 15px; border-bottom: 1px solid #dfe6e9; background: #fff;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #2d3436; font-size: 0.95rem;">Client Chat</span>
                                    <label class="switch" style="transform: scale(0.8); margin: 0;">
                                        <input type="checkbox" id="chat-enabled-toggle" onchange="saveChatSettings(event)">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <div style="font-size: 0.75rem; color: #b2bec3; margin-top: 4px;">
                                    Show widget on portal
                                </div>
                            </div>

                            <div class="chat-header" style="background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                                Conversations
                                <button onclick="toggleChatSidebar()" style="background: none; border: none; cursor: pointer; color: #636e72; display: none;" class="mobile-only-block" title="Hide List">
                                    <svg style="width:20px; height:20px;" viewBox="0 0 24 24"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                                </button>
                            </div>
                            <div class="chat-list" id="chat-list">
                                <!-- Chat items will be loaded here -->
                                <div style="padding:20px; text-align:center; color:#b2bec3;">Loading...</div>
                            </div>
                        </div>

                        <!-- Main: Chat Window -->
                        <div class="chat-main">
                    <div class="chat-header" style="display: flex; align-items: center;">
                        <button id="chat-toggle-list-btn" onclick="toggleChatSidebar()" style="display:none; background:none; border:none; margin-right:10px; cursor:pointer;">
                            <svg style="width:24px; height:24px; fill:#2d3436;" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                        </button>
                        <span id="chat-current-user">Select a conversation</span>
                        <div class="status-indicator" id="chat-status-indicator" style="margin-left:auto; display:none;">
                            <span class="status-dot"></span>
                            <span class="status-text">Connected</span>
                        </div>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." disabled>
                        <button class="chat-send-btn" id="chat-send-btn" onclick="sendAdminMessage()" disabled>Send</button>
                    </div>
                </div>
                    </div>
                </div>

                <!-- VIEW: Settings -->
                <div id="view-settings" class="view-section" style="display:none;">
                    <div class="settings-wrapper" style="display: grid; gap: 20px; max-width: 700px; margin: 0 auto;">
                        
                        <!-- General Settings Group -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">General Settings</div>
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <!-- Vendo Settings Item -->
                                <div onclick="document.getElementById('vendo-settings-modal').style.display='flex'" 
                                     style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;"
                                     onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                    <span style="font-weight: 500;">Vendo Settings</span>
                                    <svg style="width: 24px; height: 24px; fill: #b2bec3;" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>

                                <!-- Security Configuration Item -->
                                <div onclick="document.getElementById('security-config-modal').style.display='flex'" 
                                     style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;"
                                     onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                    <span style="font-weight: 500;">Security Configuration</span>
                                    <svg style="width: 24px; height: 24px; fill: #b2bec3;" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>

                                <!-- Time & NTP Settings Item -->
                                <div onclick="document.getElementById('time-settings-modal').style.display='flex'" 
                                     style="padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;"
                                     onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                    <span style="font-weight: 500;">Time & NTP Settings</span>
                                    <svg style="width: 24px; height: 24px; fill: #b2bec3;" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>
                            </div>
                        </div>

                        <!-- System Maintenance -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">System Maintenance</div>
                            </div>
                            <div style="padding: 15px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                                <!-- Reboot -->
                                <button onclick="rebootSystem()" class="btn" style="background: #f39c12; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; aspect-ratio: 1; height: auto; width: 100%; gap: 5px; font-size: 0.75rem;">
                                    <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                                    <span>Reboot</span>
                                </button>

                                <!-- Upgrade Local -->
                                 <button onclick="upgradeSystem('local')" class="btn" style="background: #3498db; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; aspect-ratio: 1; height: auto; width: 100%; gap: 5px; font-size: 0.75rem;">
                                    <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                                    <span>Upload</span>
                                </button>
                                
                                 <!-- Upgrade Online -->
                                 <button onclick="upgradeSystem('online')" class="btn" style="background: #9b59b6; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; aspect-ratio: 1; height: auto; width: 100%; gap: 5px; font-size: 0.75rem;">
                                    <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                                    <span>Upgrade</span>
                                </button>

                                <!-- Factory Reset -->
                                <button onclick="factoryReset()" class="btn" style="background: #e74c3c; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; aspect-ratio: 1; height: auto; width: 100%; gap: 5px; font-size: 0.75rem;">
                                    <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg>
                                    <span>Reset</span>
                                </button>

                                <!-- Verify Config -->
                                <button onclick="verifyConfiguration()" class="btn" style="background: #2ecc71; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; aspect-ratio: 1; height: auto; width: 100%; gap: 5px; font-size: 0.75rem;">
                                    <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                    <span>Verify</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- VIEW: Sub Vendo -->
                <div id="view-subvendo" class="view-section" style="display:none;">
                    <div class="grid-2">
                        <!-- Sub Vendo Config -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Sub Vendo Configuration</div>
                            </div>
                            <div style="padding: 15px;">
                                <div class="form-group">
                                    <label for="subvendo-key" style="display:block; font-weight:600; margin-bottom:6px;">Sub Vendo Key</label>
                                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                        <input type="text" id="subvendo-key" class="login-input" style="margin:0; flex:1 1 240px;" placeholder="Enter secure key">
                                        <button class="btn btn-primary" onclick="saveSubVendoKey()">Save</button>
                                    </div>
                                    <div style="font-size:0.8rem; color:#636e72; margin-top:6px;">
                                        Used to authenticate ESP8266 devices.
                                    </div>
                                </div>
                                <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                                        <div style="font-weight:600;">Free Time per VLAN</div>
                                        <button class="btn btn-sm btn-primary" onclick="openSubVendoFreeTimeModal()">Configure</button>
                                    </div>
                                    <div style="font-size:0.8rem; color:#636e72; margin-top:6px;">
                                        Configure free time and widget visibility per VLAN.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Registered Devices -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Registered Devices</div>
                                <button class="btn btn-sm btn-primary" onclick="loadSubVendoDevices()">Refresh</button>
                            </div>
                            <div class="table-container">
                                <table id="subvendo-devices-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Device ID</th>
                                            <th>Status</th>
                                            <th>Last Active</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="subvendo-devices-list" class="device-list"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    <div id="subvendo-free-time-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:480px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.05rem; background:#fff; position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Free Time Configuration</span>
                <button onclick="document.getElementById('subvendo-free-time-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px; display:grid; grid-template-columns:1fr; gap:12px;">
                <div>
                    <label for="free-time-vlan" style="display:block; font-weight:600; margin-bottom:6px; font-size:0.9rem;">Target VLAN</label>
                    <select id="free-time-vlan" class="login-input" style="margin:0;" onchange="loadSubVendoFreeTime()">
                        <option value="eth0">Main LAN (eth0)</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:6px; font-size:0.9rem;">Free Time Options</label>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem;">
                            <input type="checkbox" id="free-time-enabled">
                            <span>Enable Free Time for this VLAN</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem;">
                            <input type="checkbox" id="free-time-widget">
                            <span>Show Free Time widget on client portal</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="free-time-minutes" style="display:block; font-weight:600; margin-bottom:6px; font-size:0.9rem;">Free Time Duration (hh:mm:ss)</label>
                    <input type="text" id="free-time-minutes" class="login-input" style="margin:0;" placeholder="e.g. 00:15:00">
                </div>
                <div>
                    <label for="free-time-reclaim" style="display:block; font-weight:600; margin-bottom:6px; font-size:0.9rem;">Re-claim Period (hh:mm:ss)</label>
                    <input type="text" id="free-time-reclaim" class="login-input" style="margin:0;" placeholder="e.g. 24:00:00">
                </div>
                <div style="font-size:0.8rem; color:#636e72;">
                    Settings are applied per VLAN. Clients receive free time based on their VLAN.
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fff; position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-secondary" onclick="document.getElementById('subvendo-free-time-modal').style.display='none'">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="saveSubVendoFreeTime()">Save</button>
            </div>
        </div>
    </div>

    <!-- Vendo Settings Modal -->
    <div id="vendo-settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:600px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Vendo Settings</span>
                <button onclick="document.getElementById('vendo-settings-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <form onsubmit="saveSettings(event); document.getElementById('vendo-settings-modal').style.display='none';">
                    <div id="settings-container" class="settings-grid"></div>
                    <div style="margin-top: 15px; text-align: right;">
                        <button type="submit" class="btn" style="background:#00b894; color:white;">Save Vendo Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Security Config Modal -->
    <div id="security-config-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Security Configuration</span>
                <button onclick="document.getElementById('security-config-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <form id="security-form" onsubmit="updateCredentials(event); document.getElementById('security-config-modal').style.display='none';">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-username" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Admin Username</label>
                        <input type="text" id="admin-username" class="login-input" style="margin:0; padding: 3px 8px;" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-password" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">New Password</label>
                        <input type="password" id="admin-password" class="login-input" style="margin:0; padding: 3px 8px;" required>
                    </div>
                     <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-confirm-password" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Confirm Password</label>
                        <input type="password" id="admin-confirm-password" class="login-input" style="margin:0; padding: 3px 8px;" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-security-question" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Security Question</label>
                        <select id="admin-security-question" class="login-input" style="margin:0; padding: 3px 8px;">
                            <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                            <option value="What is the name of your first pet?">What is the name of your first pet?</option>
                            <option value="What is your favorite movie?">What is your favorite movie?</option>
                            <option value="What is your favorite book?">What is your favorite book?</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-security-answer" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Security Answer</label>
                        <input type="text" id="admin-security-answer" class="login-input" style="margin:0; padding: 3px 8px;" placeholder="Answer for recovery">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Credentials</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Time Settings Modal -->
    <div id="time-settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Time & NTP Settings</span>
                <button onclick="document.getElementById('time-settings-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <form onsubmit="saveTimeSettings(event); document.getElementById('time-settings-modal').style.display='none';">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Time Synchronization</label>
                        <select id="time-sync-mode" class="login-input" style="margin:0;" onchange="toggleTimeInputs()">
                            <option value="auto">Automatic (NTP)</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div id="ntp-server-group" class="form-group" style="margin-bottom: 15px;">
                        <label for="ntp-server" style="display:block; font-weight:600; margin-bottom:5px;">NTP Server</label>
                        <input type="text" id="ntp-server" class="login-input" style="margin:0;" placeholder="pool.ntp.org">
                    </div>
                    <div id="manual-time-group" class="form-group" style="margin-bottom: 15px; display:none;">
                        <label for="manual-datetime" style="display:block; font-weight:600; margin-bottom:5px;">Set Time & Date</label>
                        <input type="datetime-local" id="manual-datetime" class="login-input" style="margin:0;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Timezone Mode</label>
                        <select id="timezone-mode" class="login-input" style="margin:0;" onchange="toggleTimeInputs()">
                            <option value="auto">Automatic (Default)</option>
                            <option value="manual">Manual Selection</option>
                        </select>
                    </div>
                    <div id="timezone-select-group" class="form-group" style="margin-bottom: 15px; display:none;">
                        <label for="timezone-select" style="display:block; font-weight:600; margin-bottom:5px;">Select Timezone</label>
                        <select id="timezone-select" class="login-input" style="margin:0;">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                            Current System Time: <span id="current-system-time" style="font-weight: 600;">Loading...</span>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Time Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="subvendo-device-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:520px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10;">
                Sub Vendo Device Settings
            </div>
            <div id="subvendo-device-form" class="subvendo-form-grid">
                <div class="form-col-span-2">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Name</label>
                    <input type="text" id="subvendo-device-name" class="login-input" style="margin:0;" autocomplete="off">
                </div>
                <div class="form-col-span-2">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Description</label>
                    <textarea id="subvendo-device-description" class="login-input" style="margin:0; min-height:80px; resize:vertical;" autocomplete="off"></textarea>
                </div>
                
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Download</label>
                    <input type="number" id="subvendo-device-download" class="login-input" style="margin:0;" placeholder="Default (Mbps)" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Upload</label>
                    <input type="number" id="subvendo-device-upload" class="login-input" style="margin:0;" placeholder="Default (Mbps)" autocomplete="off">
                </div>

                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Coin Acceptor</label>
                    <input type="number" id="subvendo-device-coin-pin" class="login-input" style="margin:0;" min="0" max="16" step="1" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Relay Pin</label>
                    <input type="number" id="subvendo-device-relay-pin" class="login-input" style="margin:0;" min="0" max="16" step="1" autocomplete="off">
                </div>

                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Rate/Pulse</label>
                    <input type="number" id="subvendo-device-rate" class="login-input" style="margin:0;" min="1" max="100" step="1" autocomplete="off">
                </div>

                <div class="form-col-span-2" style="margin-top:10px;">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Rates Visibility</label>
                    <div id="subvendo-device-rates" style="display:grid; grid-template-columns: 1fr; gap:8px;"></div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fff; position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="closeSubVendoDeviceSettings()">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="saveSubVendoDeviceSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- DHCP Modal -->
    <div id="dhcp-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:600px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#f8fafc; position:sticky; top:0; z-index:10;">
                New DHCP Scope
            </div>
            <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                    <label for="dhcp-interface" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Interface</label>
                    <select id="dhcp-interface" class="login-input" style="margin:0;" autocomplete="off">
                    </select>
                </div>
                <div>
                    <label for="dhcp-dns1" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">DNS 1</label>
                    <input type="text" id="dhcp-dns1" class="login-input" placeholder="8.8.8.8" value="8.8.8.8" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label for="dhcp-dns2" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">DNS 2</label>
                    <input type="text" id="dhcp-dns2" class="login-input" placeholder="8.8.4.4" value="8.8.4.4" style="margin:0;" autocomplete="off">
                </div>
                <div style="grid-column: span 2;">
                    <pre id="dhcp-subnet-info" style="background:#f3f4f6; color:#111827; padding:10px; border-radius:4px; font-family:monospace; font-size:0.8rem; min-height:120px; white-space:pre-wrap;"></pre>
                </div>
            </div>
            <input type="hidden" id="dhcp-ip">
            <input type="hidden" id="dhcp-netmask">
            <input type="hidden" id="dhcp-pool-start">
            <input type="hidden" id="dhcp-pool-end">
            <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fff; position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('dhcp-modal').style.display = 'none'">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="addDhcpServer()">Save Scope</button>
            </div>
        </div>
    </div>

    <!-- VLAN Modal -->
    <div id="vlan-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10;">
                New VLAN
            </div>
            <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                    <label for="vlan-parent" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Parent Interface</label>
                    <select id="vlan-parent" class="login-input" style="margin:0;" autocomplete="off">
                        <!-- Populated via JS -->
                    </select>
                </div>
                <div>
                    <label for="vlan-id" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">VLAN ID (Tag)</label>
                    <input type="number" id="vlan-id" class="login-input" placeholder="10" min="1" max="4094" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label for="vlan-mac-generate" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Generate MAC</label>
                    <select id="vlan-mac-generate" class="login-input" style="margin:0;" autocomplete="off">
                        <option value="true" selected>True</option>
                        <option value="false">False</option>
                    </select>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fff; position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('vlan-modal').style.display = 'none'">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="addVlan()">Create VLAN</button>
            </div>
        </div>
    </div>

    <!-- Bridge Modal -->
    <div id="bridge-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div id="bridge-modal-title" style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10;">
                New Bridge
            </div>
            <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                    <label for="bridge-name" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Bridge Name</label>
                    <input type="text" id="bridge-name" class="login-input" placeholder="br0" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label for="bridge-ip" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">IP Address</label>
                    <input type="text" id="bridge-ip" class="login-input" placeholder="192.168.1.1" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label for="bridge-netmask" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Netmask</label>
                    <input type="text" id="bridge-netmask" class="login-input" placeholder="255.255.255.0" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">STP</label>
                    <div style="display:flex; align-items:center; height:40px;">
                        <input type="checkbox" id="bridge-stp" style="margin-right:10px; transform:scale(1.2);">
                        <label for="bridge-stp">Enable Spanning Tree Protocol</label>
                    </div>
                </div>
                <div style="grid-column: span 2;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Member Interfaces</label>
                    <div id="bridge-interfaces" style="display:flex; flex-wrap:wrap; gap:15px; background:#f9f9f9; padding:10px; border:1px solid #ddd; border-radius:4px;">
                        <!-- Checkboxes populated via JS -->
                    </div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fff; position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('bridge-modal').style.display = 'none'">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="saveBridge()">Create/Update Bridge</button>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verify-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:600px; max-height:90vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff; position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>System Configuration Check</span>
                <button onclick="document.getElementById('verify-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div id="verify-results" style="padding:20px;">
                <!-- Results populated here -->
                <div style="text-align:center; color:#666;">Running checks...</div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; background:#fff; position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-primary" onclick="document.getElementById('verify-modal').style.display = 'none'">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Init Charts ---
        let bwChart, cpuDoughnut;
        let voucherInterval = null; // Interval for updating voucher status
        let devicesInterval = null; // Interval for updating devices status
        let subVendoDevicesInterval = null;
        let visualInterfaceMap = {}; // Map real interface names to visual names (e.g. end0 -> eth0)
        let chartsEnabled = false;

        // Cyan Theme matching the design (Default fallback)
        const cpuColor = '#00cec9'; 
        const cpuTrack = '#dfe6e9';

        // Unique colors for each core
        const gaugeColors = [
            '#00cec9', // Cyan
            '#0984e3', // Blue
            '#6c5ce7', // Purple
            '#fdcb6e', // Orange
            '#e17055', // Terra Cotta
            '#00b894', // Green
            '#e84393', // Pink
            '#2d3436'  // Dark
        ];

        function updateCpuChart(cores) {
            if (!cpuDoughnut) return;

            // Calculate Total Average
            const totalAvg = Math.round(cores.reduce((a, b) => a + b, 0) / cores.length);
            const totalEl = document.getElementById('cpu-total-val');
            if(totalEl) totalEl.textContent = totalAvg + '%';

            // Update Details Text (Left Side)
            const detailsEl = document.getElementById('cpu-details');
            if (detailsEl) {
                let html = '';
                
                cores.forEach((usage, i) => {
                    const color = gaugeColors[i % gaugeColors.length];
                    html += `<div style="display:flex; justify-content:space-between; margin-bottom:4px; min-width:100px;">
                        <span style="text-align:left;">CPU ${i+1}</span>
                        <span style="color:${color}; text-align:right; margin-left:15px;">${usage}%</span>
                    </div>`;
                });
                detailsEl.innerHTML = html;
            }

            // Check if we need to restructure datasets
            if (cpuDoughnut.data.datasets.length !== cores.length) {
                const newDatasets = cores.map((usage, i) => {
                    const color = gaugeColors[i % gaugeColors.length];
                    return {
                        data: [usage, 100 - usage],
                        backgroundColor: [color, cpuTrack],
                        borderWidth: 0,
                        borderRadius: 5, // Rounded ends
                    };
                });
                
                // Adjust cutout
                const coreCount = cores.length;
                let newCutout = '50%'; 
                if (coreCount > 2) newCutout = '40%';
                if (coreCount > 4) newCutout = '30%';
                
                if (cpuDoughnut.options) cpuDoughnut.options.cutout = newCutout;
                cpuDoughnut.data.datasets = newDatasets;
            } else {
                // Update data
                cores.forEach((usage, i) => {
                    const color = gaugeColors[i % gaugeColors.length];
                    cpuDoughnut.data.datasets[i].data = [usage, 100 - usage];
                    cpuDoughnut.data.datasets[i].backgroundColor = [color, cpuTrack];
                });
            }
            cpuDoughnut.update();
        }

        function initCharts() {
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js not loaded.");
                return;
            }
            chartsEnabled = true;

            // Bandwidth Chart
            const ctxBw = document.getElementById('bandwidthChart').getContext('2d');
            const dlFill = ctxBw.createLinearGradient(0, 0, 0, 260);
            dlFill.addColorStop(0, 'rgba(9, 132, 227, 0.55)');
            dlFill.addColorStop(0.5, 'rgba(9, 132, 227, 0.14)');
            dlFill.addColorStop(1, 'rgba(9, 132, 227, 0.02)');

            const ulFill = ctxBw.createLinearGradient(0, 0, 0, 260);
            ulFill.addColorStop(0, 'rgba(46, 204, 113, 0.02)');
            ulFill.addColorStop(0.5, 'rgba(46, 204, 113, 0.14)');
            ulFill.addColorStop(1, 'rgba(46, 204, 113, 0.55)');

            const dlStroke = ctxBw.createLinearGradient(0, 0, ctxBw.canvas.clientWidth || 600, 0);
            dlStroke.addColorStop(0, '#0984e3');
            dlStroke.addColorStop(1, '#74b9ff');

            const ulStroke = ctxBw.createLinearGradient(0, 0, ctxBw.canvas.clientWidth || 600, 0);
            ulStroke.addColorStop(0, '#2ecc71');
            ulStroke.addColorStop(1, '#55efc4');

            bwChart = new Chart(ctxBw, {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [
                        { 
                            label: 'Input (Download)', 
                            data: Array(60).fill(0), 
                            borderColor: dlStroke,
                            backgroundColor: dlFill,
                            fill: { target: 'origin', above: dlFill, below: 'rgba(9, 132, 227, 0.02)' },
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 1.5
                        },
                        { 
                            label: 'Output (Upload)', 
                            data: Array(60).fill(0), 
                            borderColor: ulStroke,
                            backgroundColor: ulFill,
                            fill: { target: 'origin', above: 'rgba(46, 204, 113, 0.02)', below: ulFill },
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 1.5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const v = Math.abs(Number(ctx.parsed.y || 0));
                                    return `${ctx.dataset.label}: ${v.toFixed(2)} Mbps`;
                                }
                            }
                        }
                    },
                    scales: { 
                        x: { 
                            grid: { color: 'rgba(0,0,0,0.06)', borderDash: [2, 3] },
                            ticks: { color: '#374151', maxTicksLimit: 7 }
                        },
                        y: { 
                            grid: { color: 'rgba(0,0,0,0.06)', borderDash: [2, 3] },
                            border: { color: 'rgba(0,0,0,0.15)' },
                            ticks: { 
                                color: '#374151',
                                callback: (value) => Math.abs(Number(value)).toString()
                            },
                            title: { display: true, text: 'Mbps', color: '#6b7280', font: { weight: '600' } }
                        } 
                    },
                    animation: { 
                        duration: 1000,
                        easing: 'linear'
                    }
                }
            });

            // CPU Chart (Gauge Style)
            const ctxCpu = document.getElementById('cpuChart').getContext('2d');
            cpuDoughnut = new Chart(ctxCpu, {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Free'],
                    datasets: [{ data: [0, 100], backgroundColor: [cpuColor, cpuTrack], borderWidth: 0, borderRadius: 5 }]
                },
                options: { 
                    cutout: '50%', 
                    rotation: -115,      // Rotate to center arc on Right
                    circumference: 230,  // ~64% of circle (C shape)
                    plugins: { legend: { display: false }, tooltip: { enabled: false } } 
                }
            });
        }

        // --- Core Logic ---
        let currentView = 'dashboard';

        // --- Idle Timeout Logic ---
        let idleTimer;
        const IDLE_LIMIT = 3600000; // 1 hour

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            // Only set timer if user is logged in (dashboard is visible)
            const dashboard = document.getElementById('dashboard-ui');
            if (dashboard && dashboard.style.display !== 'none') {
                idleTimer = setTimeout(() => {
                    logout(true); 
                }, IDLE_LIMIT);
            }
        }

        function initIdleTimer() {
             const events = ['mousemove', 'mousedown', 'click', 'keypress', 'touchstart'];
             events.forEach(evt => {
                window.addEventListener(evt, resetIdleTimer, { passive: true });
             });
             // Scroll doesn't bubble, so use capture to catch scrolling in divs
             window.addEventListener('scroll', resetIdleTimer, { capture: true, passive: true });
             resetIdleTimer();
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/dashboard', { credentials: 'include', cache: 'no-store' });
                document.getElementById('loading-overlay').style.display = 'none';
                if (res.ok) showDashboard();
                else document.getElementById('login-screen').style.display = 'flex';
            } catch(e) {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        async function manualRefresh(btn) {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('spin');
            
            try {
                if (currentView === 'dashboard') await loadDashboardData();
                else if (currentView === 'sales') await loadSalesData('daily'); // Default to daily for now
                // Settings doesn't need refresh usually
            } catch (e) {
                console.error("Refresh failed", e);
            } finally {
                setTimeout(() => icon.classList.remove('spin'), 500); // Min 500ms spin
            }
        }


        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: u, password: p })
            });
            if (res.ok) showDashboard();
            else document.getElementById('login-error').textContent = 'Invalid credentials';
        }

        async function logout(skipConfirm = false) {
            if (!skipConfirm) {
                if (!await showConfirm("Are you sure you want to log out?", true, "Logout")) return;
            }
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }).then(() => location.reload());
        }

        let systemClockInterval = null;

        function startClock(serverTimeString) {
            if (systemClockInterval) clearInterval(systemClockInterval);

            const serverTime = new Date(serverTimeString);
            const clientTime = new Date();
            const offset = serverTime - clientTime;

            const updateClock = () => {
                const now = new Date();
                const estimatedServerTime = new Date(now.getTime() + offset);
                
                // Update Topbar Time
                const topbarTime = document.getElementById('topbar-time');
                if (topbarTime) {
                    topbarTime.style.display = 'block';
                    // Format: Jan 11, 10:30:45 AM
                    topbarTime.textContent = estimatedServerTime.toLocaleString('en-US', { 
                        month: 'short', day: 'numeric', 
                        hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true 
                    });
                }

                // Update Settings Page Time (if element exists and is visible)
                const settingsTime = document.getElementById('current-system-time');
                if (settingsTime) {
                    settingsTime.textContent = estimatedServerTime.toLocaleString();
                }
            };

            updateClock();
            systemClockInterval = setInterval(updateClock, 1000);
        }

        async function initSystemClock() {
            try {
                const res = await fetch('/api/admin/system/time');
                if (res.ok) {
                    const settings = await res.json();
                    if (settings.current_system_time) {
                        startClock(settings.current_system_time);
                    }
                }
            } catch (e) {
                console.error("Failed to init system clock", e);
            }
        }

        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-ui').style.display = 'flex';
            initCharts();
            initIdleTimer();
            initSystemClock(); // Start the clock
            
            // Restore last view
            const lastView = localStorage.getItem('admin_last_view') || 'dashboard';
            showView(lastView);

            // Start background interval for dashboard data (always runs for real-time topbar/status)
            // But maybe we only want to poll if we are on dashboard?
            // The requirement was "content like realtime bandwith ... update it in 1000ms interval"
            // So we should probably keep it running or only run when dashboard is active.
            // For simplicity and to keep "System Online" status fresh, we keep it running.
            setInterval(() => {
                if(currentView === 'dashboard') loadDashboardData();
            }, 3000); 
        }

        function nav(view) {
            showView(view);
            // On mobile, close sidebar after click
            if (window.innerWidth <= 768) {
                setSidebarOpen(false);
            }
        }

        function showView(view) {
            // Clear intervals
            if (voucherInterval) {
                clearInterval(voucherInterval);
                voucherInterval = null;
            }
            if (devicesInterval) {
                clearInterval(devicesInterval);
                devicesInterval = null;
            }
            if (subVendoDevicesInterval) {
                clearInterval(subVendoDevicesInterval);
                subVendoDevicesInterval = null;
            }

            currentView = view;
            localStorage.setItem('admin_last_view', view); // Persist view

            // Hide all
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById('view-' + view).style.display = 'block';
            
            // Update Menu Active State
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                if(item.getAttribute('onclick').includes(view)) {
                    item.classList.add('active');
                    // Update Header Icon
                    const svg = item.querySelector('svg');
                    const headerIcon = document.getElementById('header-icon');
                    if (svg && headerIcon) {
                        headerIcon.innerHTML = svg.innerHTML;
                    }
                }
            });

            const titleMap = {
                dashboard: 'Dashboard',
                interfaces: 'Interfaces',
                pppoe: 'PPPoE',
                voucher: 'Vouchers',
                rates: 'Rates',
                network: 'Network',
                qos: 'QoS',
                firewall: 'Firewall',
                subvendo: 'Sub Vendo',
                portal: 'Portal',
                syslogs: 'Logs',
                devices: 'Devices',
                chat: 'Chat',
                sales: 'Sales',
                settings: 'Settings'
            };
            const title = titleMap[view] || view.charAt(0).toUpperCase() + view.slice(1);
            document.getElementById('page-title').textContent = title;

            const scroller = document.querySelector('.content-scroll');
            if (scroller) scroller.scrollTop = 0;

            // Load Data
            if (view === 'dashboard') {
                loadDashboardData();
            } else if (view === 'sales') {
                loadSalesData('daily');
            } else if (view === 'settings') {
                loadSettingsData();
            } else if (view === 'portal') {
                loadPortalConfig();
            } else if (view === 'voucher') {
                loadVouchersData();
                loadActiveCodes();
                // Start auto-refresh for vouchers
                voucherInterval = setInterval(() => {
                    loadVouchersData();
                    loadActiveCodes();
                }, 1000);
            } else if (view === 'interfaces') {
                loadInterfaces();
            } else if (view === 'rates') {
                loadRatesData();
            } else if (view === 'chat') {
                loadConversations();
                loadChatSettings();
                // Ensure sidebar is visible when entering chat view
                const sidebar = document.getElementById('chat-sidebar');
                if(sidebar) sidebar.classList.remove('hidden');
            } else if (view === 'qos') {
                loadQoSUsers();
                loadQoSMode();
            } else if (view === 'network') {
                loadNetworkConfig();
                loadWifiConfig();
                loadWalledGarden();
            } else if (view === 'devices') {
                loadDevicesData();
                devicesInterval = setInterval(() => {
                    loadDevicesData();
                }, 1000);
            } else if (view === 'firewall') {
                loadFirewallRules();
            } else if (view === 'pppoe') {
                loadPppoeServerConfig();
            } else if (view === 'syslogs') {
                loadLogs('system');
            } else if (view === 'subvendo') {
                loadSubVendoConfig();
                loadSubVendoDevices();
                subVendoDevicesInterval = setInterval(() => {
                    if (currentView === 'subvendo') loadSubVendoDevices();
                }, 3000);
            }
        }

        function setSidebarOpen(open) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar) return;
            sidebar.classList.toggle('open', !!open);
            if (overlay) overlay.classList.toggle('open', !!open);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            setSidebarOpen(!sidebar.classList.contains('open'));
        }

        // --- Data Loading ---
        async function loadDashboardData() {
            try {
                const res = await fetch('/api/admin/dashboard', { credentials: 'include', cache: 'no-store' });
                if(res.status === 401) return location.reload();
                const data = await res.json();
                console.log("Dashboard Data Received:", data); // Debug log

                if (data.device_model) {
                    document.getElementById('board-model').textContent = data.device_model;
                }

                // Cards
                document.getElementById('sales-daily').textContent = 'â‚±' + data.total_sales_today.toFixed(2);
                document.getElementById('sales-weekly').textContent = 'â‚±' + (data.total_sales_week || 0).toFixed(2);
                document.getElementById('sales-monthly').textContent = 'â‚±' + (data.total_sales_month || 0).toFixed(2);
                document.getElementById('sales-yearly').textContent = 'â‚±' + (data.total_sales_year || 0).toFixed(2);
                
                document.getElementById('cpu-temp').textContent = data.cpu_temp ? data.cpu_temp.toFixed(1) + 'Â°C' : 'N/A';
                document.getElementById('ram-usage').textContent = 
                    ((data.memory.total - data.memory.free) / 1024 / 1024).toFixed(0) + ' / ' + 
                    (data.memory.total / 1024 / 1024).toFixed(0) + ' MB';
                
                if (data.storage) {
                    const totalGB = (data.storage.total / 1024 / 1024 / 1024).toFixed(1);
                    const usedGB = (data.storage.used / 1024 / 1024 / 1024).toFixed(1);
                    const storageEl = document.getElementById('storage-usage');
                    if(storageEl) storageEl.textContent = `Used: ${usedGB} GB / Total: ${totalGB} GB`;
                }

                const uptimeHrs = (data.uptime / 3600).toFixed(1);
                document.getElementById('uptime').textContent = uptimeHrs + ' hrs';

                // Add Last Updated timestamp
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                const updateEl = document.getElementById('last-updated') || createLastUpdatedElement();
                updateEl.textContent = 'Last Updated: ' + timeString;

                // CPU Chart Update
                let avgCpu = 0;
                let cores = [];
                
                if (data.cpu_usage) {
                    if (typeof data.cpu_usage === 'object' && data.cpu_usage.cores) {
                        // New format with per-core data
                        avgCpu = data.cpu_usage.avg;
                        cores = data.cpu_usage.cores;
                    } else {
                        // Old format or simple number
                        avgCpu = data.cpu_usage;
                        cores = [avgCpu];
                    }
                } else {
                    // Fallback to load_avg
                    avgCpu = (data.load_avg && data.load_avg.length > 0) ? (data.load_avg[0] * 10) : 0;
                    cores = [avgCpu];
                }

                if (chartsEnabled && cpuDoughnut) {
                    updateCpuChart(cores);
                }
                
                // Always update text
                const cpuTextEl = document.getElementById('cpu-text');
                if (cpuTextEl) cpuTextEl.textContent = Math.min(100, avgCpu.toFixed(0)) + '%';





               // Bandwidth Chart (Mocking data for now as backend doesn't provide history yet)
                // In production, backend should send [rx, tx]
                updateBandwidthChart();
                
                // If on Network tab, refresh specific network data
                if (document.getElementById('view-network').style.display === 'block') {
                    // Only fetch if we haven't fetched recently or forced
                    // For simplicity, we might just let the user click Refresh or rely on this loop
                    // But to avoid flicker, maybe we don't auto-refresh the tables every 3s
                }

            } catch(e) {
                console.error("Dashboard Load Error:", e);
            }
        }

        // --- Logs Logic ---
        async function loadLogs(category = 'system') {
            const displayArea = document.getElementById('log-display-area');
            const categorySelect = document.getElementById('log-category-filter');
            
            // Sync select if called without event
            if (categorySelect.value !== category) {
                categorySelect.value = category;
            }

            displayArea.innerHTML = '<div style="color: #bdc3c7;">Loading logs...</div>';

            try {
                const res = await fetch(`/api/logs?source=${category}&limit=100`, { credentials: 'include' });
                if (!res.ok) {
                    let errMsg = res.statusText;
                    try {
                        const errJson = await res.json();
                        errMsg = errJson.error || errMsg;
                    } catch (err) {
                        errMsg = await res.text();
                    }
                    throw new Error(`Failed to fetch logs (${res.status}): ${errMsg}`);
                }
                const logs = await res.json();

                if (!logs || logs.length === 0) {
                    displayArea.innerHTML = '<div style="color: #bdc3c7;">No logs found.</div>';
                    return;
                }

                let html = '';
                logs.forEach(log => {
                    let line = '';
                    // Formatting based on category
                    if (category === 'system' || category === 'errors') {
                        // system_logs table: id, level, category, message, timestamp
                        const color = log.level === 'CRITICAL' ? '#e74c3c' : 
                                      log.level === 'ERROR' ? '#e74c3c' : 
                                      log.level === 'WARN' ? '#f39c12' : '#2ecc71';
                        
                        line = `<div style="margin-bottom: 4px; border-bottom: 1px solid #2c3e50; padding-bottom: 2px;">
                                    <span style="color: #95a5a6;">[${new Date(log.timestamp).toLocaleString()}]</span> 
                                    <span style="color: ${color}; font-weight: bold;">[${log.level}]</span> 
                                    <span style="color: #3498db;">[${log.category}]</span> 
                                    <span style="color: #ecf0f1;">${log.message}</span>
                                </div>`;
                    } else if (category === 'vouchers') {
                        // voucher query result: code, plan_name, price, used_at, mac_address, ip_address
                        line = `<div style="margin-bottom: 4px; border-bottom: 1px solid #2c3e50; padding-bottom: 2px;">
                                    <span style="color: #95a5a6;">[${new Date(log.used_at).toLocaleString()}]</span> 
                                    <span style="color: #f1c40f;">[VOUCHER]</span> 
                                    <span style="color: #ecf0f1;">Code: ${log.code} (${log.plan_name} - â‚±${log.price})</span> 
                                    <span style="color: #bdc3c7;">used by ${log.mac_address} (${log.ip_address || 'N/A'})</span>
                                </div>`;
                    } else if (category === 'pppoe') {
                        // Raw text or object
                        const msg = log.message || log.raw || JSON.stringify(log);
                        const time = log.timestamp ? `[${new Date(log.timestamp).toLocaleString()}] ` : '';
                        line = `<div style="margin-bottom: 4px; border-bottom: 1px solid #2c3e50; padding-bottom: 2px;">
                                    <span style="color: #95a5a6;">${time}</span>
                                    <span style="color: #e67e22;">[PPPoE]</span> 
                                    <span style="color: #ecf0f1;">${msg}</span>
                                </div>`;
                    }
                    html += line;
                });

                displayArea.innerHTML = html;
            } catch (e) {
                console.error("Log load error:", e);
                displayArea.innerHTML = `<div style="color: #e74c3c;">Error loading logs: ${e.message}</div>`;
            }
        }

        async function verifyConfiguration() {
            const modal = document.getElementById('verify-modal');
            const resultsDiv = document.getElementById('verify-results');
            
            modal.style.display = 'flex';
            resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#666;"><i class="fas fa-spinner fa-spin"></i> Running system checks...</div>';
            
            try {
                const res = await fetch('/api/admin/system/verify', { credentials: 'include' });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);
                
                let html = '';
                data.checks.forEach(check => {
                    let icon = '';
                    let color = '';
                    
                    switch(check.status) {
                        case 'success':
                            icon = '<i class="fas fa-check-circle"></i>';
                            color = '#2ecc71';
                            break;
                        case 'warning':
                            icon = '<i class="fas fa-exclamation-triangle"></i>';
                            color = '#f1c40f';
                            break;
                        case 'error':
                            icon = '<i class="fas fa-times-circle"></i>';
                            color = '#e74c3c';
                            break;
                        default:
                            icon = '<i class="fas fa-info-circle"></i>';
                            color = '#3498db';
                    }
                    
                    html += `<div style="display:flex; align-items:center; margin-bottom:10px; padding:10px; background:#f8f9fa; border-radius:5px; border-left: 4px solid ${color};">
                        <div style="color:${color}; font-size:1.2rem; margin-right:15px; min-width:20px; text-align:center;">${icon}</div>
                        <div>
                            <div style="font-weight:600; color:#2c3e50;">${check.category}</div>
                            <div style="font-size:0.9rem; color:#555;">${check.message}</div>
                        </div>
                    </div>`;
                });
                
                resultsDiv.innerHTML = html;
                
            } catch (e) {
                console.error("Verification failed", e);
                resultsDiv.innerHTML = `<div style="color:#e74c3c; padding:20px; text-align:center;">
                    <i class="fas fa-exclamation-circle" style="font-size:2rem; margin-bottom:10px;"></i><br>
                    Verification failed: ${e.message}
                </div>`;
            }
        }

        // --- WiFi Config Logic ---
        async function loadWifiConfig() {
            try {
                const res = await fetch('/api/admin/wifi/config', { credentials: 'include' });
                const config = await res.json();
                
                document.getElementById('wifi-enabled').checked = config.enabled;
                document.getElementById('wifi-ssid').value = config.ssid || 'PISO_WIFI';
                document.getElementById('wifi-password').value = config.password || '';
                document.getElementById('wifi-channel').value = config.channel || 6;
                document.getElementById('wifi-hw-mode').value = config.hw_mode || 'g';
                
                // Toggle inputs based on enabled state
                toggleWifiInputs(config.enabled);
            } catch (e) {
                console.error('Error loading WiFi config:', e);
            }
        }

        document.getElementById('wifi-enabled').addEventListener('change', (e) => {
            toggleWifiInputs(e.target.checked);
        });

        function toggleWifiInputs(enabled) {
            const inputs = ['wifi-ssid', 'wifi-password', 'wifi-channel', 'wifi-hw-mode'];
            inputs.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
        }

        async function saveWifiConfig(e) {
            e.preventDefault();
            const enabled = document.getElementById('wifi-enabled').checked;
            const ssid = document.getElementById('wifi-ssid').value;
            const password = document.getElementById('wifi-password').value;
            const channel = parseInt(document.getElementById('wifi-channel').value);
            const hw_mode = document.getElementById('wifi-hw-mode').value;

            try {
                const res = await fetch('/api/admin/wifi/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, ssid, password, channel, hw_mode }),
                    credentials: 'include'
                });
                
                if (res.ok) {
                    alert('WiFi configuration saved. Access Point is restarting...');
                } else {
                    const err = await res.json();
                    alert('Error saving WiFi config: ' + err.error);
                }
            } catch (e) {
                console.error('Error saving WiFi config:', e);
                alert('Network error saving WiFi config');
            }
        }

        function createLastUpdatedElement() {
            const el = document.createElement('div');
            el.id = 'last-updated';
            el.style.position = 'fixed';
            el.style.bottom = '10px';
            el.style.right = '10px';
            el.style.background = 'rgba(0,0,0,0.5)';
            el.style.color = '#fff';
            el.style.padding = '5px 10px';
            el.style.borderRadius = '5px';
            el.style.fontSize = '12px';
            document.body.appendChild(el);
            return el;
        }

        let lastRx = 0;
        let lastTx = 0;
        let lastTime = Date.now();

        async function updateBandwidthChart() {
            try {
                const res = await fetch('/api/admin/network-stats', { credentials: 'include' });
                const stats = await res.json();
                
                // Find br0 interface specifically (Priority)
                let currentRx = 0;
                let currentTx = 0;
                let isLanInterface = false;
                
                const br0 = stats.find(i => i.interface === 'br0');
                if (br0) {
                    currentRx = br0.rx_bytes;
                    currentTx = br0.tx_bytes;
                    isLanInterface = true;
                } else {
                    // Fallback: sum up all non-lo interfaces (for Dev/Windows or if br0 missing)
                    stats.forEach(iface => {
                        if (iface.interface !== 'lo') {
                            currentRx += iface.rx_bytes;
                            currentTx += iface.tx_bytes;
                        }
                    });
                }

                const now = Date.now();
                const timeDiff = (now - lastTime) / 1000; // Seconds

                // Initialize lastRx/lastTx if 0 (first run or reset)
                if (lastRx === 0 && currentRx > 0) {
                    lastRx = currentRx;
                    lastTx = currentTx;
                    lastTime = now;
                    return; // Skip first update to avoid spike
                }

                if (timeDiff > 0) {
                    // Calculate speed in Mbps
                    let rxSpeed = 0;
                    let txSpeed = 0;
                    
                    if (currentRx >= lastRx) {
                        rxSpeed = Number(((currentRx - lastRx) * 8 / 1024 / 1024 / timeDiff).toFixed(2));
                    }
                    if (currentTx >= lastTx) {
                        txSpeed = Number(((currentTx - lastTx) * 8 / 1024 / 1024 / timeDiff).toFixed(2));
                    }
                    
                    // Sanity check for huge spikes
                    if (rxSpeed > 1000) rxSpeed = 0; 
                    if (txSpeed > 1000) txSpeed = 0;

                    // Map to Download/Upload based on Interface Type
                    // For LAN (br0): RX = Upload (from client), TX = Download (to client)
                    // For WAN: RX = Download (from internet), TX = Upload (to internet)
                    
                    let downloadSpeed, uploadSpeed;
                    
                    if (isLanInterface) {
                        downloadSpeed = txSpeed; // Router transmits to client
                        uploadSpeed = rxSpeed;   // Router receives from client
                    } else {
                        downloadSpeed = rxSpeed;
                        uploadSpeed = txSpeed;
                    }

                    // Update Chart if enabled
                    if (chartsEnabled && bwChart) {
                        const label = new Date(now).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        bwChart.data.labels.push(label);
                        bwChart.data.labels.shift();

                        // Input (Download) -> Positive
                        bwChart.data.datasets[0].data.push(downloadSpeed);
                        bwChart.data.datasets[0].data.shift();
                        
                        // Output (Upload) -> Negative (Mirrored)
                        bwChart.data.datasets[1].data.push(-Math.abs(uploadSpeed));
                        bwChart.data.datasets[1].data.shift();
                        
                        const maxAbs = Math.max(
                            ...bwChart.data.datasets[0].data.map(v => Math.abs(Number(v) || 0)),
                            ...bwChart.data.datasets[1].data.map(v => Math.abs(Number(v) || 0))
                        );
                        // Scale adjustment for Mbps
                        const raw = Math.max(1, maxAbs * 1.15);
                        let step = 1;
                        if (raw <= 5) step = 1;
                        else if (raw <= 10) step = 2;
                        else if (raw <= 50) step = 10;
                        else if (raw <= 100) step = 20;
                        else step = 50;

                        const nice = Math.ceil(raw / step) * step;
                        bwChart.options.scales.y.max = nice;
                        bwChart.options.scales.y.min = -nice;

                        bwChart.update();
                        
                        updateBwStats(bwChart.data.datasets[0].data, bwChart.data.datasets[1].data);
                    }
                    
                    // Update Text Fallback (always)
                    const bwText = document.getElementById('bw-text-fallback');
                    if (bwText) {
                        const rxMbps = parseFloat(rxSpeed).toFixed(2);
                        const txMbps = parseFloat(txSpeed).toFixed(2);
                        bwText.textContent = `DL: ${rxMbps} Mbps | UL: ${txMbps} Mbps`;
                    }
                }

                lastRx = currentRx;
                lastTx = currentTx;
                lastTime = now;
            } catch (e) {
                console.error("Chart error", e);
            }
        }

        function updateBwStats(rxData, txData) {
            // RX Data is positive
            const rxVals = rxData.map(v => parseFloat(v));
            const rxMin = Math.min(...rxVals);
            const rxMax = Math.max(...rxVals);
            const rxAvg = rxVals.reduce((a, b) => a + b, 0) / rxVals.length;
            const rxLast = rxVals[rxVals.length - 1];

            // TX Data is negative, convert to positive for stats
            const txVals = txData.map(v => Math.abs(parseFloat(v)));
            const txMin = Math.min(...txVals);
            const txMax = Math.max(...txVals);
            const txAvg = txVals.reduce((a, b) => a + b, 0) / txVals.length;
            const txLast = txVals[txVals.length - 1];

            // Helper to update DOM - Values are already in Mbps
            const set = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.textContent = val.toFixed(2) + ' Mbps';
            };

            set('rx-min', rxMin);
            set('rx-max', rxMax);
            set('rx-avg', rxAvg);
            set('rx-last', rxLast);

            set('tx-min', txMin);
            set('tx-max', txMax);
            set('tx-avg', txAvg);
            set('tx-last', txLast);
        }

        async function loadSalesData(type='daily') {
            currentSalesType = type;
            // Update active button state
            const btns = document.querySelectorAll('#view-sales button.btn-sm');
            if(btns.length > 0) {
                 btns.forEach(b => {
                     // specific match or fallback
                     const btnText = b.textContent.toLowerCase();
                     const isMatch = (type === 'history' && btnText.includes('all')) || 
                                   (type !== 'history' && btnText === type);
                                   
                     if(isMatch) {
                         b.classList.add('btn-primary');
                         b.style.background = '';
                     } else {
                         b.classList.remove('btn-primary');
                         b.style.background = '#eee';
                     }
                 });
            }

            const tableHead = document.querySelector('#sales-table thead tr');
            const tbody = document.querySelector('#sales-table tbody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';

            try {
                const res = await fetch('/api/admin/sales?type=' + type);
                if(res.status === 401) return location.reload();
                const data = await res.json();
                
                tbody.innerHTML = '';

                if (type === 'history') {
                    // History Mode: ID | Date/Time | MAC | Amount
                    tableHead.innerHTML = `
                        <th style="padding:10px;">ID</th>
                        <th style="padding:10px;">Date & Time</th>
                        <th style="padding:10px;">MAC Address</th>
                        <th style="padding:10px;">Amount</th>
                        <th style="padding:10px;">Source</th>
                    `;

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No transactions found</td></tr>';
                        await loadSalesByDevice(type);
                        return;
                    }

                    data.forEach(d => {
                        const tr = document.createElement('tr');
                        const date = new Date(d.timestamp).toLocaleString();
                        const amount = Number(d.amount) || 0;
                        const source = d.source || 'hardware';
                        tr.innerHTML = `
                            <td>${d.id}</td>
                            <td>${date}</td>
                            <td style="font-family:monospace;">${d.mac_address || 'Unknown'}</td>
                            <td style="font-weight:bold; color:var(--success);">â‚±${amount.toFixed(2)}</td>
                            <td style="font-family:monospace;">${source}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    await loadSalesByDevice(type);
                } else {
                    // Aggregated Mode: Date | Amount
                    tableHead.innerHTML = `<th>Date</th><th>Amount</th>`;
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">No sales data</td></tr>';
                        await loadSalesByDevice(type);
                        return;
                    }

                    data.forEach(d => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${d.label}</td><td style="font-weight:bold;">â‚±${d.value.toFixed(2)}</td>`;
                        tbody.appendChild(tr);
                    });

                    await loadSalesByDevice(type);
                }
            } catch (e) {
                console.error("Error loading sales:", e);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Error loading data</td></tr>';
            }
        }

        async function loadSalesByDevice(type='daily') {
            const tbody = document.querySelector('#sales-by-device-table tbody');
            if (!tbody) return;

            try {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading...</td></tr>';

                const res = await fetch('/api/admin/sales/by-device?type=' + type);
                if (res.status === 401) return location.reload();
                const rows = await res.json();

                tbody.innerHTML = '';
                if (!Array.isArray(rows) || rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No device sales data</td></tr>';
                    return;
                }

                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    const total = (Number(r.total) || 0).toFixed(2);
                    const daily = (Number(r.daily) || 0).toFixed(2);
                    const pending = (Number(r.pending) || 0).toFixed(2);
                    tr.innerHTML = `
                        <td>${r.name || r.source || '-'}</td>
                        <td style="font-weight:bold;">â‚±${total}</td>
                        <td>â‚±${daily}</td>
                        <td style="color:#e67e22; font-weight:600;">â‚±${pending}</td>
                        <td>
                            <button class="btn btn-sm" onclick="coinsOut('${r.source || ''}')">Coins Out</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading sales by device:", e);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Error loading device sales</td></tr>';
            }
        }

        async function coinsOut(source) {
            try {
                const res = await fetch('/api/admin/sales/coins-out', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source })
                });
                if (res.status === 401) return location.reload();
                
                if (!res.ok) {
                    const text = await res.text();
                    try {
                        const json = JSON.parse(text);
                        alert('Coins Out failed: ' + (json.error || text));
                    } catch (e) {
                        alert('Coins Out failed: ' + text.substring(0, 100));
                    }
                    return;
                }

                const data = await res.json();
                if (data && data.success) {
                    await loadSalesByDevice(currentSalesType || 'daily');
                } else {
                    alert('Coins Out failed');
                }
            } catch (e) {
                console.error('Coins Out error', e);
                alert('Coins Out error: ' + e.message);
            }
        }

        // --- Time & NTP Settings ---

        async function loadTimeSettings() {
            try {
                // Load Timezones first if empty
                const tzSelect = document.getElementById('timezone-select');
                if (tzSelect.options.length === 0) {
                    await loadTimezones();
                }

                const res = await fetch('/api/admin/system/time');
                const settings = await res.json();
                
                document.getElementById('time-sync-mode').value = settings.time_sync_mode || 'auto';
                document.getElementById('ntp-server').value = settings.ntp_server || 'pool.ntp.org';
                document.getElementById('timezone-mode').value = settings.timezone_mode || 'auto';
                document.getElementById('timezone-select').value = settings.timezone || 'Asia/Manila';
                
                if (settings.manual_datetime) {
                    document.getElementById('manual-datetime').value = settings.manual_datetime;
                }
                
                if (settings.current_system_time) {
                    startClock(settings.current_system_time);
                }

                toggleTimeInputs();
            } catch (e) {
                console.error("Error loading time settings", e);
            }
        }

        async function loadTimezones() {
            try {
                const res = await fetch('/api/admin/system/timezones');
                if (!res.ok) throw new Error('Failed to load timezones');
                
                const timezones = await res.json();
                if (!Array.isArray(timezones) || timezones.length === 0) throw new Error("Empty timezone list");

                const select = document.getElementById('timezone-select');
                select.innerHTML = '';
                
                timezones.forEach(tz => {
                    const opt = document.createElement('option');
                    opt.value = tz;
                    opt.textContent = tz;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error("Error loading timezones, using fallback", e);
                const select = document.getElementById('timezone-select');
                // Only populate fallback if empty
                if (select.options.length === 0) {
                    const fallbackTimezones = [
                        'Asia/Manila', 'Asia/Tokyo', 'Asia/Singapore', 'Asia/Shanghai', 
                        'America/New_York', 'Europe/London', 'UTC'
                    ];
                    select.innerHTML = '';
                    fallbackTimezones.forEach(tz => {
                        const opt = document.createElement('option');
                        opt.value = tz;
                        opt.textContent = tz; // + ' (Fallback)'
                        select.appendChild(opt);
                    });
                }
            }
        }

        function toggleTimeInputs() {
            const syncMode = document.getElementById('time-sync-mode').value;
            const tzMode = document.getElementById('timezone-mode').value;
            
            // Time Sync logic
            if (syncMode === 'auto') {
                document.getElementById('ntp-server-group').style.display = 'block';
                document.getElementById('manual-time-group').style.display = 'none';
            } else {
                document.getElementById('ntp-server-group').style.display = 'none';
                document.getElementById('manual-time-group').style.display = 'block';
            }

            // Timezone logic
            if (tzMode === 'auto') {
                document.getElementById('timezone-select-group').style.display = 'none';
            } else {
                document.getElementById('timezone-select-group').style.display = 'block';
            }
        }

        async function saveTimeSettings(e) {
            e.preventDefault();
            
            const data = {
                time_sync_mode: document.getElementById('time-sync-mode').value,
                ntp_server: document.getElementById('ntp-server').value.trim(),
                timezone_mode: document.getElementById('timezone-mode').value,
                timezone: document.getElementById('timezone-select').value,
                manual_datetime: document.getElementById('manual-datetime').value
            };
            
            try {
                const res = await fetch('/api/admin/system/time', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (res.status === 404) {
                    alert('Error: The Time Settings API was not found. Please RESTART the server to apply the latest updates.');
                    return;
                }

                const text = await res.text();
                
                if (res.ok) {
                    try {
                        // Attempt to parse JSON response
                        const json = text ? JSON.parse(text) : {};
                        alert('Time settings saved successfully. System time may update shortly.');
                        loadTimeSettings(); // Refresh to see updated time
                    } catch (parseErr) {
                        console.error('Invalid JSON response:', text);
                        alert('Settings saved, but server response was invalid.');
                    }
                } else {
                    try {
                        const err = JSON.parse(text);
                        alert('Error: ' + (err.error || text));
                    } catch (parseErr) {
                        alert('Server Error: ' + text);
                    }
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save time settings: ' + e.message);
            }
        }

        async function loadSettingsData() {
            const res = await fetch('/api/admin/settings');
            const settings = await res.json();
            const container = document.getElementById('settings-container');
            container.innerHTML = '';
            
            // Helper to create form group
            const createGroup = (label, input) => {
                const div = document.createElement('div');
                // Removed explicit marginBottom, handled by grid gap
                div.innerHTML = `<label style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1; font-size:0.85rem; color:#636e72;">${label}</label>`;
                div.appendChild(input);
                return div;
            };

            const createInput = (name, value, type='text', placeholder='') => {
                const i = document.createElement('input');
                i.id = name;
                i.name = name;
                i.value = value || '';
                i.type = type;
                i.placeholder = placeholder;
                i.autocomplete = 'off';
                i.style.width = '100%';
                i.style.padding = '3px 8px';
                i.style.border = '1px solid #dfe6e9';
                i.style.borderRadius = '4px';
                i.style.fontFamily = 'inherit';
                i.style.fontSize = '0.85rem';
                i.style.boxSizing = 'border-box';
                return i;
            };

            const createSelect = (name, value, options) => {
                const s = document.createElement('select');
                s.id = name;
                s.name = name;
                s.style.width = '100%';
                s.style.padding = '3px 8px';
                s.style.border = '1px solid #dfe6e9';
                s.style.borderRadius = '4px';
                s.style.fontFamily = 'inherit';
                s.style.fontSize = '0.85rem';
                s.style.background = '#fff';
                s.style.boxSizing = 'border-box';
                
                options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt;
                    o.textContent = opt;
                    if (opt === value) o.selected = true;
                    s.appendChild(o);
                });
                return s;
            };

            // 1. Vendo Selection Mode
            container.appendChild(createGroup('Vendo Selection Mode', createSelect('vendo_selection_mode', settings.vendo_selection_mode || 'auto', ['auto', 'manual'])));

            // 2. Coin Pin (Default 12)
            container.appendChild(createGroup('Coin Pin', createInput('coin_pin', settings.coin_pin || '12', 'number')));

            // 3. Coin Pin Edge (FALLING/RISING)
            container.appendChild(createGroup('Coin Pin Edge', createSelect('coin_pin_edge', settings.coin_pin_edge || 'FALLING', ['FALLING', 'RISING'])));

            // 4. Bill Pin (Optional)
            container.appendChild(createGroup('Bill Pin (Optional)', createInput('bill_pin', settings.bill_pin || '19', 'number', 'GPIO Pin (Default 19)')));

            // 5. Bill Pin Edge (FALLING/RISING)
            container.appendChild(createGroup('Bill Pin Edge', createSelect('bill_pin_edge', settings.bill_pin_edge || 'FALLING', ['FALLING', 'RISING'])));

            // 6. Bill Multiplier (x 1)
            container.appendChild(createGroup('Bill Multiplier (x)', createInput('bill_multiplier', settings.bill_multiplier || '1', 'number')));

            // 7. Relay Pin (Default 11)
            container.appendChild(createGroup('Relay Pin', createInput('relay_pin', settings.relay_pin || '11', 'number')));

            // 8. Relay Pin Active (LOW/HIGH)
            container.appendChild(createGroup('Relay Pin Active', createSelect('relay_pin_active', settings.relay_pin_active || 'HIGH', ['LOW', 'HIGH'])));

            // 9. Ban Counter (10 SEC)
            const banCounterInput = createInput('ban_limit_counter', settings.ban_limit_counter || '10', 'number');
            const banCounterGroup = createGroup('Insert Attempts Ban', banCounterInput);
            container.appendChild(banCounterGroup);

            // 10. Ban Duration (1 MINUTE)
            const banDurationInput = createInput('ban_duration', settings.ban_duration || '1', 'number');
            const banDurationGroup = createGroup('Ban Duration (minutes)', banDurationInput);
            container.appendChild(banDurationGroup);

            // 11. Session Timeout (Minutes)
            const sessionTimeoutInput = createInput('session_timeout_minutes', (settings.session_timeout_minutes || '30'), 'number', 'Default 30');
            container.appendChild(createGroup('Session Timeout (minutes)', sessionTimeoutInput));

            // 12. Idle Timeout (Seconds)
            const idleTimeoutInput = createInput('idle_timeout_seconds', (settings.idle_timeout_seconds || '120'), 'number', 'Default 120');
            container.appendChild(createGroup('Idle Timeout (seconds) [Pauses Session]', idleTimeoutInput));

            // 13. Keepalive Timeout (Seconds)
            const keepaliveTimeoutInput = createInput('keepalive_timeout_seconds', (settings.keepalive_timeout_seconds || '300'), 'number', 'Default 300');
            container.appendChild(createGroup('Keepalive Timeout (seconds) [Pauses Session]', keepaliveTimeoutInput));
        }

        async function saveSettings(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            // Validation
            const errors = [];
            const isPosInt = (val) => /^\d+$/.test(val) && parseInt(val) >= 0;

            // Check if we are saving Vendo Settings (indicated by presence of coin_pin)
            if ('coin_pin' in data) {
                if (!isPosInt(data.coin_pin)) errors.push("Coin Pin must be a valid positive number.");
                if (data.bill_pin && !isPosInt(data.bill_pin)) errors.push("Bill Pin must be a valid positive number.");
                if (!isPosInt(data.bill_multiplier) || parseInt(data.bill_multiplier) < 1) errors.push("Bill Multiplier must be at least 1.");
                if (!isPosInt(data.relay_pin)) errors.push("Relay Pin must be a valid positive number.");
                if (!isPosInt(data.ban_limit_counter)) errors.push("Insert Attempt Ban Counter must be a valid positive number.");
                if (!isPosInt(data.ban_duration)) errors.push("Ban Duration must be a valid positive number.");

                // Check for duplicate pins
                const pins = [data.coin_pin, data.bill_pin, data.relay_pin].filter(p => p && p.trim() !== '');
                const uniquePins = new Set(pins);
                if (pins.length !== uniquePins.size) {
                    errors.push("Duplicate GPIO pins detected. Coin, Bill, and Relay must use unique pins.");
                }
            }

            if (errors.length > 0) {
                alert("Validation Error:\n\n" + errors.join("\n"));
                return;
            }

            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('Configuration Saved');
                } else {
                    alert('Failed to save configuration');
                }
            } catch (err) {
                console.error("Save error:", err);
                alert('Error saving configuration');
            }
        }

        async function loadChatSettings() {
            try {
                const res = await fetch('/api/admin/settings');
                const settings = await res.json();
                
                // Match server logic: Enabled by default unless explicitly false
                const enabled = settings.chat_enabled !== 'false' && settings.chat_enabled !== false;
                
                const toggle = document.getElementById('chat-enabled-toggle');
                if (toggle) toggle.checked = enabled;
            } catch (e) {
                console.error("Chat settings load error", e);
            }
        }

        async function saveChatSettings(e) {
            if (e && e.type === 'submit') e.preventDefault();
            
            const toggle = document.getElementById('chat-enabled-toggle');
            const enabled = toggle ? toggle.checked : false;
            
            // Disable while saving
            if (toggle) toggle.disabled = true;

            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_enabled: enabled })
                });
                
                if (res.ok) {
                    console.log('Chat settings saved successfully');
                } else {
                    alert('Failed to save chat settings');
                    // Revert if failed
                    if (toggle) toggle.checked = !enabled;
                }
            } catch (e) {
                console.error("Chat settings save error", e);
                alert("Error saving chat settings");
                // Revert if failed
                if (toggle) toggle.checked = !enabled;
            } finally {
                if (toggle) toggle.disabled = false;
            }
        }

        async function loadPortalConfig() {
            try {
                const res = await fetch('/api/portal/config');
                const config = await res.json();
                
                document.getElementById('portal-container-width').value = config.container_max_width || 360;
                document.getElementById('portal-icon-size').value = config.icon_size || 36;
                document.getElementById('portal-status-container-size').value = config.status_icon_container_size || 38;
                document.getElementById('portal-banner-height').value = config.banner_height || 190;
                
                // Banner Settings
                document.getElementById('portal-use-default-banner').checked = config.use_default_banner || false;
                if (config.default_banner_file) {
                    document.getElementById('portal-default-banner-file').value = config.default_banner_file;
                }
                
                // Hide Voucher Code Setting
                const hideVoucherToggle = document.getElementById('portal-hide-voucher-code');
                if (hideVoucherToggle) {
                    hideVoucherToggle.checked = config.hide_voucher_code || false;
                }

                toggleBannerUpload();

            } catch (e) {
                console.error("Failed to load portal config", e);
            }
        }

        function toggleDrawer(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            card.classList.toggle('drawer-open');
            const content = card.querySelector('.drawer-content');
            if (card.classList.contains('drawer-open')) {
                content.style.maxHeight = content.scrollHeight + "px";
                // Allow dynamic height after transition
                setTimeout(() => {
                    if (card.classList.contains('drawer-open')) {
                        content.style.maxHeight = 'none';
                    }
                }, 300);
            } else {
                // Set fixed height first to allow transition
                content.style.maxHeight = content.scrollHeight + "px";
                setTimeout(() => {
                    content.style.maxHeight = null;
                }, 10);
            }
        }

        function toggleBannerUpload() {
            const useDefault = document.getElementById('portal-use-default-banner').checked;
            const uploadSection = document.getElementById('banner-upload-section');
            const selectorSection = document.getElementById('default-banner-selector');
            
            if (useDefault) {
                uploadSection.style.display = 'none';
                selectorSection.style.display = 'block';
            } else {
                uploadSection.style.display = 'block';
                selectorSection.style.display = 'none';
            }
        }

        async function savePortalConfig(event) {
            event.preventDefault();
            const containerWidth = document.getElementById('portal-container-width').value;
            const iconSize = document.getElementById('portal-icon-size').value;
            const statusContainerSize = document.getElementById('portal-status-container-size').value;
            const bannerHeight = document.getElementById('portal-banner-height').value;
            const useDefault = document.getElementById('portal-use-default-banner').checked;
            const defaultFile = document.getElementById('portal-default-banner-file').value;
            const hideVoucherCode = document.getElementById('portal-hide-voucher-code').checked;
            
            try {
                await fetch('/api/admin/portal-config', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        container_width: containerWidth,
                        icon_size: iconSize,
                        status_container_size: statusContainerSize,
                        banner_height: bannerHeight,
                        use_default_banner: useDefault,
                        default_banner_file: defaultFile,
                        hide_voucher_code: hideVoucherCode
                    })
                });
                alert('Portal config saved successfully');
            } catch (e) {
                console.error('Failed to save portal config:', e);
                alert('Failed to save portal config');
            }
        }

        async function uploadPortalBanner() {
            const fileInput = document.getElementById('portal-banner-upload');
            const file = fileInput.files[0];
            if (!file) return alert('Please select a banner image');
            
            // Limit file size to 2MB
            if (file.size > 2 * 1024 * 1024) return alert('File size must be less than 2MB');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                try {
                    const res = await fetch('/api/admin/upload-banner', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            image: base64Image,
                            type: file.type
                        })
                    });
                    
                    if (res.ok) {
                        alert('Banner uploaded successfully');
                        fileInput.value = '';
                    } else {
                        alert('Failed to upload banner');
                    }
                } catch (e) {
                    console.error('Failed to upload banner:', e);
                    alert('Failed to upload banner');
                }
            };
            reader.readAsDataURL(file);
        }



        // --- Firewall / AdBlocker Logic ---
        async function loadFirewallRules() {
            try {
                const res = await fetch('/api/admin/firewall/rules');
                const rules = await res.json();
                const tbody = document.querySelector('#firewall-table tbody');
                tbody.innerHTML = '';
                
                if (rules.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#777;">No active firewall rules.</td></tr>';
                    return;
                }

                rules.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold;">${r.port}</td>
                        <td><span class="badge" style="background:#6c757d; color:white;">${r.protocol.toUpperCase()}</span></td>
                        <td>${r.comment || '-'}</td>
                        <td style="font-size:0.85rem; color:#666;">${new Date(r.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteFirewallRule(${r.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading firewall rules", e);
            }
        }

        function showAddRuleModal() {
            document.getElementById('firewall-rule-modal').style.display = 'flex';
        }

        async function addFirewallRule() {
            const port = document.getElementById('fw-port').value;
            const protocol = document.getElementById('fw-protocol').value;
            const comment = document.getElementById('fw-comment').value;

            if (!port) {
                alert("Port is required");
                return;
            }

            try {
                const res = await fetch('/api/admin/firewall/rules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ port, protocol, comment })
                });

                if (res.ok) {
                    document.getElementById('firewall-rule-modal').style.display = 'none';
                    document.getElementById('fw-port').value = '';
                    document.getElementById('fw-comment').value = '';
                    loadFirewallRules();
                    alert("Rule added successfully. Traffic on port " + port + " is now blocked.");
                } else {
                    const data = await res.json();
                    alert("Failed to add rule: " + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error("Add Rule Error", e);
                alert("Error adding rule");
            }
        }

        async function deleteFirewallRule(id) {
            if (!await showConfirm("Are you sure you want to remove this rule?")) return;

            try {
                const res = await fetch(`/api/admin/firewall/rules/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadFirewallRules();
                } else {
                    alert("Failed to delete rule");
                }
            } catch (e) {
                console.error("Delete Rule Error", e);
            }
        }

        // Voucher Management Functions
        function openVoucherModal() {
            document.getElementById('voucher-modal').style.display = 'flex';
        }

        function closeVoucherModal() {
            document.getElementById('voucher-modal').style.display = 'none';
        }

        function toggleCustomVoucher() {
            const isRandom = document.getElementById('v-random').checked;
            const customInput = document.getElementById('v-custom');
            customInput.disabled = isRandom;
            customInput.style.opacity = isRandom ? 0.7 : 1;
        }

        // --- Voucher Bulk Actions ---
        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.voucher-select');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.voucher-select:checked');
            const btn = document.getElementById('btn-delete-selected');
            if (checkboxes.length > 0) {
                btn.style.display = 'block';
                btn.textContent = `Delete Selected (${checkboxes.length})`;
            } else {
                btn.style.display = 'none';
            }
        }

        async function deleteSelectedVouchers() {
            const checkboxes = document.querySelectorAll('.voucher-select:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (ids.length === 0) return;
            
            if (!await showConfirm(`Are you sure you want to delete ${ids.length} voucher(s)?`, true)) return;

            try {
                const res = await fetch('/api/admin/vouchers', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ids })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    alert(`Successfully deleted ${data.count} voucher(s).`);
                    loadVouchersData();
                    document.getElementById('select-all-vouchers').checked = false;
                    document.getElementById('btn-delete-selected').style.display = 'none';
                } else {
                    const errData = await res.json().catch(() => ({}));
                    alert(`Failed to delete vouchers: ${res.status} ${res.statusText} ${errData.error ? '- ' + errData.error : ''}`);
                }
            } catch (e) {
                console.error("Delete error", e);
                alert("Error deleting vouchers");
            }
        }

        async function loadVouchersData() {
            try {
                const res = await fetch('/api/admin/vouchers');
                if (res.status === 401) return location.reload();
                const vouchers = await res.json();
                const tbody = document.querySelector('#voucher-table tbody');
                tbody.innerHTML = '';
                vouchers.forEach(v => {
                    const tr = document.createElement('tr');
                    
                    // Format duration to dd/hh/mm
                    const d = Math.floor(v.duration / 86400);
                    const h = Math.floor((v.duration % 86400) / 3600);
                    const m = Math.floor((v.duration % 3600) / 60);
                    const durationStr = `${d > 0 ? d + 'd ' : ''}${h > 0 ? h + 'h ' : ''}${m}m`;

                    const status = v.is_used ? 'Used' : 'Active';
                    tr.innerHTML = `
                        <td style="padding:10px; border-bottom:1px solid #f1f2f6;"><input type="checkbox" class="voucher-select" value="${v.id}" onclick="updateDeleteButton()"></td>
                        <td style="padding:10px; border-bottom:1px solid #f1f2f6;">${v.code}</td>
                        <td style="padding:10px; border-bottom:1px solid #f1f2f6;">${durationStr}</td>
                        <td style="padding:10px; border-bottom:1px solid #f1f2f6;">${v.plan_name || 'Standard'}</td>
                        <td style="padding:10px; border-bottom:1px solid #f1f2f6;">â‚±${v.price || 0}.00</td>
                        <td style="padding:10px; border-bottom:1px solid #f1f2f6;">${status}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Voucher load error", e);
            }
        }

        async function generateVouchers() {
            try {
                const options = {
                    count: parseInt(document.getElementById('v-qty').value),
                    duration: (parseInt(document.getElementById('v-days').value || 0) * 1440) + 
                              (parseInt(document.getElementById('v-hours').value || 0) * 60) + 
                              parseInt(document.getElementById('v-minutes').value || 0),
                    plan_name: document.getElementById('v-name').value || 'Standard',
                    price: parseFloat(document.getElementById('v-price').value) || 0,
                    download_speed: parseInt(document.getElementById('v-dl').value) * 1024, // Convert Mbps to kbps
                    upload_speed: parseInt(document.getElementById('v-ul').value) * 1024, // Convert Mbps to kbps
                    is_random: document.getElementById('v-random').checked,
                    prefix: document.getElementById('v-prefix').value,
                    length: parseInt(document.getElementById('v-length').value),
                    custom_code: document.getElementById('v-custom').value
                };

                const res = await fetch('/api/admin/vouchers/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(options)
                });

                const data = await res.json();
                if (data.success) {
                    alert(`Generated ${data.codes.length} voucher(s): ${data.codes.join(', ')}`);
                    closeVoucherModal();
                    loadVouchersData();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (e) {
                console.error("Voucher generation error", e);
                alert("Failed to generate vouchers");
            }
        }

        async function loadInterfaces() {
            try {
                const res = await fetch('/api/admin/network-interfaces');
                if (res.status === 401) return location.reload();
                const interfaces = await res.json();
                const tbody = document.querySelector('#interfaces-table tbody');
                tbody.innerHTML = '';
                
                if (interfaces.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No interfaces found</td></tr>';
                    return;
                }

                interfaces.forEach(iface => {
                    if (iface.name === 'lo') return; // Hide loopback
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:600; color:#2d3436;">${iface.name}</td>
                        <td>${iface.ip}</td>
                        <td style="font-family:monospace;">${iface.mac}</td>
                        <td>${iface.netmask}</td>
                        <td>${iface.family}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Interfaces load error", e);
            }
        }

        // Init
        checkAuth();

        // --- Pull to Refresh Logic (Touch & Mouse) ---
        const contentScroll = document.querySelector('.content-scroll');
        const ptr = document.getElementById('pull-to-refresh');
        const ptrIcon = ptr.querySelector('.ptr-icon');
        const ptrText = ptr.querySelector('.ptr-text');

        let startY = 0;
        let isPulling = false;
        let isRefreshing = false;

        const handleStart = (y) => {
            if (contentScroll.scrollTop === 0) {
                startY = y;
                isPulling = true;
            }
        };

        const handleMove = (y) => {
            if (!isPulling || isRefreshing) return;
            const diff = y - startY;

            if (diff > 0 && contentScroll.scrollTop === 0) {
                // Resistance
                const move = Math.min(diff * 0.5, 80);
                ptr.style.marginTop = `${move - 50}px`; // -50 is hidden
                
                if (move > 40) {
                    ptrText.textContent = 'Release to refresh';
                    ptrIcon.classList.add('rotate');
                } else {
                    ptrText.textContent = 'Pull to refresh';
                    ptrIcon.classList.remove('rotate');
                }
            } else {
                isPulling = false;
                ptr.style.marginTop = '-50px';
            }
        };

        const handleEnd = async () => {
            if (!isPulling || isRefreshing) return;
            isPulling = false;
            
            if (ptrIcon.classList.contains('rotate')) {
                isRefreshing = true;
                ptr.style.marginTop = '0px';
                ptrText.textContent = 'Reloading...';
                ptrIcon.classList.remove('rotate');
                ptrIcon.classList.add('spin');
                
                // Full page refresh as requested
                location.reload();
            } else {
                ptr.style.marginTop = '-50px';
            }
        };

        // Touch Events
        contentScroll.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientY), { passive: true });
        contentScroll.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientY), { passive: true });
        contentScroll.addEventListener('touchend', handleEnd);

        // Mouse Events
        contentScroll.addEventListener('mousedown', (e) => handleStart(e.clientY));
        contentScroll.addEventListener('mousemove', (e) => {
            if(isPulling && e.buttons === 1) handleMove(e.clientY);
            else if(isPulling) { isPulling = false; ptr.style.marginTop = '-50px'; }
        });
        contentScroll.addEventListener('mouseup', handleEnd);
        contentScroll.addEventListener('mouseleave', () => {
            if(isPulling) { isPulling = false; ptr.style.marginTop = '-50px'; }
        });

        // --- ZeroTier Integration ---
        async function loadZeroTierStatus() {
            const badge = document.getElementById('zt-status-badge');
            const infoArea = document.getElementById('zt-info-area');
            const networksList = document.getElementById('zt-networks-list');
            
            if (!badge) return;

            try {
                const res = await fetch('/api/admin/network/zerotier');
                const data = await res.json();

                if (!data.installed) {
                    badge.style.background = '#d63031';
                    badge.textContent = 'Not Installed';
                    infoArea.style.display = 'none';
                    return;
                }

                // Update Status Badge
                if (data.online) {
                    badge.style.background = '#00b894';
                    badge.textContent = 'Online';
                } else {
                    badge.style.background = '#fdcb6e';
                    badge.textContent = 'Offline';
                }

                // Update Info Area
                infoArea.style.display = 'block';
                document.getElementById('zt-version').textContent = data.version || 'Unknown';
                document.getElementById('zt-device-id').textContent = data.deviceId || 'Unknown';
                document.getElementById('zt-status-text').textContent = data.online ? 'ONLINE' : 'OFFLINE';

                // Update Networks List
                networksList.innerHTML = '';
                if (data.networks && data.networks.length > 0) {
                    data.networks.forEach(net => {
                        const row = document.createElement('div');
                        row.style.background = '#f9f9f9';
                        row.style.padding = '10px';
                        row.style.borderRadius = '4px';
                        row.style.marginBottom = '8px';
                        row.style.border = '1px solid #eee';
                        row.style.display = 'flex';
                        row.style.justifyContent = 'space-between';
                        row.style.alignItems = 'center';
                        
                        row.innerHTML = `
                            <div>
                                <div style="font-weight:bold; color:#2d3436;">${net.name || net.id}</div>
                                <div style="font-size:0.8rem; color:#636e72;">
                                    ID: ${net.id} | Status: <span style="color:${net.status === 'OK' ? '#00b894' : '#d63031'}">${net.status}</span>
                                </div>
                                <div style="font-size:0.8rem; color:#636e72;">IP: ${net.ip || 'None'}</div>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="leaveZeroTier('${net.id}')">Leave</button>
                        `;
                        networksList.appendChild(row);
                    });
                } else {
                    networksList.innerHTML = '<div style="font-size:0.85rem; color:#b2bec3; text-align:center; padding:10px;">Not joined to any networks</div>';
                }

            } catch (e) {
                console.error("ZeroTier status error", e);
                badge.style.background = '#d63031';
                badge.textContent = 'Error';
            }
        }

        async function joinZeroTier() {
            const input = document.getElementById('zt-network-id');
            const networkId = input.value.trim();
            
            if (networkId.length !== 16) {
                alert("Invalid Network ID. It must be 16 characters.");
                return;
            }

            const btn = document.querySelector('button[onclick="joinZeroTier()"]');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Joining...';

            try {
                const res = await fetch('/api/admin/network/zerotier/join', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ networkId })
                });

                if (res.ok) {
                    alert("Joined network! It may take a few seconds to appear.");
                    input.value = '';
                    loadZeroTierStatus();
                } else {
                    const err = await res.json();
                    alert("Failed to join: " + (err.error || "Unknown error"));
                }
            } catch (e) {
                alert("Error joining network");
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function leaveZeroTier(networkId) {
            if (!await showConfirm(`Are you sure you want to leave network ${networkId}?`, true)) return;

            try {
                 const res = await fetch('/api/admin/network/zerotier/leave', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ networkId })
                });

                if (res.ok) {
                    loadZeroTierStatus();
                } else {
                    alert("Failed to leave network");
                }
            } catch (e) {
                alert("Error leaving network");
            }
        }

        // --- Network Configuration ---
        // --- Walled Garden ---
        async function loadWalledGarden() {
            try {
                const res = await fetch('/api/admin/walled-garden');
                const list = await res.json();
                
                const tbody = document.querySelector('#wg-table tbody');
                tbody.innerHTML = '';
                
                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No entries found</td></tr>';
                    return;
                }

                list.forEach(item => {
                    const tr = document.createElement('tr');
                    let badgeClass = 'badge-secondary';
                    if (item.type === 'ACCEPT' || item.type === 'allow') badgeClass = 'badge-success';
                    if (item.type === 'DROP' || item.type === 'deny') badgeClass = 'badge-danger';
                    
                    tr.innerHTML = `
                        <td>${item.domain}</td>
                        <td><span class="badge ${badgeClass}">${item.type.toUpperCase()}</span></td>
                        <td>${item.address || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteWalledGarden(${item.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading walled garden:", e);
            }
        }

        async function addWalledGarden() {
            const domain = document.getElementById('wg-modal-domain').value.trim();
            const type = document.getElementById('wg-modal-type').value;
            
            if (!domain) return alert('Domain is required');
            
            try {
                const res = await fetch('/api/admin/walled-garden', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ domain, type })
                });
                
                if (res.ok) {
                    closeWalledGardenModal();
                    loadWalledGarden();
                } else {
                    const data = await res.json();
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                console.error("Error adding entry:", e);
                alert("Failed to add entry");
            }
        }

        function openWalledGardenModal() {
            document.getElementById('wg-modal-domain').value = '';
            document.getElementById('wg-modal-type').value = 'allow';
            document.getElementById('walled-garden-modal').style.display = 'flex';
        }

        function closeWalledGardenModal() {
            document.getElementById('walled-garden-modal').style.display = 'none';
        }

        async function deleteWalledGarden(id) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            
            try {
                const res = await fetch('/api/admin/walled-garden/' + id, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    loadWalledGarden();
                } else {
                    alert('Failed to delete entry');
                }
            } catch (e) {
                console.error("Error deleting entry:", e);
            }
        }

        async function loadNetworkConfig() {
            updateWanStatus(); // Check status on load
            loadZeroTierStatus(); // Check ZeroTier status
            try {
                // Load Interfaces for Dropdown
                const resIfaces = await fetch('/api/admin/network-interfaces');
                const interfaces = await resIfaces.json();
                window.cachedInterfaces = interfaces;

                // Load Configured VLANs
                const resVlans = await fetch('/api/admin/network/vlans');
                const vlans = await resVlans.json();
                window.cachedVlans = vlans;

                // Load Configured Bridges (Safe Load) - REMOVED redundant fetch
                // Bridges are loaded via loadBridges() later
                let bridges = []; 


                // --- Build Visual Interface Map ---
                visualInterfaceMap = {};
                let enxCounter = 1;
                
                // Sort by name to ensure consistent ordering for enx mapping
                interfaces.sort((a, b) => a.name.localeCompare(b.name));
                
                interfaces.forEach(iface => {
                    const name = iface.name;
                    if (name === 'end0') {
                        visualInterfaceMap[name] = 'eth0';
                    } else if (name.startsWith('enx')) {
                        visualInterfaceMap[name] = 'eth' + enxCounter++;
                    } else {
                        visualInterfaceMap[name] = name;
                    }
                });
                window.visualInterfaceMap = visualInterfaceMap;

                const select = document.getElementById('wan-interface');
                select.innerHTML = '<option value="" disabled>Select Interface</option>';
                
                const vlanSelect = document.getElementById('vlan-parent');
                vlanSelect.innerHTML = '<option value="" disabled selected>Select Parent Interface</option>';

                // 1. Add Physical Interfaces
                interfaces.forEach(iface => {
                    // Skip loopback
                    if (iface.name === 'lo') return;

                    const opt = document.createElement('option');
                    opt.value = iface.name;
                    // Use Visual Name
                    const visualName = visualInterfaceMap[iface.name] || iface.name;
                    opt.textContent = `${visualName} (${iface.mac || 'No MAC'})`;
                    select.appendChild(opt);
                    
                    // Also populate VLAN parent dropdown
                    const vlanOpt = opt.cloneNode(true);
                    vlanSelect.appendChild(vlanOpt);
                });
                
                const dualWan1Select = document.getElementById('dual-wan1-iface');
                const dualWan2Select = document.getElementById('dual-wan2-iface');
                if (dualWan1Select) populateInterfaceSelect(dualWan1Select, interfaces, visualInterfaceMap);
                if (dualWan2Select) populateInterfaceSelect(dualWan2Select, interfaces, visualInterfaceMap);

                // 2. Add VLAN Interfaces (to WAN dropdown only)
                if (vlans && vlans.length > 0) {
                     const group = document.createElement('optgroup');
                     group.label = "VLAN Interfaces";
                     
                     vlans.forEach(v => {
                         const parentVisual = visualInterfaceMap[v.parent] || v.parent;
                         const vlanName = `${parentVisual}.${v.vlanId}`;
                         const opt = document.createElement('option');
                         opt.value = `${v.parent}.${v.vlanId}`; // Keep real value
                         opt.textContent = `${vlanName} (VLAN ${v.vlanId})`;
                         group.appendChild(opt);
                     });
                     select.appendChild(group);
                }

                // Load Current Config
                const resConfig = await fetch('/api/admin/network/wan');
                if (resConfig.ok) {
                    const config = await resConfig.json();
                    
                    if (config.interface) {
                        let targetValue = config.interface;
                        
                        // Check if option with this value exists
                        let exists = Array.from(select.options).some(opt => opt.value === targetValue);

                        if (!exists) {
                            // Check if config matches a visual name (e.g. config 'eth0' vs real 'end0')
                            const realNameEntry = Object.entries(visualInterfaceMap).find(([real, visual]) => visual === config.interface);
                            if (realNameEntry) {
                                targetValue = realNameEntry[0]; // Use the real interface name
                                exists = true;
                            }
                        }

                        if (!exists) {
                            // Only add if truly missing (neither real name nor visual name match)
                            const opt = document.createElement('option');
                            opt.value = config.interface;
                            opt.textContent = config.interface;
                            select.appendChild(opt);
                        }
                        select.value = targetValue;
                    }
                    if (config.mode) document.getElementById('wan-mode').value = config.mode;
                    
                    // Dual WAN Config
                    if (config.dual_wan) {
                        const dw = config.dual_wan;
                        if(dw.strategy) document.getElementById('dual-strategy').value = dw.strategy;
                        
                        if(dw.wan1) {
                            if(dw.wan1.interface) document.getElementById('dual-wan1-iface').value = dw.wan1.interface;
                            if(dw.wan1.type) document.getElementById('dual-wan1-type').value = dw.wan1.type;
                            toggleDualWanFields('wan1');
                            if(dw.wan1.static) {
                                document.getElementById('dual-wan1-ip').value = dw.wan1.static.ip || '';
                                document.getElementById('dual-wan1-gateway').value = dw.wan1.static.gateway || '';
                                document.getElementById('dual-wan1-netmask').value = dw.wan1.static.netmask || '';
                                document.getElementById('dual-wan1-dns').value = dw.wan1.static.dns || '';
                            }
                            if(dw.wan1.pppoe) {
                                document.getElementById('dual-wan1-user').value = dw.wan1.pppoe.username || '';
                                document.getElementById('dual-wan1-pass').value = dw.wan1.pppoe.password || '';
                            }
                        }
                        
                        if(dw.wan2) {
                            if(dw.wan2.interface) document.getElementById('dual-wan2-iface').value = dw.wan2.interface;
                            if(dw.wan2.type) document.getElementById('dual-wan2-type').value = dw.wan2.type;
                            toggleDualWanFields('wan2');
                            if(dw.wan2.static) {
                                document.getElementById('dual-wan2-ip').value = dw.wan2.static.ip || '';
                                document.getElementById('dual-wan2-gateway').value = dw.wan2.static.gateway || '';
                                document.getElementById('dual-wan2-netmask').value = dw.wan2.static.netmask || '';
                                document.getElementById('dual-wan2-dns').value = dw.wan2.static.dns || '';
                            }
                            if(dw.wan2.pppoe) {
                                document.getElementById('dual-wan2-user').value = dw.wan2.pppoe.username || '';
                                document.getElementById('dual-wan2-pass').value = dw.wan2.pppoe.password || '';
                            }
                        }
                    }

                    // Multi WAN Config
                    if (config.multi_wan && Array.isArray(config.multi_wan)) {
                        const tbody = document.querySelector('#multi-wan-table tbody');
                        tbody.innerHTML = '';
                        config.multi_wan.forEach(wan => addMultiWanRow(wan));
                    }

                    // Static
                    if (config.static) {
                        document.getElementById('wan-ip').value = config.static.ip || '';
                        document.getElementById('wan-netmask').value = config.static.netmask || '';
                        document.getElementById('wan-gateway').value = config.static.gateway || '';
                        document.getElementById('wan-dns1').value = config.static.dns1 || '';
                        document.getElementById('wan-dns2').value = config.static.dns2 || '';
                    }

                    // PPPoE
                    if (config.pppoe) {
                        document.getElementById('pppoe-user').value = config.pppoe.username || '';
                        document.getElementById('pppoe-pass').value = config.pppoe.password || '';
                        document.getElementById('pppoe-dns1').value = config.pppoe.dns1 || '';
                        document.getElementById('pppoe-dns2').value = config.pppoe.dns2 || '';
                    }
                }
                
                toggleWanMode();
                loadVlans();
                loadBridges();
                loadDhcpServers();

                // Populate Bridge Interface Checkboxes
                const bridgeInterfacesDiv = document.getElementById('bridge-interfaces');
                if (bridgeInterfacesDiv) {
                    bridgeInterfacesDiv.innerHTML = '';
                    interfaces.forEach(iface => {
                        // Skip loopback
                        if (iface.name === 'lo') return;
                        
                        const visualName = visualInterfaceMap[iface.name] || iface.name;
                        const wrapper = document.createElement('div');
                        wrapper.style.display = 'flex';
                        wrapper.style.alignItems = 'center';
                        wrapper.style.gap = '5px';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = iface.name;
                        checkbox.id = `br-iface-${iface.name}`;
                        checkbox.style.transform = 'scale(1.2)';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `br-iface-${iface.name}`;
                        label.textContent = visualName;
                        label.style.fontSize = '0.9rem';
                        label.style.cursor = 'pointer';
                        
                        wrapper.appendChild(checkbox);
                        wrapper.appendChild(label);
                        bridgeInterfacesDiv.appendChild(wrapper);
                    });
                }
            } catch (e) {
                console.error("Network config load error", e);
            }
        }

        function netmaskToCidr(mask) {
            if (!mask) return '';
            const parts = mask.split('.').map(Number);
            if (parts.length !== 4 || parts.some(p => isNaN(p))) return '';
            let cidr = 0;
            parts.forEach(p => {
                const bin = p.toString(2);
                for (let i = 0; i < bin.length; i++) {
                    if (bin[i] === '1') cidr++;
                }
            });
            return cidr;
        }

        function cidrToSize(cidr) {
            const n = parseInt(cidr, 10);
            if (isNaN(n) || n < 0 || n > 32) return '';
            const hostBits = 32 - n;
            if (hostBits <= 0) return 1;
            return Math.pow(2, hostBits);
        }

        function ipToInt(ip) {
            const parts = String(ip || '').split('.').map(Number);
            if (parts.length !== 4 || parts.some(p => isNaN(p))) return 0;
            return ((parts[0] << 24) >>> 0) + (parts[1] << 16) + (parts[2] << 8) + parts[3];
        }

        function intToIp(num) {
            const n = num >>> 0;
            return [
                (n >>> 24) & 255,
                (n >>> 16) & 255,
                (n >>> 8) & 255,
                n & 255
            ].join('.');
        }

        function cidrToMaskInt(cidr) {
            const n = parseInt(cidr, 10);
            if (isNaN(n) || n < 0 || n > 32) return 0;
            if (n === 0) return 0;
            return (0xffffffff << (32 - n)) >>> 0;
        }

        function computeNextDhcpSubnet() {
            const bitmaskInput = document.getElementById('dhcp-bitmask');
            let cidr = parseInt(bitmaskInput && bitmaskInput.value ? bitmaskInput.value : '19', 10);
            if (isNaN(cidr) || cidr < 8 || cidr > 30) cidr = 19;

            const baseInt = ipToInt('10.0.0.0');
            const maskInt = cidrToMaskInt(cidr);
            const blockSize = Math.pow(2, 32 - cidr);

            const servers = window.cachedDhcpServers || [];
            const usedNets = new Set();
            servers.forEach(s => {
                if (!s || !s.ip) return;
                const ipInt = ipToInt(s.ip);
                const netInt = (ipInt & maskInt) >>> 0;
                usedNets.add(String(netInt));
            });

            let chosenNet = null;
            for (let idx = 0; idx < 256; idx++) {
                const netInt = (baseInt + idx * blockSize) >>> 0;
                if (idx === 0) continue;
                if (!usedNets.has(String(netInt))) {
                    chosenNet = netInt;
                    break;
                }
            }

            if (chosenNet === null) return null;

            const base = intToIp(chosenNet);
            const firstInt = chosenNet + 1;
            const broadcastInt = chosenNet + blockSize - 1;
            const lastInt = broadcastInt - 1;
            const mask = intToIp(maskInt);
            const hostmaskInt = (~maskInt) >>> 0;
            const hostmask = intToIp(hostmaskInt);

            return {
                cidr,
                maskInt,
                netInt: chosenNet >>> 0,
                size: blockSize,
                base,
                mask,
                hostmask,
                first: intToIp(firstInt),
                last: intToIp(lastInt),
                broadcast: intToIp(broadcastInt)
            };
        }

        async function loadVlans() {
            try {
                const res = await fetch('/api/admin/network/vlans');
                const vlans = await res.json();
                const tbody = document.querySelector('#vlan-table tbody');
                const freeTimeSelect = document.getElementById('free-time-vlan');
                if (tbody) tbody.innerHTML = '';
                if (freeTimeSelect) {
                    freeTimeSelect.innerHTML = '';
                    const mainOpt = document.createElement('option');
                    mainOpt.value = 'eth0';
                    mainOpt.textContent = 'Main LAN (eth0)';
                    freeTimeSelect.appendChild(mainOpt);
                    const br0Opt = document.createElement('option');
                    br0Opt.value = 'br0';
                    br0Opt.textContent = 'Bridge (br0)';
                    freeTimeSelect.appendChild(br0Opt);
                }
                
                if (vlans.length === 0) {
                    if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No VLANs configured</td></tr>';
                    return;
                }

                vlans.forEach(v => {
                    const tr = document.createElement('tr');
                    const parentVisual = (window.visualInterfaceMap && window.visualInterfaceMap[v.parent]) || v.parent;
                    const name = v.name || `vlan.${v.vlanId}`;
                    const mac = v.mac || '-';
                    tr.innerHTML = `
                        <td>${name}</td>
                        <td>${parentVisual}</td>
                        <td>${mac}</td>
                        <td>${v.vlanId}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeVlan('${v.id}')">Delete</button></td>
                    `;
                    if (tbody) tbody.appendChild(tr);

                    if (freeTimeSelect) {
                        const ifaceName = v.parent === 'end0' ? `eth0.${v.vlanId}` : `${v.parent}.${v.vlanId}`;
                        const opt = document.createElement('option');
                        opt.value = ifaceName;
                        opt.textContent = `${parentVisual}.${v.vlanId}`;
                        freeTimeSelect.appendChild(opt);
                    }
                });
            } catch (e) {
                console.error("Error loading VLANs", e);
            }
        }

        async function loadDhcpServers() {
            try {
                const res = await fetch('/api/admin/network/dhcp');
                if (!res.ok) return;
                const data = await res.json();
                const bitmaskInput = document.getElementById('dhcp-bitmask');
                const maxServersInput = document.getElementById('dhcp-max-servers');
                if (bitmaskInput) bitmaskInput.value = data.bitmask || '';
                if (maxServersInput) maxServersInput.value = data.maxServers || '';

                const tbody = document.querySelector('#dhcp-table tbody');
                if (!tbody) return;
                const servers = Array.isArray(data.servers) ? data.servers : [];
                window.cachedDhcpServers = servers;
                tbody.innerHTML = '';

                if (servers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No DHCP scopes configured</td></tr>';
                    return;
                }

                servers.forEach(s => {
                    const tr = document.createElement('tr');
                    const ifaceVisual = visualInterfaceMap[s.interface] || s.interface;
                    const cidr = s.netmask ? netmaskToCidr(s.netmask) : '';
                    const address = s.ip && cidr ? `${s.ip}/${cidr}` : (s.ip || '-');
                    const pool = s.poolStart && s.poolEnd ? `${s.poolStart}-${s.poolEnd}` : '-';
                    const size = cidr ? cidrToSize(cidr) : '';
                    const dns = [s.dns1, s.dns2].filter(Boolean).join(' ') || '-';
                    tr.innerHTML = `
                        <td>${ifaceVisual}</td>
                        <td>${address}</td>
                        <td>${pool}</td>
                        <td>${s.netmask || '-'}</td>
                        <td>${size || '-'}</td>
                        <td>${dns}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeDhcpServer('${s.id}')">Delete</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading DHCP servers", e);
            }
        }

        async function saveDhcpGlobals() {
            const bitmask = document.getElementById('dhcp-bitmask').value;
            const maxServers = document.getElementById('dhcp-max-servers').value;
            try {
                const res = await fetch('/api/admin/network/dhcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bitmask, maxServers })
                });
                if (!res.ok) {
                    alert("Failed to save DHCP globals");
                    return;
                }
                alert("DHCP settings saved.");
            } catch (e) {
                console.error("Save DHCP globals error", e);
            }
        }

        function openDhcpModal() {
            const modal = document.getElementById('dhcp-modal');
            const select = document.getElementById('dhcp-interface');
            if (!modal || !select) return;
            select.innerHTML = '<option value="" disabled selected>Select Interface</option>';
            const interfaces = window.cachedInterfaces || [];
            const seen = new Set();
            interfaces.forEach(iface => {
                if (iface.name === 'lo') return;
                if (seen.has(iface.name)) return;
                seen.add(iface.name);
                const opt = document.createElement('option');
                opt.value = iface.name;
                const visualName = visualInterfaceMap[iface.name] || iface.name;
                opt.textContent = visualName;
                select.appendChild(opt);
            });
            const vlans = window.cachedVlans || [];
            if (vlans.length > 0) {
                const group = document.createElement('optgroup');
                group.label = "VLAN Interfaces";
                vlans.forEach(v => {
                    const parentVisual = visualInterfaceMap[v.parent] || v.parent;
                    const vlanName = `${v.parent}.${v.vlanId}`;
                    const label = `${parentVisual}.${v.vlanId}`;
                    if (seen.has(vlanName)) return;
                    seen.add(vlanName);
                    const opt = document.createElement('option');
                    opt.value = vlanName;
                    opt.textContent = label;
                    group.appendChild(opt);
                });
                select.appendChild(group);
            }
            document.getElementById('dhcp-ip').value = '';
            document.getElementById('dhcp-netmask').value = '255.255.255.0';
            document.getElementById('dhcp-pool-start').value = '';
            document.getElementById('dhcp-pool-end').value = '';
            document.getElementById('dhcp-dns1').value = '8.8.8.8';
            document.getElementById('dhcp-dns2').value = '8.8.4.4';
            const subnet = computeNextDhcpSubnet();
            const infoEl = document.getElementById('dhcp-subnet-info');
            if (subnet) {
                document.getElementById('dhcp-ip').value = subnet.first;
                document.getElementById('dhcp-netmask').value = subnet.mask;
                document.getElementById('dhcp-pool-start').value = subnet.first;
                document.getElementById('dhcp-pool-end').value = subnet.last;
                if (infoEl) {
                    const info = [
                        `bitmask: ${subnet.cidr}`,
                        `maskLong: ${subnet.maskInt}`,
                        `netLong: ${subnet.netInt}`,
                        `size: ${subnet.size}`,
                        `base: ${subnet.base}`,
                        `mask: ${subnet.mask}`,
                        `hostmask: ${subnet.hostmask}`,
                        `first: ${subnet.first}`,
                        `last: ${subnet.last}`,
                        `broadcast: ${subnet.broadcast}`
                    ].join('\n');
                    infoEl.textContent = info;
                }
            } else if (infoEl) {
                infoEl.textContent = '';
            }
            modal.style.display = 'flex';
        }

        async function addDhcpServer() {
            const iface = document.getElementById('dhcp-interface').value;
            const ip = document.getElementById('dhcp-ip').value;
            const netmask = document.getElementById('dhcp-netmask').value;
            const poolStart = document.getElementById('dhcp-pool-start').value;
            const poolEnd = document.getElementById('dhcp-pool-end').value;
            const dns1 = document.getElementById('dhcp-dns1').value;
            const dns2 = document.getElementById('dhcp-dns2').value;

            if (!iface || !ip || !netmask || !poolStart || !poolEnd) {
                alert("Interface, IP, Netmask, Pool Start and Pool End are required.");
                return;
            }

            const payload = { interface: iface, ip, netmask, poolStart, poolEnd, dns1, dns2 };

            try {
                const res = await fetch('/api/admin/network/dhcp/servers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    alert("Failed to add DHCP scope.");
                    return;
                }
                alert("DHCP scope added.");
                document.getElementById('dhcp-modal').style.display = 'none';
                loadDhcpServers();
            } catch (e) {
                console.error("Add DHCP scope error", e);
            }
        }

        async function removeDhcpServer(id) {
            if (!await showConfirm("Are you sure you want to delete this DHCP scope?", true)) return;
            try {
                const res = await fetch(`/api/admin/network/dhcp/servers/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    alert("Failed to delete DHCP scope.");
                    return;
                }
                loadDhcpServers();
            } catch (e) {
                console.error("Delete DHCP scope error", e);
            }
        }

        async function addVlan() {
            const vlan = {
                parent: document.getElementById('vlan-parent').value,
                vlanId: document.getElementById('vlan-id').value,
                macGenerate: document.getElementById('vlan-mac-generate').value === 'true'
            };

            if (!vlan.parent || !vlan.vlanId) {
                alert("Parent Interface and VLAN ID are required.");
                return;
            }

            try {
                const res = await fetch('/api/admin/network/vlans', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(vlan)
                });
                
                if (res.ok) {
                    alert("VLAN added successfully.");
                    document.getElementById('vlan-modal').style.display = 'none';
                    loadVlans();
                    // Clear form
                    document.getElementById('vlan-id').value = '';
                } else {
                    alert("Failed to add VLAN.");
                }
            } catch (e) {
                console.error("Add VLAN error", e);
            }
        }

        async function removeVlan(id) {
            if(!await showConfirm("Are you sure you want to delete this VLAN?", true)) return;
            
            try {
                const res = await fetch(`/api/admin/network/vlans/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadVlans();
                } else {
                    alert("Failed to delete VLAN.");
                }
            } catch (e) {
                console.error("Delete VLAN error", e);
            }
        }

        // --- Bridge Functions ---
        let editingBridgeName = null;

        async function loadBridges() {
            try {
                const res = await fetch('/api/admin/network/bridges');
                let bridges = await res.json();
                
                // Ensure default bridge br0 is listed
                const defaultBridge = bridges.find(b => b.name === 'br0');
                if (!defaultBridge) {
                    bridges.unshift({
                        name: 'br0',
                        interfaces: ['eth0'], // Assumed default
                        ip: '10.0.0.1',
                        netmask: '255.255.255.0',
                        stp: true
                    });
                }

                const tbody = document.querySelector('#bridge-table tbody');
                tbody.innerHTML = '';
                
                if (bridges.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No bridges configured</td></tr>';
                    return;
                }

                bridges.forEach(b => {
                    const tr = document.createElement('tr');
                    // Handle interfaces list safely
                    const ifaceList = Array.isArray(b.interfaces) ? b.interfaces : [];
                    const members = ifaceList.map(i => visualInterfaceMap[i] || i).join(', ') || '-';
                    
                    let deleteBtn = `<button class="btn btn-sm btn-danger" onclick="removeBridge('${b.name}')">Delete</button>`;
                    let editBtn = `<button class="btn btn-sm btn-primary" style="margin-right:5px;" onclick='editBridge(${JSON.stringify(b)})'>Edit</button>`;

                    tr.innerHTML = `
                        <td style="font-weight:600;">${b.name}</td>
                        <td>${members}</td>
                        <td>${b.ip || '-'}</td>
                        <td>${b.netmask || '-'}</td>
                        <td>${b.stp ? 'Enabled' : 'Disabled'}</td>
                        <td>${editBtn}${deleteBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading Bridges", e);
            }
        }

        function openBridgeModal() {
            editingBridgeName = null;
            const titleEl = document.getElementById('bridge-modal-title');
            if(titleEl) titleEl.textContent = "Add Bridge";
            
            document.getElementById('bridge-name').value = 'br' + document.querySelectorAll('#bridge-table tbody tr').length;
            document.getElementById('bridge-name').disabled = false;
            document.getElementById('bridge-ip').value = '';
            document.getElementById('bridge-netmask').value = '255.255.255.0';
            document.getElementById('bridge-stp').checked = false;
            document.querySelectorAll('#bridge-interfaces input').forEach(cb => cb.checked = false);
            document.getElementById('bridge-modal').style.display = 'flex';
        }

        function editBridge(bridge) {
            editingBridgeName = bridge.name;
            const titleEl = document.getElementById('bridge-modal-title');
            if(titleEl) titleEl.textContent = "Edit Bridge";
            
            document.getElementById('bridge-name').value = bridge.name;
            document.getElementById('bridge-name').disabled = true; // Prevent renaming for simplicity
            document.getElementById('bridge-ip').value = bridge.ip || '';
            document.getElementById('bridge-netmask').value = bridge.netmask || '255.255.255.0';
            document.getElementById('bridge-stp').checked = !!bridge.stp;
            
            // Check interfaces
            document.querySelectorAll('#bridge-interfaces input').forEach(cb => {
                cb.checked = bridge.interfaces && bridge.interfaces.includes(cb.value);
            });
            
            document.getElementById('bridge-modal').style.display = 'flex';
        }

        async function saveBridge() {
            const bridge = {
                name: document.getElementById('bridge-name').value,
                ip: document.getElementById('bridge-ip').value,
                netmask: document.getElementById('bridge-netmask').value,
                stp: document.getElementById('bridge-stp').checked,
                interfaces: []
            };

            // Get selected interfaces
            const checkboxes = document.querySelectorAll('#bridge-interfaces input[type="checkbox"]:checked');
            bridge.interfaces = Array.from(checkboxes).map(cb => cb.value);

            if (!bridge.name) {
                alert("Bridge Name is required.");
                return;
            }

            try {
                let url = '/api/admin/network/bridges';
                let method = 'POST';
                
                if (editingBridgeName) {
                    url = `/api/admin/network/bridges/${editingBridgeName}`;
                    method = 'PUT';
                    // If we disabled name input, we don't need to check for name change here unless we want to allow it.
                    // For now, let's assume name is ID.
                }

                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(bridge)
                });
                
                if (res.ok) {
                    alert(`Bridge ${editingBridgeName ? 'updated' : 'added'} successfully.`);
                    document.getElementById('bridge-modal').style.display = 'none';
                    loadBridges();
                } else {
                    const data = await res.json();
                    alert(`Failed to ${editingBridgeName ? 'update' : 'add'} Bridge: ` + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error("Save Bridge error", e);
            }
        }

        async function removeBridge(name) {
            if(!await showConfirm("Are you sure you want to delete this Bridge?", true)) return;
            
            try {
                const res = await fetch(`/api/admin/network/bridges/${name}`, { method: 'DELETE' });
                if (res.ok) {
                    loadBridges();
                } else {
                    alert("Failed to delete Bridge.");
                }
            } catch (e) {
                console.error("Delete Bridge error", e);
            }
        }

        // Helper to populate interface dropdowns
        function populateInterfaceSelect(select, interfaces, visualMap) {
            const currentVal = select.value;
            select.innerHTML = '<option value="" disabled selected>Select Interface</option>';
            
            interfaces.forEach(iface => {
                if (iface.name === 'lo') return;
                const opt = document.createElement('option');
                opt.value = iface.name;
                const visualName = visualMap[iface.name] || iface.name;
                opt.textContent = `${visualName} (${iface.mac || 'No MAC'})`;
                select.appendChild(opt);
            });
            
            // If previous value exists in new options, re-select it
            if (currentVal) select.value = currentVal;
        }

        function toggleDualWanFields(wanPrefix) {
            const type = document.getElementById(`dual-${wanPrefix}-type`).value;
            const staticFields = document.getElementById(`dual-${wanPrefix}-static-fields`);
            const pppoeFields = document.getElementById(`dual-${wanPrefix}-pppoe-fields`);
            
            if (staticFields) staticFields.style.display = 'none';
            if (pppoeFields) pppoeFields.style.display = 'none';
            
            if (type === 'static' && staticFields) {
                staticFields.style.display = 'block';
            } else if (type === 'pppoe' && pppoeFields) {
                pppoeFields.style.display = 'block';
            }
        }

        function addMultiWanRow(data = null) {
            const tbody = document.querySelector('#multi-wan-table tbody');
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>
                    <select class="login-input multi-wan-iface" style="margin:0; min-width:120px;"></select>
                </td>
                <td>
                    <select class="login-input multi-wan-type" style="margin:0; min-width:100px;" onchange="updateMultiWanDetails(this)">
                        <option value="dynamic">Dynamic</option>
                        <option value="static">Static</option>
                        <option value="pppoe">PPPoE</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="login-input multi-wan-weight" value="1" min="1" style="margin:0; width:60px;">
                </td>
                <td class="multi-wan-details">
                    <!-- Dynamic Placeholder -->
                    <div class="mw-dynamic-group" style="color:#aaa;">Auto Config</div>
                    
                    <!-- Static Fields -->
                    <div class="mw-static-group" style="display:none; grid-template-columns: 1fr 1fr; gap:5px;">
                        <input placeholder="IP" class="login-input input-sm mw-ip" style="margin:0; font-size:0.8rem;">
                        <input placeholder="Gateway" class="login-input input-sm mw-gw" style="margin:0; font-size:0.8rem;">
                    </div>
                    
                    <!-- PPPoE Fields -->
                    <div class="mw-pppoe-group" style="display:none; grid-template-columns: 1fr 1fr; gap:5px;">
                        <input placeholder="User" class="login-input input-sm mw-user" style="margin:0; font-size:0.8rem;">
                        <input placeholder="Pass" type="password" class="login-input input-sm mw-pass" style="margin:0; font-size:0.8rem;">
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Remove</button>
                </td>
            `;
            
            tbody.appendChild(tr);
            
            // Populate interfaces
            const select = tr.querySelector('.multi-wan-iface');
            if (window.cachedInterfaces && visualInterfaceMap) {
                populateInterfaceSelect(select, window.cachedInterfaces, visualInterfaceMap);
            }
            
            if (data) {
                // Populate data if provided
                if(data.interface) select.value = data.interface;
                if(data.type) tr.querySelector('.multi-wan-type').value = data.type;
                if(data.weight) tr.querySelector('.multi-wan-weight').value = data.weight;
                
                // Populate fields (ALWAYS, regardless of current type, to restore persistence)
                const detailsTd = tr.querySelector('.multi-wan-details');
                if (data.static) {
                    detailsTd.querySelector('.mw-ip').value = data.static.ip || '';
                    detailsTd.querySelector('.mw-gw').value = data.static.gateway || '';
                }
                if (data.pppoe) {
                    detailsTd.querySelector('.mw-user').value = data.pppoe.username || '';
                    detailsTd.querySelector('.mw-pass').value = data.pppoe.password || '';
                }

                // Update visibility
                updateMultiWanDetails(tr.querySelector('.multi-wan-type'));
            }
        }

        function updateMultiWanDetails(select) {
            const td = select.closest('tr').querySelector('.multi-wan-details');
            const type = select.value;
            
            const dynGroup = td.querySelector('.mw-dynamic-group');
            const staticGroup = td.querySelector('.mw-static-group');
            const pppoeGroup = td.querySelector('.mw-pppoe-group');
            
            // Reset
            dynGroup.style.display = 'none';
            staticGroup.style.display = 'none';
            pppoeGroup.style.display = 'none';
            
            if (type === 'dynamic') {
                dynGroup.style.display = 'block';
            } else if (type === 'static') {
                staticGroup.style.display = 'grid';
            } else if (type === 'pppoe') {
                pppoeGroup.style.display = 'grid';
            }
        }



        function toggleWanMode() {
            const mode = document.getElementById('wan-mode').value;
            
            document.querySelectorAll('.wan-mode-section').forEach(el => el.style.display = 'none');
            const target = document.getElementById('mode-' + mode);
            if(target) target.style.display = 'block';

            // Hide main interface selector for multi-interface modes
            const ifaceGroup = document.getElementById('wan-interface-group');
            if (mode === 'dual_wan' || mode === 'multi_wan') {
                ifaceGroup.style.display = 'none';
            } else {
                ifaceGroup.style.display = 'block';
            }
        }

        async function updateWanStatus() {
            const statusEl = document.getElementById('wan-status');
            const textEl = document.getElementById('wan-status-text');
            if (!statusEl || !textEl) return;
            
            try {
                textEl.textContent = 'Checking...';
                statusEl.classList.remove('status-online', 'status-offline');
                
                const response = await fetch('/api/admin/network/status');
                const data = await response.json();
                
                if (data.online) {
                    statusEl.classList.add('status-online');
                    textEl.textContent = 'Online';
                } else {
                    statusEl.classList.add('status-offline');
                    textEl.textContent = 'Offline';
                }
            } catch (e) {
                console.error('Failed to check WAN status:', e);
                statusEl.classList.add('status-offline');
                textEl.textContent = 'Offline';
            }
        }

        async function saveNetworkConfig() {
            const mode = document.getElementById('wan-mode').value;
            const config = {
                interface: document.getElementById('wan-interface').value,
                mode: mode,
                static: {
                    ip: document.getElementById('wan-ip').value,
                    netmask: document.getElementById('wan-netmask').value,
                    gateway: document.getElementById('wan-gateway').value,
                    dns1: document.getElementById('wan-dns1').value,
                    dns2: document.getElementById('wan-dns2').value
                },
                pppoe: {
                    username: document.getElementById('pppoe-user').value,
                    password: document.getElementById('pppoe-pass').value,
                    dns1: document.getElementById('pppoe-dns1').value,
                    dns2: document.getElementById('pppoe-dns2').value
                }
            };

            // Collect Dual WAN Data
            if (mode === 'dual_wan') {
                config.dual_wan = {
                    strategy: document.getElementById('dual-strategy').value,
                    wan1: {
                        interface: document.getElementById('dual-wan1-iface').value,
                        type: document.getElementById('dual-wan1-type').value,
                        static: {
                            ip: document.getElementById('dual-wan1-ip').value,
                            gateway: document.getElementById('dual-wan1-gateway').value,
                            netmask: document.getElementById('dual-wan1-netmask').value,
                            dns: document.getElementById('dual-wan1-dns').value
                        },
                        pppoe: {
                            username: document.getElementById('dual-wan1-user').value,
                            password: document.getElementById('dual-wan1-pass').value
                        }
                    },
                    wan2: {
                        interface: document.getElementById('dual-wan2-iface').value,
                        type: document.getElementById('dual-wan2-type').value,
                        static: {
                            ip: document.getElementById('dual-wan2-ip').value,
                            gateway: document.getElementById('dual-wan2-gateway').value,
                            netmask: document.getElementById('dual-wan2-netmask').value,
                            dns: document.getElementById('dual-wan2-dns').value
                        },
                        pppoe: {
                            username: document.getElementById('dual-wan2-user').value,
                            password: document.getElementById('dual-wan2-pass').value
                        }
                    }
                };

                if (!config.dual_wan.wan1.interface || !config.dual_wan.wan2.interface) {
                    alert("Please select interfaces for both WAN 1 and WAN 2.");
                    return;
                }
                if (config.dual_wan.wan1.interface === config.dual_wan.wan2.interface) {
                    alert("WAN 1 and WAN 2 cannot use the same interface.");
                    return;
                }
            }

            // Collect Multi WAN Data
            if (mode === 'multi_wan') {
                const rows = document.querySelectorAll('#multi-wan-table tbody tr');
                config.multi_wan = Array.from(rows).map(tr => {
                    const type = tr.querySelector('.multi-wan-type').value;
                    const item = {
                        interface: tr.querySelector('.multi-wan-iface').value,
                        type: type,
                        weight: tr.querySelector('.multi-wan-weight').value
                    };
                    
                    // ALWAYS collect nested data to preserve persistence
                    // Static Data
                    const staticIp = tr.querySelector('.mw-ip').value;
                    const staticGw = tr.querySelector('.mw-gw').value;
                    if (staticIp || staticGw) {
                        item.static = {
                            ip: staticIp,
                            gateway: staticGw
                        };
                    }

                    // PPPoE Data
                    const pppoeUser = tr.querySelector('.mw-user').value;
                    const pppoePass = tr.querySelector('.mw-pass').value;
                    if (pppoeUser || pppoePass) {
                        item.pppoe = {
                            username: pppoeUser,
                            password: pppoePass
                        };
                    }

                    return item;
                });

                if (config.multi_wan.length < 2) {
                    alert("Please add at least 2 WAN interfaces for load balancing.");
                    return;
                }
                if (config.multi_wan.some(w => !w.interface)) {
                    alert("Please select an interface for all WAN entries.");
                    return;
                }
            }

            if (mode !== 'dual_wan' && mode !== 'multi_wan' && !config.interface) {
                alert("Please select a WAN interface.");
                return;
            }

            try {
                const res = await fetch('/api/admin/network/wan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config),
                    credentials: 'include'
                });
                
                if (res.ok) {
                    alert("Network configuration saved successfully.");
                } else {
                    alert("Failed to save configuration.");
                }
            } catch (e) {
                console.error("Save error", e);
                alert("Error saving configuration.");
            }
        }

        // --- Active Codes Management ---
        let editingCodeId = null;

        let idleCountdownInterval = null;

        function updateIdleCell(cell) {
            const now = Date.now();
            const lastTraffic = parseInt(cell.dataset.lastTraffic);
            const idleTimeout = parseInt(cell.dataset.idleTimeout);
            const isPaused = cell.dataset.isPaused === 'true';

            if (isNaN(lastTraffic) || isNaN(idleTimeout)) {
                cell.textContent = '-';
                return;
            }

            if (isPaused) {
                cell.textContent = 'Paused';
                cell.style.color = 'orange';
                return;
            }

            const elapsed = now - lastTraffic;
            const remaining = idleTimeout - elapsed; // Can be negative
            
            if (remaining <= 0) {
                // Show actual idle time when timed out
                const idleSeconds = Math.floor(elapsed / 1000);
                cell.textContent = `Idle: ${idleSeconds}s`;
                cell.style.color = '#c0392b'; // Darker red
                cell.style.fontWeight = 'bold';
            } else {
                // Show countdown
                const seconds = Math.floor(remaining / 1000);
                cell.textContent = `${seconds}s`;
                cell.style.color = seconds < 30 ? '#e74c3c' : 'inherit';
                cell.style.fontWeight = seconds < 30 ? 'bold' : 'normal';
            }
        }

        function startIdleCountdownUpdater() {
            if (idleCountdownInterval) return; // Already running
            
            idleCountdownInterval = setInterval(() => {
                const cells = document.querySelectorAll('.idle-countdown-cell');
                cells.forEach(updateIdleCell);
            }, 1000);
        }

        async function loadActiveCodes() {
            try {
                const res = await fetch('/api/admin/devices');
                if (!res.ok) throw new Error(`API Error: ${res.status} ${res.statusText}`);
                
                const users = await res.json();
                
                if (!Array.isArray(users)) {
                    throw new Error("Invalid data format received");
                }

                const tbody = document.querySelector('#active-codes-table tbody');
                tbody.innerHTML = '';

                // Filter for users with session codes or active time
                const activeUsers = users.filter(u => u.session_code || u.time_remaining > 0);

                if (activeUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">No active codes found</td></tr>';
                    return;
                }

                activeUsers.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #eee';
                    
                    const timeString = formatTime(u.time_remaining);
                    const status = u.is_paused ? '<span style="color:orange">Paused</span>' : 
                                   (u.is_connected ? '<span style="color:green">Connected</span>' : '<span style="color:gray">Disconnected</span>');

                    // Calculate idle params
                    const parseDate = (d) => {
                        if (!d) return null;
                        if (typeof d === 'string' && !d.endsWith('Z')) return new Date(d + 'Z').getTime();
                        return new Date(d).getTime();
                    };
                    const lastTraffic = u.last_traffic_at ? parseDate(u.last_traffic_at) : (u.last_active_at ? parseDate(u.last_active_at) : Date.now());
                    const idleTimeoutMs = (u.effective_idle_timeout || 120) * 1000;
                    
                    const idleCellId = `idle-cell-${u.id}`;

                    // Traffic Stats
                    const dl = formatBytes(u.total_data_down || 0);
                    const ul = formatBytes(u.total_data_up || 0);
                    
                    const toMbps = (bytes) => ((bytes || 0) * 8 / 1000000).toFixed(2);
                    const dlSpeed = u.current_speed ? toMbps(u.current_speed.dl_speed) : '0.00';
                    const ulSpeed = u.current_speed ? toMbps(u.current_speed.ul_speed) : '0.00';

                    tr.innerHTML = `
                        <td style="padding:10px;">
                            ${u.last_voucher_code ? `<span style="font-weight:bold; color:#007bff;">${u.last_voucher_code}</span>` : (u.user_code || u.session_code || '-')}
                        </td>
                        <td style="padding:10px;">${u.mac_address}</td>
                        <td style="padding:10px;">${(u.ip_address || '-').replace('::ffff:', '')}</td>
                        <td style="padding:10px;">${u.interface_label || '-'}</td>
                        <td style="padding:10px;">${u.hostname || '-'}</td>
                        <td style="padding:10px;">${timeString}</td>
                        <td style="padding:10px;">
                            <div style="display:flex; gap:10px; overflow-x:auto; white-space:nowrap;">
                                <div style="flex:0 0 auto; font-size:0.85rem;"><span style="color:#2ecc71;">â†“</span> ${dl} <span style="font-weight:bold; color:#27ae60;">(${dlSpeed} Mbps)</span></div>
                                <div style="flex:0 0 auto; font-size:0.85rem;"><span style="color:#3498db;">â†‘</span> ${ul} <span style="font-weight:bold; color:#2980b9;">(${ulSpeed} Mbps)</span></div>
                            </div>
                        </td>
                        <td style="padding:10px;" class="idle-countdown-cell" 
                            id="${idleCellId}"
                            data-last-traffic="${lastTraffic}" 
                            data-idle-timeout="${idleTimeoutMs}"
                            data-is-paused="${u.is_paused ? 'true' : 'false'}">
                            -
                        </td>
                        <td style="padding:10px;">${status}</td>
                        <td style="padding:10px;">
                            <button class="btn btn-sm btn-primary" onclick="modifyCode('${u.id}', '${u.session_code || ''}', ${u.time_remaining})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCode('${u.id}')">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Initialize immediately
                    const cell = tr.querySelector(`#${idleCellId}`);
                    if (cell) updateIdleCell(cell);
                });

                startIdleCountdownUpdater();

            } catch (e) {
                console.error("Error loading active codes", e);
            }
        }

        function formatTime(seconds) {
            if (seconds <= 0) return 'Expired';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h}h ${m}m ${s}s`;
        }

        function modifyCode(id, code, time) {
            editingCodeId = id;
            document.getElementById('edit-code-input').value = code === 'null' ? '' : code;
            document.getElementById('edit-time-input').value = Math.floor(time / 60); // Convert to minutes for editing
            document.getElementById('active-code-modal').style.display = 'flex';
        }

        function closeActiveCodeModal() {
            document.getElementById('active-code-modal').style.display = 'none';
            editingCodeId = null;
        }

        async function saveActiveCode() {
            if (!editingCodeId) return;
            
            const code = document.getElementById('edit-code-input').value;
            const minutes = parseInt(document.getElementById('edit-time-input').value) || 0;
            const timeRemaining = minutes * 60;

            try {
                const res = await fetch(`/api/admin/devices/${editingCodeId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_code: code, time_remaining: timeRemaining })
                });

                if (res.ok) {
                    closeActiveCodeModal();
                    loadActiveCodes();
                    alert('Code updated successfully');
                } else {
                    alert('Failed to update code');
                }
            } catch (e) {
                console.error('Error updating code', e);
                alert('Error updating code');
            }
        }

        async function deleteCode(id) {
            if (!await showConfirm('Are you sure you want to delete this active session? The user will be disconnected.', true)) return;

            try {
                const res = await fetch(`/api/admin/devices/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    loadActiveCodes();
                } else {
                    alert('Failed to delete session');
                }
            } catch (e) {
                console.error('Error deleting session', e);
            }
        }
    </script>

    <!-- Active Code Edit Modal -->
    <div id="active-code-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:95%; max-width:400px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:#333; display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; background:#fff;">
                Edit Active Session
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Session Code</label>
                    <input type="text" id="edit-code-input" placeholder="Enter Code" style="margin:0; width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Time Remaining (Minutes)</label>
                    <input type="number" id="edit-time-input" placeholder="Minutes" style="margin:0; width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sm btn-danger" onclick="closeActiveCodeModal()">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="saveActiveCode()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firewall Rule Modal -->
    <div id="firewall-rule-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="modal-content" style="background:#fff; width:95%; max-width:400px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display:flex; flex-direction:column;">
            <div class="modal-header" style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; display:flex; justify-content:space-between; align-items:center;">
                <span>Add Firewall Rule</span>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="document.getElementById('firewall-rule-modal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body" style="padding:20px; display:flex; flex-direction:column; gap:15px;">
                <div>
                    <label class="form-label">Port to Block</label>
                    <input type="number" id="fw-port" class="form-control" placeholder="e.g. 80, 443" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                </div>
                <div>
                    <label class="form-label">Protocol</label>
                    <select id="fw-protocol" class="form-control" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        <option value="both">TCP & UDP</option>
                        <option value="tcp">TCP Only</option>
                        <option value="udp">UDP Only</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Comment (Optional)</label>
                    <input type="text" id="fw-comment" class="form-control" placeholder="e.g. Block Ads" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                </div>
            </div>
            <div class="modal-footer" style="padding:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sm btn-secondary" onclick="document.getElementById('firewall-rule-modal').style.display='none'" style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:4px;">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="addFirewallRule()" style="background:#007bff; color:white; border:none; padding:8px 16px; border-radius:4px;">Add Rule</button>
            </div>
        </div>
    </div>
    <!-- Forgot Password Modal Removed -->


    <!-- Reset Credentials Modal Removed -->

    <script>
        // --- Forgot Password Logic Removed (Moved to forgot.html) ---

    </script>
    <!-- PPPoE Server Scripts -->
    <script>
        async function loadPppoeServerConfig() {
            try {
                // Fetch interfaces first
                const ifRes = await fetch('/api/admin/network-interfaces');
                const interfaces = await ifRes.json();
                const ifSelect = document.getElementById('pppoe-server-iface');
                ifSelect.innerHTML = '<option value="br0">br0 (Default)</option>';
                interfaces.forEach(iface => {
                    if (iface.name !== 'lo' && iface.name !== 'br0') {
                        const opt = document.createElement('option');
                        opt.value = iface.name;
                        opt.textContent = `${iface.name} (${iface.ip || 'No IP'})`;
                        ifSelect.appendChild(opt);
                    }
                });

                const res = await fetch('/api/admin/pppoe/config');
                const config = await res.json();
                
                if (config.enabled !== undefined) {
                    document.getElementById('pppoe-server-enabled').checked = config.enabled;
                    document.getElementById('pppoe-server-iface').value = config.interface || 'br0';
                    document.getElementById('pppoe-server-local-ip').value = config.local_ip || '10.10.10.1';
                    document.getElementById('pppoe-server-remote-start').value = config.remote_start || '10.10.10.2';
                    document.getElementById('pppoe-server-count').value = config.remote_count || 50;
                    document.getElementById('pppoe-server-dns1').value = config.dns1 || '8.8.8.8';
                    document.getElementById('pppoe-server-dns2').value = config.dns2 || '8.8.4.4';
                }
            } catch (e) {
                console.error("Error loading PPPoE config:", e);
            }
            loadPppoeProfiles();
            loadPppoeUsers();
        }

        async function savePppoeServerConfig() {
            const config = {
                enabled: document.getElementById('pppoe-server-enabled').checked,
                interface: document.getElementById('pppoe-server-iface').value,
                local_ip: document.getElementById('pppoe-server-local-ip').value,
                remote_start: document.getElementById('pppoe-server-remote-start').value,
                remote_count: parseInt(document.getElementById('pppoe-server-count').value),
                dns1: document.getElementById('pppoe-server-dns1').value,
                dns2: document.getElementById('pppoe-server-dns2').value
            };

            try {
                const res = await fetch('/api/admin/pppoe/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const data = await res.json();
                if (data.success) {
                    alert('PPPoE Server configuration saved and server restarted (if enabled).');
                } else {
                    alert('Failed to save configuration: ' + data.error);
                }
            } catch (e) {
                alert('Error saving configuration');
            }
        }

        // --- Profile Management ---
        async function loadPppoeProfiles() {
            try {
                const res = await fetch('/api/admin/pppoe/profiles');
                const profiles = await res.json();
                const container = document.getElementById('pppoe-profiles-list');
                if (!container) return; // Guard clause in case element is missing
                container.innerHTML = '';

                if (profiles.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#666;">No profiles found</div>';
                    return;
                }

                profiles.forEach(p => {
                    const div = document.createElement('div');
                    // Style: Inline Horizontal
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'space-between';
                    div.style.padding = '10px';
                    div.style.background = '#f8f9fa';
                    div.style.borderRadius = '5px';
                    div.style.border = '1px solid #e9ecef';

                    // Convert Kbps to Mbps for display
                    const upMbps = p.rate_limit_up ? (p.rate_limit_up / 1024) : 0;
                    const downMbps = p.rate_limit_down ? (p.rate_limit_down / 1024) : 0;
                    
                    div.innerHTML = `
                        <div style="font-weight:600; min-width:150px;">${p.name}</div>
                        <div style="color:#666;">â†‘ ${upMbps} Mbps / â†“ ${downMbps} Mbps</div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-sm btn-primary" onclick='openPppoeProfileModal(${JSON.stringify(p)})'>Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePppoeProfile(${p.id})">Delete</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (e) {
                console.error("Error loading profiles:", e);
            }
        }

        function openPppoeProfileModal(profile = null) {
            const modal = document.getElementById('pppoe-profile-modal');
            const title = document.getElementById('pppoe-profile-modal-title');
            
            if (profile) {
                title.textContent = 'Edit Profile';
                document.getElementById('pppoe-profile-id').value = profile.id;
                document.getElementById('pppoe-profile-name').value = profile.name;
                // Convert Kbps to Mbps for input
                document.getElementById('pppoe-profile-rate-up').value = profile.rate_limit_up ? (profile.rate_limit_up / 1024) : '';
                document.getElementById('pppoe-profile-rate-down').value = profile.rate_limit_down ? (profile.rate_limit_down / 1024) : '';
            } else {
                title.textContent = 'Add Profile';
                document.getElementById('pppoe-profile-id').value = '';
                document.getElementById('pppoe-profile-name').value = '';
                document.getElementById('pppoe-profile-rate-up').value = '';
                document.getElementById('pppoe-profile-rate-down').value = '';
            }
            modal.style.display = 'flex';
        }

        function closePppoeProfileModal() {
            document.getElementById('pppoe-profile-modal').style.display = 'none';
        }

        async function savePppoeProfile() {
            const id = document.getElementById('pppoe-profile-id').value;
            // Get Mbps input and convert to Kbps for storage
            const upMbps = parseFloat(document.getElementById('pppoe-profile-rate-up').value) || 0;
            const downMbps = parseFloat(document.getElementById('pppoe-profile-rate-down').value) || 0;

            const profile = {
                name: document.getElementById('pppoe-profile-name').value,
                rate_limit_up: Math.floor(upMbps * 1024),
                rate_limit_down: Math.floor(downMbps * 1024)
            };

            if (!profile.name) return alert('Profile Name is required');

            try {
                const url = id ? `/api/admin/pppoe/profiles/${id}` : '/api/admin/pppoe/profiles';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(profile)
                });
                const data = await res.json();

                if (data.success) {
                    closePppoeProfileModal();
                    loadPppoeProfiles();
                    // Reload users to update profile names if needed
                    loadPppoeUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error saving profile');
            }
        }

        async function deletePppoeProfile(id) {
            if (!await showConfirm('Delete this profile? Users assigned to this profile will be set to No Profile.', true)) return;
            try {
                const res = await fetch(`/api/admin/pppoe/profiles/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadPppoeProfiles();
                    loadPppoeUsers();
                } else {
                    alert('Failed to delete profile');
                }
            } catch (e) {
                alert('Error deleting profile');
            }
        }

        // --- User Management ---
        async function loadPppoeUsers() {
            try {
                const res = await fetch('/api/admin/pppoe/users');
                const users = await res.json();
                
                const allContainer = document.getElementById('pppoe-users-all-list');
                const onlineContainer = document.getElementById('pppoe-users-online-list');
                const offlineContainer = document.getElementById('pppoe-users-offline-list');
                
                if (allContainer) allContainer.innerHTML = '';
                if (onlineContainer) onlineContainer.innerHTML = '';
                if (offlineContainer) offlineContainer.innerHTML = '';

                // Helper to create user card
                // mode: 'management' (all list) or 'status' (online/offline list)
                const createUserCard = (u, mode, isOnline) => {
                    const div = document.createElement('div');
                    // Style: Inline Horizontal
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'space-between';
                    div.style.padding = '10px';
                    
                    if (mode === 'status') {
                        div.style.background = isOnline ? '#e6fff2' : '#f8f9fa'; 
                        div.style.border = isOnline ? '1px solid #00b894' : '1px solid #e9ecef';
                    } else {
                        // Management list style
                        div.style.background = '#fff';
                        div.style.border = '1px solid #dfe6e9';
                    }
                    div.style.borderRadius = '5px';

                    const expDate = u.expiration_date ? new Date(u.expiration_date).toLocaleDateString() : 'Never';
                    const profileName = u.profile_name || 'No Profile';
                    
                    // Status Badge for Management List
                    const statusBadge = u.is_active 
                        ? '<span class="badge bg-success" style="margin-right:5px;">Enabled</span>' 
                        : '<span class="badge bg-secondary" style="margin-right:5px;">Disabled</span>';

                    let leftContent = `
                        <div style="display:flex; flex-direction:column; min-width:120px;">
                            <span style="font-weight:600; font-size:1.1em;">${u.username}</span>
                            <span style="font-size:0.85em; color:#666;">${profileName}</span>
                        </div>
                    `;

                    if (mode === 'management') {
                        leftContent = `
                            <div style="display:flex; flex-direction:column; min-width:150px;">
                                <div><span style="font-weight:600; font-size:1.1em;">${u.username}</span> ${statusBadge}</div>
                                <span style="font-size:0.85em; color:#666;">${profileName}</span>
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        ${leftContent}
                        <div style="color:#666; text-align:center;">
                            <div>${u.password}</div>
                            <div style="font-size:0.8em;">Pass</div>
                        </div>
                        <div style="color:#666; text-align:center;">
                            <div>${expDate}</div>
                            <div style="font-size:0.8em;">Expires</div>
                        </div>
                    `;

                    // Only show actions in Management list
                    if (mode === 'management') {
                         div.innerHTML += `
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-sm btn-primary" onclick='openPppoeUserModal(${JSON.stringify(u)})'>Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deletePppoeUser(${u.id})">Delete</button>
                            </div>
                        `;
                    } else {
                        // For status list, maybe just a status indicator or nothing extra
                        // User requested separation, so maybe no actions here to keep it clean?
                        // Or we can add a 'Disconnect' button later if we support it.
                    }

                    return div;
                };

                let onlineCount = 0;
                let offlineCount = 0;

                users.forEach(u => {
                    // 1. Populate All Users List (Management)
                    if (allContainer) {
                        allContainer.appendChild(createUserCard(u, 'management', false));
                    }

                    // 2. Populate Status Lists
                    // Logic: Active AND (Expiration is NULL OR Expiration > Now) -> Online
                    // Otherwise -> Offline
                    const now = new Date();
                    const isExpired = u.expiration_date && new Date(u.expiration_date) < now;
                    const isOnline = u.is_active && !isExpired;

                    if (isOnline) {
                        if (onlineContainer) onlineContainer.appendChild(createUserCard(u, 'status', true));
                        onlineCount++;
                    } else {
                        if (offlineContainer) offlineContainer.appendChild(createUserCard(u, 'status', false));
                        offlineCount++;
                    }
                });

                if (allContainer && users.length === 0) allContainer.innerHTML = '<div style="color:#999; font-style:italic;">No users found</div>';
                if (onlineContainer && onlineCount === 0) onlineContainer.innerHTML = '<div style="color:#999; font-style:italic;">No active connections</div>';
                if (offlineContainer && offlineCount === 0) offlineContainer.innerHTML = '<div style="color:#999; font-style:italic;">No offline connections</div>';

            } catch (e) {
                console.error("Error loading PPPoE users:", e);
            }
        }

        async function openPppoeUserModal(user = null) {
            const modal = document.getElementById('pppoe-user-modal');
            const title = document.getElementById('pppoe-modal-title');
            
            // Populate Profiles Dropdown
            try {
                const res = await fetch('/api/admin/pppoe/profiles');
                const profiles = await res.json();
                const pSelect = document.getElementById('pppoe-modal-profile');
                pSelect.innerHTML = '<option value="">No Profile (Unlimited)</option>';
                profiles.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    const upMbps = p.rate_limit_up ? (p.rate_limit_up / 1024) : 0;
                    const downMbps = p.rate_limit_down ? (p.rate_limit_down / 1024) : 0;
                    opt.textContent = `${p.name} (â†‘${upMbps}M/â†“${downMbps}M)`;
                    pSelect.appendChild(opt);
                });
            } catch (e) {
                console.error("Error loading profiles for modal", e);
            }

            if (user) {
                title.textContent = 'Edit PPPoE User';
                document.getElementById('pppoe-user-id').value = user.id;
                document.getElementById('pppoe-modal-user').value = user.username;
                document.getElementById('pppoe-modal-pass').value = user.password;
                document.getElementById('pppoe-modal-profile').value = user.profile_id || '';
                document.getElementById('pppoe-modal-expiry').value = user.expiration_date ? new Date(user.expiration_date).toISOString().split('T')[0] : '';
                document.getElementById('pppoe-modal-active').value = user.is_active;
            } else {
                title.textContent = 'Add PPPoE User';
                document.getElementById('pppoe-user-id').value = '';
                document.getElementById('pppoe-modal-user').value = '';
                document.getElementById('pppoe-modal-pass').value = '';
                document.getElementById('pppoe-modal-profile').value = '';
                document.getElementById('pppoe-modal-expiry').value = '';
                document.getElementById('pppoe-modal-active').value = '1';
            }
            modal.style.display = 'flex';
        }

        function closePppoeUserModal() {
            document.getElementById('pppoe-user-modal').style.display = 'none';
        }

        async function savePppoeUser() {
            const id = document.getElementById('pppoe-user-id').value;
            const user = {
                username: document.getElementById('pppoe-modal-user').value,
                password: document.getElementById('pppoe-modal-pass').value,
                profile_id: document.getElementById('pppoe-modal-profile').value || null,
                expiration_date: document.getElementById('pppoe-modal-expiry').value || null,
                is_active: parseInt(document.getElementById('pppoe-modal-active').value)
            };

            if (!user.username || !user.password) {
                alert('Username and Password are required');
                return;
            }

            try {
                const url = id ? `/api/admin/pppoe/users/${id}` : '/api/admin/pppoe/users';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(user)
                });
                const data = await res.json();

                if (data.success) {
                    closePppoeUserModal();
                    loadPppoeUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error saving user');
            }
        }

        async function deletePppoeUser(id) {
            if (!await showConfirm('Are you sure you want to delete this user?', true)) return;
            try {
                const res = await fetch(`/api/admin/pppoe/users/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadPppoeUsers();
                } else {
                    alert('Failed to delete user');
                }
            } catch (e) {
                alert('Error deleting user');
            }
        }
    </script>
    <!-- Walled Garden Modal -->
    <div id="walled-garden-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:400px; max-width:90%;">
            <h3 style="margin-top:0;">Add Walled Garden Entry</h3>
            
            <div class="form-group">
                <label style="font-weight:600; display:block; margin-bottom:5px;">Domain</label>
                <input type="text" id="wg-modal-domain" class="login-input" placeholder="example.com" style="width:100%;">
                <small style="color:#666; display:block; margin-top:5px;">Address will be automatically resolved.</small>
            </div>
            
            <div class="form-group" style="margin-top:15px;">
                <label style="font-weight:600; display:block; margin-bottom:5px;">Type</label>
                <select id="wg-modal-type" class="login-input" style="width:100%;">
                    <option value="allow">Allow</option>
                    <option value="deny">Deny</option>
                </select>
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-sm btn-danger" onclick="closeWalledGardenModal()" style="margin-right:5px;">Close</button>
                <button class="btn btn-sm btn-primary" onclick="addWalledGarden()">Save</button>
            </div>
        </div>
    </div>



    <script src="/js/admin-toast.js"></script>
</body>
</html>
